<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智能体管理平台</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #1890ff;
      --primary-dark: #096dd9;
      --primary-light: #40a9ff;
      --secondary: #722ed1;
      --success: #52c41a;
      --warning: #faad14;
      --danger: #ff4d4f;
      --sidebar-bg: #001529;
      --sidebar-hover: #000c17;
      --sidebar-active: #1890ff;
      --content-bg: #f0f2f5;
      --card-bg: #ffffff;
      --text-primary: #262626;
      --text-secondary: #8c8c8c;
      --border-color: #f0f0f0;
    }

    body {
      font-family: 'Noto Sans SC', sans-serif;
      min-height: 100vh;
      display: flex;
      background: var(--content-bg);
    }

    /* 侧边栏 */
    .sidebar {
      width: 256px;
      background: var(--sidebar-bg);
      min-height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      z-index: 100;
    }

    .sidebar-header {
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .logo-text {
      color: white;
      font-size: 1rem;
      font-weight: 600;
    }

    .logo-text span {
      color: var(--primary-light);
      font-size: 0.75rem;
      display: block;
      font-weight: 400;
      margin-top: 2px;
    }

    /* 用户信息 */
    .user-info {
      padding: 16px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .user-details { flex: 1; }

    .user-name {
      color: white;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .role-badge {
      display: inline-block;
      padding: 2px 8px;
      background: rgba(82, 196, 26, 0.2);
      border-radius: 10px;
      color: #95de64;
      font-size: 0.7rem;
      margin-top: 4px;
    }

    /* 菜单导航 */
    .nav-menu {
      flex: 1;
      padding: 8px 0;
      overflow-y: auto;
    }

    .menu-item { position: relative; }

    .menu-link {
      display: flex;
      align-items: center;
      padding: 12px 24px;
      color: rgba(255, 255, 255, 0.65);
      text-decoration: none;
      transition: all 0.3s ease;
      cursor: pointer;
      gap: 10px;
      font-size: 0.9rem;
    }

    .menu-link:hover { color: white; }
    .menu-link.active { background: var(--sidebar-active); color: white; }
    .menu-link.parent { font-weight: 500; }
    .menu-icon { width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
    .menu-text { flex: 1; }
    .menu-arrow { transition: transform 0.3s ease; font-size: 0.7rem; opacity: 0.5; }
    .menu-item.open .menu-arrow { transform: rotate(90deg); }

    .menu-tag {
      padding: 1px 6px;
      border-radius: 4px;
      font-size: 0.65rem;
      margin-left: 8px;
    }
    .menu-tag.blue { background: rgba(24, 144, 255, 0.2); color: #69c0ff; }
    .menu-tag.green { background: rgba(82, 196, 26, 0.2); color: #95de64; }
    .menu-tag.orange { background: rgba(250, 173, 20, 0.2); color: #ffc53d; }
    .menu-tag.purple { background: rgba(114, 46, 209, 0.2); color: #b37feb; }

    .submenu {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: rgba(0, 0, 0, 0.2);
    }
    .menu-item.open .submenu { max-height: 500px; }

    .submenu-link {
      display: flex;
      align-items: center;
      padding: 10px 24px 10px 50px;
      color: rgba(255, 255, 255, 0.65);
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .submenu-link:hover { color: white; background: rgba(255, 255, 255, 0.05); }
    .submenu-link.active { color: var(--primary-light); background: rgba(24, 144, 255, 0.1); }
    .submenu-link::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
      margin-right: 10px;
      opacity: 0.5;
    }
    .submenu-link:hover::before, .submenu-link.active::before { opacity: 1; }
    .submenu-text { flex: 1; }

    .sidebar-footer {
      padding: 16px 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logout-btn {
      width: 100%;
      padding: 10px;
      background: rgba(255, 77, 79, 0.1);
      border: 1px solid rgba(255, 77, 79, 0.3);
      border-radius: 6px;
      color: #ff7875;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: inherit;
    }
    .logout-btn:hover { background: rgba(255, 77, 79, 0.2); }

    /* 主内容区 */
    .main-content {
      flex: 1;
      margin-left: 256px;
      min-height: 100vh;
    }

    .top-header {
      background: var(--card-bg);
      padding: 0 24px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-size: 0.85rem;
    }
    .breadcrumb-item { color: var(--text-primary); }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-btn {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      border: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: background 0.2s ease;
    }
    .header-btn:hover { background: var(--content-bg); }

    .content-area { padding: 24px; }

    /* 页面标题 */
    .page-header {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid var(--border-color);
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .page-title-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .page-desc {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-left: 60px;
    }

    /* 功能卡片 */
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .feature-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .feature-card:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(24, 144, 255, 0.15);
      transform: translateY(-4px);
    }

    .feature-card-icon {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      margin-bottom: 16px;
    }

    .feature-card-icon.blue { background: linear-gradient(135deg, #e6f7ff, #bae7ff); }
    .feature-card-icon.green { background: linear-gradient(135deg, #f6ffed, #d9f7be); }
    .feature-card-icon.purple { background: linear-gradient(135deg, #f9f0ff, #efdbff); }
    .feature-card-icon.orange { background: linear-gradient(135deg, #fff7e6, #ffe7ba); }
    .feature-card-icon.red { background: linear-gradient(135deg, #fff2f0, #ffccc7); }
    .feature-card-icon.cyan { background: linear-gradient(135deg, #e6fffb, #b5f5ec); }

    .feature-card-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .feature-card-desc {
      color: var(--text-secondary);
      font-size: 0.85rem;
      line-height: 1.5;
    }

    .feature-card-action {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .feature-card-btn {
      padding: 8px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s ease;
      font-family: inherit;
    }

    .feature-card-btn:hover {
      background: var(--primary-dark);
    }

    .feature-card-stat {
      color: var(--text-secondary);
      font-size: 0.8rem;
    }

    /* 空状态 */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-title {
      font-size: 1.2rem;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .empty-state-desc {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 24px;
    }

    .empty-state-btn {
      padding: 12px 32px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      cursor: pointer;
      font-family: inherit;
    }

    /* AI模型选择样式 */
    .model-section {
      margin-bottom: 32px;
    }

    .model-section-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .model-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }

    .model-card {
      background: var(--card-bg);
      border-radius: 16px;
      border: 2px solid var(--border-color);
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .model-card:hover {
      border-color: var(--primary);
      box-shadow: 0 8px 24px rgba(24, 144, 255, 0.15);
      transform: translateY(-4px);
    }

    .model-card.selected {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.2);
    }

    .model-card-header {
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .model-logo {
      width: 56px;
      height: 56px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      flex-shrink: 0;
    }

    .model-info {
      flex: 1;
      min-width: 0;
    }

    .model-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .model-badge {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 500;
    }

    .model-badge.popular {
      background: linear-gradient(135deg, #ff6b6b, #ffa500);
      color: white;
    }

    .model-badge.free {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    .model-badge.new {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    .model-desc {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 4px;
      line-height: 1.4;
    }

    .model-card-body {
      padding: 16px 20px;
    }

    .model-list-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .model-versions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .model-version-tag {
      padding: 4px 12px;
      background: var(--content-bg);
      border-radius: 6px;
      font-size: 0.8rem;
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      transition: all 0.2s ease;
    }

    .model-version-tag:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .model-features {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .model-feature-tag {
      padding: 3px 10px;
      background: rgba(24, 144, 255, 0.08);
      border-radius: 4px;
      font-size: 0.75rem;
      color: var(--primary);
    }

    .model-card-footer {
      padding: 16px 20px;
      background: var(--content-bg);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .model-select-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .model-select-btn.primary {
      background: var(--primary);
      color: white;
    }

    .model-select-btn.primary:hover {
      background: var(--primary-dark);
    }

    .model-price {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .model-price span {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--warning);
    }

    /* 模型筛选 */
    .model-filter {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 20px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      border-radius: 20px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .filter-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .filter-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    /* 搜索框 */
    .model-search {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }

    .search-input-wrapper {
      flex: 1;
      max-width: 400px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px 12px 44px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      font-size: 0.9rem;
      background: var(--card-bg);
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.1);
    }

    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      opacity: 0.5;
    }

    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .main-content { margin-left: 0; }
      .model-grid { grid-template-columns: 1fr; }
    }

    /* ========== 全局搜索弹窗样式 ========== */
    .search-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
      align-items: flex-start;
      justify-content: center;
      padding-top: 100px;
      backdrop-filter: blur(4px);
    }

    .search-modal-overlay.show {
      display: flex;
      animation: fadeIn 0.2s ease;
    }

    .search-modal {
      width: 100%;
      max-width: 640px;
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
      overflow: hidden;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .search-modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .search-modal-input-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--content-bg);
      border-radius: 12px;
      padding: 4px 16px;
    }

    .search-modal-icon {
      font-size: 1.2rem;
      opacity: 0.5;
    }

    .search-modal-input {
      flex: 1;
      padding: 12px 0;
      border: none;
      background: transparent;
      font-size: 1rem;
      font-family: inherit;
      color: var(--text-primary);
    }

    .search-modal-input:focus {
      outline: none;
    }

    .search-modal-input::placeholder {
      color: var(--text-secondary);
    }

    .search-shortcut {
      padding: 4px 8px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .search-modal-body {
      max-height: 400px;
      overflow-y: auto;
    }

    .search-section {
      padding: 12px 20px;
    }

    .search-section-title {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .search-result-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .search-result-item:hover {
      background: var(--content-bg);
    }

    .search-result-item.active {
      background: rgba(24, 144, 255, 0.1);
    }

    .search-result-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      background: var(--content-bg);
    }

    .search-result-info {
      flex: 1;
    }

    .search-result-title {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .search-result-desc {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .search-result-tag {
      padding: 4px 10px;
      background: rgba(24, 144, 255, 0.1);
      color: var(--primary);
      border-radius: 6px;
      font-size: 0.75rem;
    }

    .search-modal-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--content-bg);
    }

    .search-tips {
      display: flex;
      gap: 16px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .search-tip {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .search-tip kbd {
      padding: 2px 6px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.7rem;
    }

    .search-no-result {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .search-no-result-icon {
      font-size: 3rem;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    /* ========== 设置弹窗样式 ========== */
    .settings-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .settings-modal-overlay.show {
      display: flex;
      animation: fadeIn 0.2s ease;
    }

    .settings-modal {
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: scaleIn 0.3s ease;
    }

    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .settings-modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .settings-modal-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .settings-close-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: var(--content-bg);
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
    }

    .settings-close-btn:hover {
      background: var(--border-color);
    }

    .settings-modal-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .settings-sidebar {
      width: 200px;
      background: var(--content-bg);
      padding: 16px 0;
      border-right: 1px solid var(--border-color);
    }

    .settings-nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .settings-nav-item:hover {
      color: var(--text-primary);
      background: rgba(0, 0, 0, 0.05);
    }

    .settings-nav-item.active {
      color: var(--primary);
      background: rgba(24, 144, 255, 0.1);
      border-right: 2px solid var(--primary);
    }

    .settings-content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    .settings-section {
      margin-bottom: 32px;
    }

    .settings-section:last-child {
      margin-bottom: 0;
    }

    .settings-section-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .settings-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .settings-item:last-child {
      border-bottom: none;
    }

    .settings-item-info {
      flex: 1;
    }

    .settings-item-label {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .settings-item-desc {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .settings-item-action {
      margin-left: 24px;
    }

    /* 开关按钮 */
    .toggle-switch {
      width: 44px;
      height: 24px;
      background: var(--border-color);
      border-radius: 12px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .toggle-switch.active {
      background: var(--primary);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch.active::after {
      transform: translateX(20px);
    }

    /* 设置输入框 */
    .settings-input {
      padding: 10px 14px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.9rem;
      font-family: inherit;
      min-width: 200px;
      transition: border-color 0.2s ease;
    }

    .settings-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* 设置选择器 */
    .settings-select {
      padding: 10px 14px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.9rem;
      font-family: inherit;
      min-width: 160px;
      background: white;
      cursor: pointer;
    }

    .settings-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* 设置按钮 */
    .settings-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .settings-btn.primary {
      background: var(--primary);
      color: white;
      border: none;
    }

    .settings-btn.primary:hover {
      background: var(--primary-dark);
    }

    .settings-btn.secondary {
      background: white;
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .settings-btn.secondary:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .settings-btn.danger {
      background: white;
      color: var(--danger);
      border: 1px solid var(--danger);
    }

    .settings-btn.danger:hover {
      background: var(--danger);
      color: white;
    }

    /* 头像设置 */
    .avatar-settings {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .avatar-preview {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 2rem;
      font-weight: 600;
    }

    .avatar-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* 消息通知弹窗 */
    .notification-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
      align-items: flex-start;
      justify-content: flex-end;
      padding: 60px 20px 20px;
      backdrop-filter: blur(4px);
    }

    .notification-modal-overlay.show {
      display: flex;
      animation: fadeIn 0.2s ease;
    }

    .notification-modal {
      width: 380px;
      max-height: 500px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      animation: slideLeft 0.3s ease;
    }

    @keyframes slideLeft {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .notification-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .notification-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .notification-clear {
      font-size: 0.8rem;
      color: var(--primary);
      cursor: pointer;
    }

    .notification-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .notification-item {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .notification-item:hover {
      background: var(--content-bg);
    }

    .notification-item.unread {
      background: rgba(24, 144, 255, 0.05);
    }

    .notification-item-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .notification-icon {
      font-size: 1.2rem;
    }

    .notification-type {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .notification-time {
      margin-left: auto;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .notification-content {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .notification-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    /* ========== 智能体市场卡片样式 ========== */
    .agent-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 24px;
    }

    .agent-card {
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--border-color);
      overflow: hidden;
      transition: all 0.3s ease;
      position: relative;
    }

    .agent-card:hover {
      border-color: var(--primary);
      box-shadow: 0 8px 24px rgba(24, 144, 255, 0.12);
      transform: translateY(-4px);
    }

    .agent-card-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 6px;
    }

    .agent-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .agent-badge.official {
      background: linear-gradient(135deg, #1890ff, #722ed1);
      color: white;
    }

    .agent-badge.hot {
      background: linear-gradient(135deg, #ff6b6b, #ffa500);
      color: white;
    }

    .agent-badge.new {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    .agent-badge.free {
      background: linear-gradient(135deg, #52c41a, #73d13d);
      color: white;
    }

    .agent-card-header {
      padding: 24px 20px 16px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .agent-logo {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .agent-info { flex: 1; min-width: 0; }

    .agent-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .agent-platform {
      font-size: 0.8rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .agent-platform::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .agent-card-body { padding: 0 20px 16px; }

    .agent-desc {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .agent-features {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .agent-feature-tag {
      padding: 4px 12px;
      background: var(--content-bg);
      border-radius: 6px;
      font-size: 0.8rem;
      color: var(--text-primary);
    }

    .agent-stats {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 0;
      border-top: 1px solid var(--border-color);
    }

    .agent-stat {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .agent-stat-icon { font-size: 1rem; }
    .agent-stat-value { color: var(--text-primary); font-weight: 500; }

    .agent-card-footer {
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(24, 144, 255, 0.03), rgba(114, 46, 209, 0.03));
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-top: 1px solid var(--border-color);
    }

    .agent-price {
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .agent-price-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--warning);
    }

    .agent-price-unit {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .agent-price-free {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--success);
    }

    .agent-actions { display: flex; gap: 10px; }

    .agent-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      border: none;
    }

    .agent-btn.primary {
      background: var(--primary);
      color: white;
    }

    .agent-btn.primary:hover {
      background: var(--primary-dark);
    }

    .agent-btn.secondary {
      background: white;
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .agent-btn.secondary:hover {
      background: rgba(24, 144, 255, 0.1);
    }

    .agent-btn.owned {
      background: var(--success);
      color: white;
      cursor: default;
    }

    /* 我的智能体卡片样式 */
    .my-agent-card {
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--border-color);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .my-agent-card:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    .my-agent-header {
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .my-agent-logo {
      width: 56px;
      height: 56px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
    }

    .my-agent-info { flex: 1; }

    .my-agent-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .my-agent-meta {
      font-size: 0.8rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .my-agent-status {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-dot.active { background: var(--success); }
    .status-dot.inactive { background: var(--text-secondary); }

    .my-agent-body {
      padding: 16px 20px;
    }

    .my-agent-desc {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .my-agent-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .my-agent-footer {
      padding: 16px 20px;
      background: var(--content-bg);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .my-agent-date {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .my-agent-actions {
      display: flex;
      gap: 8px;
    }

    .my-agent-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      border: none;
    }

    .my-agent-btn.use {
      background: var(--primary);
      color: white;
    }

    .my-agent-btn.use:hover {
      background: var(--primary-dark);
    }

    .my-agent-btn.edit {
      background: white;
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .my-agent-btn.edit:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .my-agent-btn.delete {
      background: white;
      color: var(--danger);
      border: 1px solid var(--danger);
    }

    .my-agent-btn.delete:hover {
      background: var(--danger);
      color: white;
    }

    /* 创建智能体弹窗 */
    .create-agent-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .create-agent-modal-overlay.show {
      display: flex;
      animation: fadeIn 0.2s ease;
    }

    .create-agent-modal {
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      background: var(--card-bg);
      border-radius: 16px;
      overflow: hidden;
      animation: scaleIn 0.3s ease;
    }

    .create-agent-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .create-agent-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .create-agent-body {
      padding: 24px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.9rem;
      font-family: inherit;
      transition: border-color 0.2s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-select-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .form-select-item {
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .form-select-item:hover {
      border-color: var(--primary);
    }

    .form-select-item.selected {
      border-color: var(--primary);
      background: rgba(24, 144, 255, 0.05);
    }

    .form-select-item-icon {
      font-size: 1.5rem;
      margin-bottom: 6px;
    }

    .form-select-item-name {
      font-size: 0.85rem;
      color: var(--text-primary);
      font-weight: 500;
    }

    .create-agent-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      background: var(--content-bg);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* ========== 智能体对话界面样式 ========== */
    .chat-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1001;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(6px);
    }

    .chat-modal-overlay.show {
      display: flex;
      animation: fadeIn 0.2s ease;
    }

    .chat-modal {
      width: 100%;
      max-width: 800px;
      height: 85vh;
      background: var(--card-bg);
      border-radius: 20px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: scaleIn 0.3s ease;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
    }

    .chat-header {
      padding: 16px 24px;
      background: linear-gradient(135deg, var(--sidebar-bg), #002140);
      display: flex;
      align-items: center;
      gap: 16px;
      color: white;
    }

    .chat-agent-avatar {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      background: rgba(255, 255, 255, 0.1);
    }

    .chat-agent-info { flex: 1; }

    .chat-agent-name {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .chat-agent-status {
      font-size: 0.8rem;
      opacity: 0.8;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chat-agent-status::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #52c41a;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .chat-close-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.2rem;
      color: white;
      transition: background 0.2s ease;
    }

    .chat-close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .chat-messages {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      background: linear-gradient(180deg, #f8fafc 0%, #f0f2f5 100%);
    }

    .chat-message {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      animation: messageIn 0.3s ease;
    }

    @keyframes messageIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .chat-message.user {
      flex-direction: row-reverse;
    }

    .chat-message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    .chat-message.assistant .chat-message-avatar {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
    }

    .chat-message.user .chat-message-avatar {
      background: linear-gradient(135deg, #52c41a, #73d13d);
      color: white;
    }

    .chat-message-content {
      max-width: 70%;
      padding: 14px 18px;
      border-radius: 16px;
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .chat-message.assistant .chat-message-content {
      background: white;
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-bottom-left-radius: 4px;
    }

    .chat-message.user .chat-message-content {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border-bottom-right-radius: 4px;
    }

    .chat-message-time {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 6px;
      text-align: right;
    }

    .chat-message.user .chat-message-time {
      text-align: left;
    }

    .chat-typing {
      display: flex;
      gap: 4px;
      padding: 8px 0;
    }

    .chat-typing span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-secondary);
      animation: typing 1.4s infinite;
    }

    .chat-typing span:nth-child(2) { animation-delay: 0.2s; }
    .chat-typing span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
      30% { transform: translateY(-6px); opacity: 1; }
    }

    .chat-input-area {
      padding: 16px 24px;
      background: white;
      border-top: 1px solid var(--border-color);
    }

    .chat-input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .chat-input-box {
      flex: 1;
      background: var(--content-bg);
      border-radius: 16px;
      padding: 4px;
    }

    .chat-input {
      width: 100%;
      padding: 12px 16px;
      border: none;
      background: transparent;
      font-size: 0.95rem;
      font-family: inherit;
      resize: none;
      min-height: 24px;
      max-height: 120px;
      line-height: 1.5;
    }

    .chat-input:focus {
      outline: none;
    }

    .chat-input::placeholder {
      color: var(--text-secondary);
    }

    .chat-send-btn {
      width: 48px;
      height: 48px;
      border: none;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: 14px;
      cursor: pointer;
      font-size: 1.2rem;
      color: white;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-send-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(24, 144, 255, 0.4);
    }

    .chat-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .chat-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .chat-suggestion {
      padding: 8px 16px;
      background: var(--content-bg);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .chat-suggestion:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: rgba(24, 144, 255, 0.05);
    }

    /* 创建智能体增强表单样式 */
    .form-section {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border-color);
    }

    .form-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .form-section-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-row {
      display: flex;
      gap: 16px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .form-hint {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 6px;
    }

    .form-range {
      width: 100%;
      margin-top: 8px;
    }

    .form-range-value {
      font-size: 0.85rem;
      color: var(--primary);
      font-weight: 500;
    }

    .icon-picker {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .icon-option {
      width: 44px;
      height: 44px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .icon-option:hover {
      border-color: var(--primary);
      transform: scale(1.1);
    }

    .icon-option.selected {
      border-color: var(--primary);
      background: rgba(24, 144, 255, 0.1);
    }

    .welcome-message {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .welcome-icon {
      font-size: 4rem;
      margin-bottom: 16px;
    }

    .welcome-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .welcome-desc {
      font-size: 0.9rem;
      margin-bottom: 24px;
    }

    /* ========== 数字人模块样式 ========== */
    .dh-create-container {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 32px;
      border: 1px solid var(--border-color);
    }

    .dh-steps {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 40px;
      padding-bottom: 32px;
      border-bottom: 1px solid var(--border-color);
    }

    .dh-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      opacity: 0.4;
      transition: all 0.3s ease;
    }

    .dh-step.active {
      opacity: 1;
    }

    .dh-step.completed {
      opacity: 0.7;
    }

    .dh-step-num {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--border-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--text-secondary);
      transition: all 0.3s ease;
    }

    .dh-step.active .dh-step-num {
      background: var(--primary);
      color: white;
    }

    .dh-step.completed .dh-step-num {
      background: var(--success);
      color: white;
    }

    .dh-step-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .dh-step.active .dh-step-text {
      color: var(--text-primary);
    }

    .dh-step-line {
      width: 80px;
      height: 2px;
      background: var(--border-color);
      margin: 0 16px;
    }

    .dh-step-content {
      display: none;
    }

    .dh-step-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .dh-section-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .dh-section-desc {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 24px;
    }

    .dh-upload-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }

    .dh-upload-card {
      background: var(--content-bg);
      border: 2px dashed var(--border-color);
      border-radius: 16px;
      padding: 32px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .dh-upload-card:hover, .dh-upload-card.dragover {
      border-color: var(--primary);
      background: rgba(24, 144, 255, 0.05);
    }

    .dh-upload-card.record {
      border-style: solid;
      background: linear-gradient(135deg, rgba(114, 46, 209, 0.05), rgba(24, 144, 255, 0.05));
    }

    .dh-upload-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }

    .dh-upload-title {
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .dh-upload-desc {
      font-size: 0.8rem;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .dh-upload-hint {
      font-size: 0.75rem;
      color: var(--primary);
    }

    .dh-upload-preview {
      display: none;
      margin-top: 12px;
    }

    .dh-file-uploaded {
      background: rgba(82, 196, 26, 0.1);
      color: var(--success);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
    }

    /* 样本素材样式 */
    .dh-sample-section {
      margin-top: 32px;
    }

    .dh-sample-divider {
      display: flex;
      align-items: center;
      margin-bottom: 24px;
    }

    .dh-sample-divider::before,
    .dh-sample-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-color);
    }

    .dh-sample-divider span {
      padding: 0 20px;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .dh-sample-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .dh-sample-tab {
      padding: 8px 16px;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      background: var(--card-bg);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.85rem;
      font-family: inherit;
      color: var(--text-primary);
    }

    .dh-sample-tab:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .dh-sample-tab.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .dh-sample-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
    }

    .dh-sample-card {
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .dh-sample-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .dh-sample-card.selected {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.2);
    }

    .dh-sample-preview {
      position: relative;
      aspect-ratio: 1;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .dh-sample-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .dh-sample-preview-icon {
      font-size: 3rem;
    }

    .dh-sample-type-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
    }

    .dh-sample-duration {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.75rem;
    }

    .dh-sample-check {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      background: var(--primary);
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.8rem;
    }

    .dh-sample-card.selected .dh-sample-check {
      display: flex;
    }

    .dh-sample-info {
      padding: 12px;
    }

    .dh-sample-name {
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dh-sample-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .dh-sample-gender {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .dh-sample-tag {
      padding: 2px 8px;
      background: rgba(24, 144, 255, 0.1);
      color: var(--primary);
      border-radius: 10px;
      font-size: 0.7rem;
    }

    .dh-sample-tag.hot {
      background: rgba(255, 77, 79, 0.1);
      color: var(--danger);
    }

    .dh-sample-tag.new {
      background: rgba(82, 196, 26, 0.1);
      color: var(--success);
    }

    .dh-btn-group {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 32px;
    }

    .dh-btn {
      padding: 12px 32px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      font-family: inherit;
    }

    .dh-btn.primary {
      background: var(--primary);
      color: white;
    }

    .dh-btn.primary:hover:not(:disabled) {
      background: var(--primary-dark);
    }

    .dh-btn.primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .dh-btn.secondary {
      background: var(--content-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .dh-btn.secondary:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .dh-btn.generate {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      padding: 14px 40px;
      font-size: 1.1rem;
    }

    .dh-btn.generate:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(24, 144, 255, 0.3);
    }

    .dh-agent-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .dh-agent-card {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      background: var(--content-bg);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .dh-agent-card:hover {
      border-color: var(--primary);
    }

    .dh-agent-card.selected {
      border-color: var(--primary);
      background: rgba(24, 144, 255, 0.05);
    }

    .dh-agent-logo {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-right: 16px;
    }

    .dh-agent-info {
      flex: 1;
    }

    .dh-agent-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .dh-agent-platform {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .dh-agent-check {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
    }

    .dh-agent-card.selected .dh-agent-check {
      display: flex;
    }

    .dh-empty-agent {
      text-align: center;
      padding: 60px 20px;
      background: var(--content-bg);
      border-radius: 16px;
    }

    .dh-empty-icon {
      font-size: 4rem;
      margin-bottom: 16px;
    }

    .dh-empty-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .dh-empty-desc {
      color: var(--text-secondary);
      margin-bottom: 24px;
    }

    .dh-config-form {
      max-width: 600px;
      margin: 0 auto;
    }

    .dh-form-group {
      margin-bottom: 20px;
    }

    .dh-form-label {
      display: block;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .dh-form-input, .dh-form-textarea, .dh-form-select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: inherit;
      transition: border-color 0.2s ease;
      background: var(--card-bg);
      color: var(--text-primary);
    }

    .dh-form-input:focus, .dh-form-textarea:focus, .dh-form-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .dh-form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .dh-style-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .dh-style-item {
      padding: 16px 12px;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .dh-style-item:hover {
      border-color: var(--primary);
    }

    .dh-style-item.selected {
      border-color: var(--primary);
      background: rgba(24, 144, 255, 0.05);
    }

    .dh-style-item span {
      display: block;
      font-size: 1.5rem;
      margin-bottom: 8px;
    }

    /* 数字人列表样式 */
    .dh-list-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .dh-list-card {
      display: flex;
      align-items: center;
      padding: 20px 24px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      transition: all 0.2s ease;
    }

    .dh-list-card:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .dh-list-avatar {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      margin-right: 20px;
    }

    .dh-list-info {
      flex: 1;
    }

    .dh-list-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .dh-list-desc {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 8px;
    }

    .dh-list-meta {
      display: flex;
      gap: 16px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .dh-list-agent {
      color: var(--primary);
    }

    .dh-list-status {
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      margin-right: 20px;
    }

    .dh-list-status.ready {
      background: rgba(82, 196, 26, 0.1);
      color: var(--success);
    }

    .dh-list-status.processing {
      background: rgba(250, 173, 20, 0.1);
      color: var(--warning);
    }

    .dh-list-status.failed {
      background: rgba(255, 77, 79, 0.1);
      color: var(--danger);
    }

    .dh-list-card.failed {
      border-color: rgba(255, 77, 79, 0.3);
      background: rgba(255, 77, 79, 0.02);
    }

    .dh-list-error {
      color: var(--danger);
      font-size: 0.8rem;
      margin: 4px 0;
    }

    /* AI生成的数字人卡片 */
    .dh-list-card.ai-generated {
      border-left: 3px solid var(--primary);
    }
    
    .dh-persona-info {
      background: rgba(24, 144, 255, 0.1);
      border-radius: 8px;
      padding: 10px 12px;
      margin: 8px 0;
      font-size: 0.85rem;
    }
    
    .dh-persona-badge {
      display: inline-block;
      background: linear-gradient(135deg, #1890ff, #722ed1);
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
      margin-bottom: 6px;
    }
    
    .dh-persona-item {
      color: var(--text-secondary);
      margin: 4px 0;
      line-height: 1.4;
    }
    
    .dh-persona-item strong {
      color: var(--text-primary);
    }
    
    /* 人设详情弹窗 */
    .persona-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s ease;
    }
    
    .persona-modal {
      background: var(--card-bg);
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .persona-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }
    
    .persona-modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .persona-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    
    .persona-modal-close:hover {
      color: var(--text-primary);
    }
    
    .persona-modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }
    
    .persona-section {
      margin-bottom: 16px;
    }
    
    .persona-label {
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-bottom: 4px;
    }
    
    .persona-value {
      color: var(--text-primary);
      font-size: 1rem;
      line-height: 1.5;
    }
    
    .persona-value.highlight {
      background: rgba(24, 144, 255, 0.1);
      padding: 10px 14px;
      border-radius: 8px;
      border-left: 3px solid var(--primary);
    }
    
    .persona-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px;
      border-top: 1px solid var(--border);
    }

    /* 视频播放器样式 */
    .video-player-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s ease;
    }
    
    .video-player-container {
      background: var(--card-bg);
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s ease;
    }
    
    .video-player-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .video-player-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .video-player-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--text-secondary);
      cursor: pointer;
      line-height: 1;
    }
    
    .video-player-close:hover {
      color: var(--text-primary);
    }
    
    .video-player-content {
      padding: 0;
      background: #000;
    }
    
    .video-player-screen {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
      overflow: hidden;
    }
    
    .video-demo-wrapper {
      display: flex;
      height: 100%;
      padding: 30px;
    }
    
    .video-demo-avatar {
      flex: 0 0 200px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .avatar-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #722ed1, #1890ff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      box-shadow: 0 10px 40px rgba(114, 46, 209, 0.4);
      position: relative;
    }
    
    /* 说话时的动画 */
    .video-play-overlay.playing ~ .video-demo-wrapper .avatar-circle {
      animation: speakingPulse 0.3s ease-in-out infinite;
    }
    
    .video-play-overlay.playing ~ .video-demo-wrapper .avatar-circle::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 3px solid rgba(24, 144, 255, 0.6);
      animation: speakingRing 1s ease-out infinite;
    }
    
    @keyframes speakingPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    @keyframes speakingRing {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.5); opacity: 0; }
    }
    
    /* 声波动画 */
    .sound-waves {
      position: absolute;
      bottom: -30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 4px;
      height: 20px;
      align-items: flex-end;
    }
    
    .sound-wave {
      width: 4px;
      background: linear-gradient(to top, #1890ff, #722ed1);
      border-radius: 2px;
      animation: soundWave 0.5s ease-in-out infinite;
    }
    
    .sound-wave:nth-child(1) { height: 8px; animation-delay: 0s; }
    .sound-wave:nth-child(2) { height: 14px; animation-delay: 0.1s; }
    .sound-wave:nth-child(3) { height: 20px; animation-delay: 0.2s; }
    .sound-wave:nth-child(4) { height: 14px; animation-delay: 0.3s; }
    .sound-wave:nth-child(5) { height: 8px; animation-delay: 0.4s; }
    
    @keyframes soundWave {
      0%, 100% { transform: scaleY(0.5); }
      50% { transform: scaleY(1); }
    }
    
    .video-play-overlay:not(.playing) ~ .video-demo-wrapper .sound-waves {
      display: none;
    }
    
    .avatar-name {
      margin-top: 16px;
      color: #fff;
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .video-demo-content {
      flex: 1;
      display: flex;
      align-items: center;
      padding-left: 30px;
    }
    
    .demo-text {
      color: #fff;
      font-size: 1rem;
      line-height: 1.8;
      white-space: pre-wrap;
      max-height: 100%;
      overflow-y: auto;
    }
    
    .video-play-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.3);
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .video-play-overlay.playing {
      background: transparent;
      pointer-events: none;
    }
    
    .video-play-overlay.playing .play-button {
      opacity: 0;
    }
    
    .play-button {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding-left: 6px;
      transition: all 0.3s;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .video-play-overlay:not(.playing):hover .play-button {
      transform: scale(1.1);
      background: #fff;
    }
    
    .video-player-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: #1a1a2e;
    }
    
    .control-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: background 0.2s;
    }
    
    .control-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .progress-container {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .progress-bar {
      flex: 1;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      cursor: pointer;
      position: relative;
    }
    
    .progress-filled {
      height: 100%;
      background: linear-gradient(90deg, #1890ff, #722ed1);
      border-radius: 3px;
      transition: width 0.1s;
    }
    
    .time-display {
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.85rem;
      min-width: 100px;
      text-align: right;
    }
    
    .volume-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .volume-slider {
      width: 80px;
      height: 4px;
      -webkit-appearance: none;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      cursor: pointer;
    }
    
    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
    }
    
    .video-player-info {
      padding: 16px 20px;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
    }
    
    .video-info-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .video-info-label {
      color: var(--text-secondary);
      font-size: 0.8rem;
    }
    
    .video-info-value {
      color: var(--text-primary);
      font-size: 0.95rem;
    }
    
    .video-player-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid var(--border);
    }
    
    /* 响应式 */
    @media (max-width: 768px) {
      .video-demo-wrapper {
        flex-direction: column;
        padding: 20px;
      }
      
      .video-demo-avatar {
        flex: 0 0 auto;
        margin-bottom: 20px;
      }
      
      .avatar-circle {
        width: 80px;
        height: 80px;
        font-size: 32px;
      }
      
      .video-demo-content {
        padding-left: 0;
      }
      
      .demo-text {
        font-size: 0.9rem;
      }
      
      .volume-container {
        display: none;
      }
    }

    .dh-list-actions {
      display: flex;
      gap: 8px;
    }

    .dh-action-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-primary);
      font-family: inherit;
    }

    .dh-action-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .dh-action-btn.primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .dh-action-btn.primary:hover {
      background: var(--primary-dark);
    }

    .dh-action-btn.danger {
      color: var(--danger);
      border-color: rgba(255, 77, 79, 0.3);
    }

    .dh-action-btn.danger:hover {
      background: rgba(255, 77, 79, 0.1);
      border-color: var(--danger);
    }

    /* 商品讲解和文案朗读布局 */
    .dh-product-container, .dh-script-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
    }

    .dh-product-left, .dh-script-left,
    .dh-product-right, .dh-script-right {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
    }

    .dh-select-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
    }

    .dh-select-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .dh-select-item:hover {
      border-color: var(--primary);
    }

    .dh-select-item.selected {
      border-color: var(--primary);
      background: rgba(24, 144, 255, 0.05);
    }

    .dh-select-avatar {
      width: 32px;
      height: 32px;
      background: var(--content-bg);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
    }

    .dh-select-name {
      font-weight: 500;
    }

    .dh-empty-mini {
      text-align: center;
      padding: 24px;
      background: var(--content-bg);
      border-radius: 8px;
      color: var(--text-secondary);
    }

    .dh-empty-mini a {
      color: var(--primary);
      text-decoration: none;
    }

    .dh-product-upload {
      margin-top: 16px;
      cursor: pointer;
    }

    .dh-product-preview {
      padding: 40px 20px;
      border: 2px dashed var(--border-color);
      border-radius: 12px;
      text-align: center;
      color: var(--text-secondary);
      transition: all 0.2s ease;
    }

    .dh-product-preview:hover {
      border-color: var(--primary);
    }

    .dh-preview-area {
      background: var(--content-bg);
      border-radius: 12px;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
    }

    .dh-preview-placeholder {
      text-align: center;
      color: var(--text-secondary);
    }

    .dh-preview-placeholder p {
      margin-top: 16px;
      line-height: 1.6;
    }

    .dh-generate-actions {
      display: flex;
      gap: 12px;
    }

    .dh-generate-actions .dh-btn {
      flex: 1;
    }

    .dh-script-textarea {
      width: 100%;
      min-height: 200px;
      padding: 16px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-size: 0.95rem;
      font-family: inherit;
      resize: vertical;
      line-height: 1.8;
      background: var(--card-bg);
      color: var(--text-primary);
    }

    .dh-script-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .dh-script-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    /* 视频列表样式 */
    .dh-video-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }

    .dh-video-tab {
      padding: 10px 20px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--card-bg);
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      font-size: 0.9rem;
    }

    .dh-video-tab:hover {
      border-color: var(--primary);
    }

    .dh-video-tab.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .dh-video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .dh-video-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.2s ease;
    }

    .dh-video-card:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .dh-video-thumbnail {
      position: relative;
      height: 180px;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dh-video-play {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: white;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .dh-video-play:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .dh-video-duration {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
    }

    .dh-video-processing {
      position: absolute;
      top: 8px;
      left: 8px;
      background: var(--warning);
      color: white;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 0.8rem;
    }

    .dh-video-failed {
      position: absolute;
      top: 8px;
      left: 8px;
      background: var(--danger);
      color: white;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 0.8rem;
    }

    .dh-video-card.failed {
      border-color: rgba(255, 77, 79, 0.3);
    }

    .dh-video-card.failed .dh-video-thumbnail {
      opacity: 0.7;
    }

    .dh-video-info {
      padding: 16px;
    }

    .dh-video-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .dh-video-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .dh-video-type {
      color: var(--primary);
    }

    .dh-video-actions {
      padding: 12px 16px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 8px;
    }

    @media (max-width: 1200px) {
      .dh-upload-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .dh-style-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .dh-product-container, .dh-script-container {
        grid-template-columns: 1fr;
      }
      
      .dh-upload-grid {
        grid-template-columns: 1fr;
      }
      
      .dh-steps {
        flex-direction: column;
        gap: 16px;
      }
      
      .dh-step-line {
        width: 2px;
        height: 30px;
        margin: 0;
      }
    }

    /* ========== 录制模态框样式 ========== */
    .record-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .record-modal-overlay.show {
      display: flex;
      animation: fadeIn 0.2s ease;
    }

    .record-modal {
      width: 100%;
      max-width: 640px;
      background: var(--card-bg);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .record-modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .record-modal-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .record-modal-body {
      padding: 24px;
    }

    .record-mode-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .record-mode-tab {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--card-bg);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
      font-family: inherit;
      color: var(--text-primary);
    }

    .record-mode-tab:hover {
      border-color: var(--primary);
    }

    .record-mode-tab.active {
      border-color: var(--primary);
      background: rgba(24, 144, 255, 0.1);
      color: var(--primary);
    }

    .record-preview-container {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .record-preview-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .record-preview-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #666;
      gap: 12px;
    }

    .record-preview-icon {
      font-size: 4rem;
    }

    .record-timer {
      position: absolute;
      top: 16px;
      left: 16px;
      background: rgba(255, 0, 0, 0.8);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .record-dot {
      width: 10px;
      height: 10px;
      background: white;
      border-radius: 50%;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }

    .audio-visualizer {
      background: #1a1a2e;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .audio-visualizer canvas {
      width: 100%;
      height: 100px;
    }

    .record-controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .record-ctrl-btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-primary);
      font-family: inherit;
    }

    .record-ctrl-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .record-ctrl-btn.primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .record-ctrl-btn.primary:hover {
      background: var(--primary-dark);
    }

    .record-ctrl-btn.danger {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }

    .record-ctrl-btn.danger:hover {
      background: #ff1a1a;
    }

    .record-ctrl-btn.recording {
      animation: pulse-red 1s infinite;
    }

    @keyframes pulse-red {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255, 77, 79, 0.4); }
      50% { box-shadow: 0 0 0 10px rgba(255, 77, 79, 0); }
    }

    .record-result {
      background: rgba(82, 196, 26, 0.1);
      border: 1px solid rgba(82, 196, 26, 0.3);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      margin-top: 20px;
    }

    .record-result-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--success);
      margin-bottom: 8px;
    }

    .record-result-info {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    .record-result-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
  </style>
</head>
<body>
  <!-- 侧边栏 -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo-icon">🤖</div>
      <div class="logo-text">
        智能体管理平台
        <span>用户前台</span>
      </div>
    </div>

    <div class="user-info">
      <div class="user-avatar" id="userAvatar">U</div>
      <div class="user-details">
        <div class="user-name" id="userName">用户</div>
        <div class="role-badge">普通用户</div>
      </div>
    </div>

    <nav class="nav-menu" id="navMenu">
      <!-- 菜单将通过JS动态生成 -->
    </nav>

    <div class="sidebar-footer">
      <button class="logout-btn" onclick="logout()">
        <span>🚪</span>
        <span>退出登录</span>
      </button>
    </div>
  </aside>

  <!-- 主内容区 -->
  <main class="main-content">
    <header class="top-header">
      <div class="breadcrumb" id="breadcrumb">
        <span>🏠</span>
        <span>/</span>
        <span class="breadcrumb-item">加载中...</span>
      </div>
      <div class="header-actions">
        <button class="header-btn" title="搜索 (Ctrl+K)" onclick="openSearchModal()">🔍</button>
        <button class="header-btn" title="消息" onclick="openNotificationModal()">🔔</button>
        <button class="header-btn" title="设置" onclick="openSettingsModal()">⚙️</button>
      </div>
    </header>

    <div class="content-area" id="contentArea">
      <!-- 内容将通过JS动态生成 -->
    </div>
  </main>

  <!-- 全局搜索弹窗 -->
  <div class="search-modal-overlay" id="searchModalOverlay" onclick="closeSearchModal(event)">
    <div class="search-modal" onclick="event.stopPropagation()">
      <div class="search-modal-header">
        <div class="search-modal-input-wrapper">
          <span class="search-modal-icon">🔍</span>
          <input type="text" class="search-modal-input" id="globalSearchInput" placeholder="搜索功能、智能体、设置..." oninput="handleGlobalSearch(this.value)">
          <span class="search-shortcut">ESC 关闭</span>
        </div>
      </div>
      <div class="search-modal-body" id="searchResultsBody">
        <!-- 搜索结果将动态生成 -->
      </div>
      <div class="search-modal-footer">
        <div class="search-tips">
          <span class="search-tip"><kbd>↑</kbd><kbd>↓</kbd> 导航</span>
          <span class="search-tip"><kbd>Enter</kbd> 选择</span>
          <span class="search-tip"><kbd>Esc</kbd> 关闭</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 设置弹窗 -->
  <div class="settings-modal-overlay" id="settingsModalOverlay" onclick="closeSettingsModal(event)">
    <div class="settings-modal" onclick="event.stopPropagation()">
      <div class="settings-modal-header">
        <div class="settings-modal-title">
          <span>⚙️</span> 系统设置
        </div>
        <button class="settings-close-btn" onclick="closeSettingsModal()">✕</button>
      </div>
      <div class="settings-modal-body">
        <div class="settings-sidebar">
          <div class="settings-nav-item active" onclick="switchSettingsTab(this, 'profile')">
            <span>👤</span> 个人资料
          </div>
          <div class="settings-nav-item" onclick="switchSettingsTab(this, 'account')">
            <span>🔐</span> 账号安全
          </div>
          <div class="settings-nav-item" onclick="switchSettingsTab(this, 'notification')">
            <span>🔔</span> 通知设置
          </div>
          <div class="settings-nav-item" onclick="switchSettingsTab(this, 'appearance')">
            <span>🎨</span> 外观设置
          </div>
          <div class="settings-nav-item" onclick="switchSettingsTab(this, 'about')">
            <span>ℹ️</span> 关于系统
          </div>
        </div>
        <div class="settings-content" id="settingsContent">
          <!-- 设置内容将动态生成 -->
        </div>
      </div>
    </div>
  </div>

  <!-- 录制模态框 -->
  <div class="record-modal-overlay" id="recordModalOverlay" onclick="closeRecordModal(event)">
    <div class="record-modal" onclick="event.stopPropagation()">
      <div class="record-modal-header">
        <div class="record-modal-title">📹 录制素材</div>
        <button class="settings-close-btn" onclick="closeRecordModal()">✕</button>
      </div>
      
      <div class="record-modal-body">
        <!-- 录制模式选择 -->
        <div class="record-mode-tabs">
          <button class="record-mode-tab active" data-mode="video" onclick="switchRecordMode('video')">
            🎬 录制视频
          </button>
          <button class="record-mode-tab" data-mode="photo" onclick="switchRecordMode('photo')">
            📷 拍摄照片
          </button>
          <button class="record-mode-tab" data-mode="audio" onclick="switchRecordMode('audio')">
            🎤 录制音频
          </button>
        </div>
        
        <!-- 预览区域 -->
        <div class="record-preview-container">
          <video id="recordPreview" autoplay muted playsinline></video>
          <canvas id="recordCanvas" style="display: none;"></canvas>
          <div class="record-preview-placeholder" id="previewPlaceholder">
            <div class="record-preview-icon">📹</div>
            <div>点击下方按钮开启摄像头</div>
          </div>
          
          <!-- 录制时间显示 -->
          <div class="record-timer" id="recordTimer" style="display: none;">
            <span class="record-dot"></span>
            <span id="recordTime">00:00</span>
          </div>
          
          <!-- 拍摄的照片预览 -->
          <img id="capturedPhoto" style="display: none; max-width: 100%; border-radius: 8px;">
        </div>
        
        <!-- 音频波形显示（仅音频模式） -->
        <div class="audio-visualizer" id="audioVisualizer" style="display: none;">
          <canvas id="audioCanvas" width="400" height="100"></canvas>
        </div>
        
        <!-- 录制控制按钮 -->
        <div class="record-controls">
          <button class="record-ctrl-btn" id="btnStartCamera" onclick="startCamera()">
            📷 开启摄像头
          </button>
          <button class="record-ctrl-btn" id="btnStartMic" onclick="startMicrophone()" style="display: none;">
            🎤 开启麦克风
          </button>
          <button class="record-ctrl-btn danger" id="btnStopCamera" onclick="stopCamera()" style="display: none;">
            ⏹️ 关闭设备
          </button>
          <button class="record-ctrl-btn primary" id="btnStartRecord" onclick="startRecording()" style="display: none;">
            ⏺️ 开始录制
          </button>
          <button class="record-ctrl-btn danger recording" id="btnStopRecord" onclick="stopRecording()" style="display: none;">
            ⏹️ 停止录制
          </button>
          <button class="record-ctrl-btn primary" id="btnCapturePhoto" onclick="capturePhoto()" style="display: none;">
            📷 拍摄照片
          </button>
        </div>
        
        <!-- 录制结果 -->
        <div class="record-result" id="recordResult" style="display: none;">
          <div class="record-result-title">✅ 录制完成</div>
          <div class="record-result-info" id="recordResultInfo"></div>
          <div class="record-result-actions">
            <button class="record-ctrl-btn" onclick="retakeRecording()">🔄 重新录制</button>
            <button class="record-ctrl-btn primary" onclick="useRecording()">✓ 使用此素材</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 消息通知弹窗 -->
  <div class="notification-modal-overlay" id="notificationModalOverlay" onclick="closeNotificationModal(event)">
    <div class="notification-modal" onclick="event.stopPropagation()">
      <div class="notification-header">
        <span class="notification-title">🔔 消息通知</span>
        <span class="notification-clear" onclick="clearAllNotifications()">全部已读</span>
      </div>
      <div class="notification-list" id="notificationList">
        <!-- 通知列表将动态生成 -->
      </div>
    </div>
  </div>

  <!-- 创建智能体弹窗 -->
  <div class="create-agent-modal-overlay" id="createAgentModalOverlay" onclick="closeCreateAgentModal(event)">
    <div class="create-agent-modal" onclick="event.stopPropagation()" style="max-width: 700px;">
      <div class="create-agent-header">
        <div class="create-agent-title">
          <span>🤖</span> 创建智能体
        </div>
        <button class="settings-close-btn" onclick="closeCreateAgentModal()">✕</button>
      </div>
      <div class="create-agent-body" style="max-height: 65vh;">
        <!-- 基本信息 -->
        <div class="form-section">
          <div class="form-section-title"><span>📝</span> 基本信息</div>
          <div class="form-row">
            <div class="form-group" style="flex: 2;">
              <label class="form-label">智能体名称 *</label>
              <input type="text" class="form-input" id="agentName" placeholder="给你的智能体起个名字" maxlength="20">
            </div>
            <div class="form-group" style="flex: 1;">
              <label class="form-label">选择图标</label>
              <div class="icon-picker" id="iconPicker">
                <div class="icon-option selected" data-icon="🤖" onclick="selectIcon(this, '🤖')">🤖</div>
                <div class="icon-option" data-icon="🧠" onclick="selectIcon(this, '🧠')">🧠</div>
                <div class="icon-option" data-icon="💡" onclick="selectIcon(this, '💡')">💡</div>
                <div class="icon-option" data-icon="✨" onclick="selectIcon(this, '✨')">✨</div>
                <div class="icon-option" data-icon="🎯" onclick="selectIcon(this, '🎯')">🎯</div>
                <div class="icon-option" data-icon="📚" onclick="selectIcon(this, '📚')">📚</div>
                <div class="icon-option" data-icon="💬" onclick="selectIcon(this, '💬')">💬</div>
                <div class="icon-option" data-icon="🔮" onclick="selectIcon(this, '🔮')">🔮</div>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">选择AI模型平台 *</label>
            <div class="form-select-grid" id="modelSelectGrid">
              <!-- 模型选项将动态生成 -->
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">API Key *</label>
            <input type="password" class="form-input" id="agentApiKey" placeholder="请输入所选平台的API密钥">
            <div class="form-hint" id="apiKeyHint">🔑 请输入对应平台的API Key，<a href="#" id="apiKeyLink" target="_blank" style="color: var(--primary);">点击获取</a></div>
          </div>
          <div class="form-group">
            <label class="form-label">智能体描述</label>
            <textarea class="form-input form-textarea" id="agentDesc" placeholder="描述一下这个智能体的功能和特点..." style="min-height: 80px;"></textarea>
          </div>
        </div>

        <!-- 角色设定 -->
        <div class="form-section">
          <div class="form-section-title"><span>🎭</span> 角色设定</div>
          <div class="form-group">
            <label class="form-label">系统提示词 (System Prompt)</label>
            <textarea class="form-input form-textarea" id="agentSystemPrompt" placeholder="设定智能体的角色、性格和行为规范...&#10;&#10;例如：你是一位专业的编程助手，擅长解答代码问题和提供最佳实践建议。你的回答应该简洁明了，并附带代码示例。" style="min-height: 120px;"></textarea>
            <div class="form-hint">💡 系统提示词定义了智能体的角色和行为方式，好的提示词能让AI更准确地理解你的需求</div>
          </div>
          <div class="form-group">
            <label class="form-label">开场白</label>
            <input type="text" class="form-input" id="agentGreeting" placeholder="例如：你好！我是你的AI助手，有什么可以帮助你的吗？">
          </div>
        </div>

        <!-- 高级设置 -->
        <div class="form-section">
          <div class="form-section-title"><span>⚙️</span> 高级设置</div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">创造性 (Temperature): <span class="form-range-value" id="tempValue">0.7</span></label>
              <input type="range" class="form-range" id="agentTemperature" min="0" max="1" step="0.1" value="0.7" oninput="document.getElementById('tempValue').textContent = this.value">
              <div class="form-hint">值越高回复越有创意，值越低回复越精确</div>
            </div>
            <div class="form-group">
              <label class="form-label">最大回复长度</label>
              <select class="settings-select" id="agentMaxTokens" style="width: 100%;">
                <option value="512">短 (512 tokens)</option>
                <option value="1024">中 (1024 tokens)</option>
                <option value="2048" selected>长 (2048 tokens)</option>
                <option value="4096">超长 (4096 tokens)</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">功能标签 (用逗号分隔)</label>
            <input type="text" class="form-input" id="agentFeatures" placeholder="例如: 对话助手, 代码生成, 文档分析">
          </div>
        </div>
      </div>
      <div class="create-agent-footer">
        <button class="settings-btn secondary" onclick="closeCreateAgentModal()">取消</button>
        <button class="settings-btn primary" onclick="saveCreatedAgent()">🚀 创建智能体</button>
      </div>
    </div>
  </div>

  <!-- 智能体对话界面 -->
  <div class="chat-modal-overlay" id="chatModalOverlay" onclick="closeChatModal(event)">
    <div class="chat-modal" onclick="event.stopPropagation()">
      <div class="chat-header">
        <div class="chat-agent-avatar" id="chatAgentAvatar">🤖</div>
        <div class="chat-agent-info">
          <div class="chat-agent-name" id="chatAgentName">AI 助手</div>
          <div class="chat-agent-status">
            <span id="chatAgentPlatform">GPT-4</span> · 在线
          </div>
        </div>
        <button class="chat-close-btn" onclick="closeChatModal()">✕</button>
      </div>
      <div class="chat-messages" id="chatMessages">
        <!-- 消息列表将动态生成 -->
      </div>
      <div class="chat-input-area">
        <div class="chat-input-wrapper">
          <div class="chat-input-box">
            <textarea class="chat-input" id="chatInput" placeholder="输入消息..." rows="1" onkeydown="handleChatKeydown(event)"></textarea>
          </div>
          <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">
            ➤
          </button>
        </div>
        <div class="chat-suggestions" id="chatSuggestions">
          <!-- 建议将动态生成 -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== API 配置 ==========
    function getApiBaseUrl() {
      // 线上部署地址
      const PRODUCTION_URL = 'https://ai-2-7gjx.onrender.com';
      
      try {
        const customBaseUrl = localStorage.getItem('api_base_url');
        if (customBaseUrl && customBaseUrl.trim()) {
          const url = customBaseUrl.trim().replace(/\/+$/, '');
          // 禁止使用localhost
          if (!url.includes('localhost') && !url.includes('127.0.0.1')) {
            return url;
          }
          // 如果是localhost，使用线上地址
          console.warn('检测到localhost地址，已自动切换到线上地址');
        }
      } catch (e) {
        console.warn('无法读取 api_base_url 配置:', e);
      }
      
      // 检查当前页面是否是localhost
      const currentOrigin = window.location.origin;
      if (currentOrigin.includes('localhost') || currentOrigin.includes('127.0.0.1')) {
        // 如果是localhost，使用线上地址
        return PRODUCTION_URL;
      }
      
      // 如果不是localhost，使用当前页面的origin
      return currentOrigin;
    }

    function buildApiUrl(path) {
      const baseUrl = getApiBaseUrl();
      const normalizedPath = path.startsWith('/') ? path : '/' + path;
      return baseUrl + normalizedPath;
    }
    // 页面配置
    const pageConfig = {
      // AI数字员工
      'my-digital-worker': {
        title: '我的数字员工',
        icon: '🤖',
        iconColor: 'blue',
        parent: 'AI数字员工',
        desc: '管理您的AI数字员工，查看工作状态和效率报告',
        features: [
          { icon: '👨‍💼', color: 'blue', title: '员工列表', desc: '查看所有数字员工的状态和工作进度', btn: '管理员工' },
          { icon: '📊', color: 'green', title: '效率报告', desc: '分析数字员工的工作效率和产出质量', btn: '查看报告' },
          { icon: '⚙️', color: 'purple', title: '员工配置', desc: '调整数字员工的工作参数和行为设置', btn: '去配置' },
          { icon: '➕', color: 'orange', title: '添加员工', desc: '创建新的AI数字员工，扩展您的团队', btn: '立即创建' }
        ]
      },
      'content-topic': {
        title: '内容选题',
        icon: '📋',
        iconColor: 'green',
        parent: 'AI数字员工',
        desc: 'AI智能分析热点，为您推荐最佳内容选题',
        features: [
          { icon: '🔥', color: 'red', title: '热点追踪', desc: '实时追踪各平台热点话题和趋势', btn: '查看热点' },
          { icon: '💡', color: 'orange', title: 'AI推荐', desc: '根据您的定位智能推荐选题方向', btn: '获取推荐' },
          { icon: '📈', color: 'green', title: '选题分析', desc: '分析选题的流量潜力和竞争程度', btn: '开始分析' },
          { icon: '📚', color: 'blue', title: '选题库', desc: '保存和管理您的选题创意库', btn: '进入选题库' }
        ]
      },
      'copywriting': {
        title: '文案编辑',
        icon: '✍️',
        iconColor: 'purple',
        parent: 'AI数字员工',
        desc: 'AI辅助文案创作，一键生成高质量内容',
        features: [
          { icon: '🚀', color: 'blue', title: '快速生成', desc: '输入关键词，AI自动生成完整文案', btn: '开始生成' },
          { icon: '✨', color: 'purple', title: '文案优化', desc: '优化现有文案，提升吸引力和转化率', btn: '去优化' },
          { icon: '📝', color: 'green', title: '模板库', desc: '丰富的文案模板，覆盖各种场景', btn: '浏览模板' },
          { icon: '📖', color: 'orange', title: '历史文案', desc: '查看和复用之前创作的文案', btn: '查看历史' }
        ]
      },
      'video-edit': {
        title: '视频剪辑',
        icon: '🎬',
        iconColor: 'red',
        parent: 'AI数字员工',
        desc: 'AI智能剪辑，快速制作专业级视频',
        features: [
          { icon: '✂️', color: 'red', title: '智能剪辑', desc: 'AI自动识别精彩片段，一键剪辑', btn: '开始剪辑' },
          { icon: '🎨', color: 'purple', title: '特效模板', desc: '丰富的转场、滤镜和动效模板', btn: '浏览特效' },
          { icon: '🎵', color: 'blue', title: '音乐库', desc: '海量免版权音乐，完美配合视频', btn: '选择音乐' },
          { icon: '📁', color: 'green', title: '素材管理', desc: '管理上传的视频、图片等素材', btn: '管理素材' }
        ]
      },
      'video-publish': {
        title: '视频发布',
        icon: '📤',
        iconColor: 'cyan',
        parent: 'AI数字员工',
        desc: '一键多平台发布，智能选择最佳发布时间',
        features: [
          { icon: '🌐', color: 'blue', title: '多平台发布', desc: '支持抖音、快手、B站等主流平台', btn: '发布视频' },
          { icon: '⏰', color: 'orange', title: '定时发布', desc: 'AI推荐最佳发布时间，定时自动发布', btn: '设置定时' },
          { icon: '📊', color: 'green', title: '发布记录', desc: '查看所有视频的发布状态和数据', btn: '查看记录' },
          { icon: '🔄', color: 'purple', title: '批量管理', desc: '批量管理待发布的视频内容', btn: '批量操作' }
        ]
      },
      'account-bindning': {
        title: '账号授权',
        icon: '🔗',
        iconColor: 'orange',
        parent: 'AI数字员工',
        desc: '绑定社交媒体账号，实现自动化运营',
        features: [
          { icon: '📱', color: 'red', title: '抖音账号', desc: '绑定抖音账号，自动发布和互动', btn: '去绑定' },
          { icon: '🎯', color: 'orange', title: '快手账号', desc: '绑定快手账号，扩展内容覆盖', btn: '去绑定' },
          { icon: '📺', color: 'blue', title: 'B站账号', desc: '绑定B站账号，触达年轻用户群', btn: '去绑定' },
          { icon: '💬', color: 'green', title: '微信视频号', desc: '绑定视频号，融入微信生态', btn: '去绑定' }
        ]
      },
      'job-market': {
        title: '大招聘市场',
        icon: '💼',
        iconColor: 'purple',
        parent: 'AI数字员工',
        desc: '发布任务招募AI数字员工，或接单赚取收益',
        features: [
          { icon: '📝', color: 'blue', title: '发布任务', desc: '发布内容创作任务，招募AI员工完成', btn: '发布任务' },
          { icon: '🎯', color: 'green', title: '接单大厅', desc: '浏览可接任务，用AI员工赚取收益', btn: '浏览任务' },
          { icon: '⭐', color: 'orange', title: '优质员工', desc: '查看评分最高的AI数字员工', btn: '查看榜单' },
          { icon: '💰', color: 'purple', title: '收益中心', desc: '查看接单收益和提现记录', btn: '查看收益' }
        ]
      },
      // 智能体市场
      'official-agent': {
        title: '官方智能体',
        icon: '🏆',
        iconColor: 'blue',
        parent: '智能体市场',
        desc: '官方认证的高质量智能体，基于各大AI模型平台打造，功能强大稳定可靠',
        type: 'official-agent-market',
        agents: [
          { 
            id: 'gpt4-assistant', 
            name: 'GPT-4 智能助手', 
            platform: 'OpenAI',
            logo: '🌟', 
            color: '#10a37f',
            desc: '基于GPT-4打造的全能AI助手，擅长对话、分析、创作',
            features: ['多轮对话', '代码生成', '文档分析'],
            price: 99,
            sales: 12580,
            rating: 4.9,
            official: true
          },
          { 
            id: 'claude-writer', 
            name: 'Claude 写作大师', 
            platform: 'Claude',
            logo: '🟠', 
            color: '#d97706',
            desc: '专业写作助手，擅长长文创作和内容优化',
            features: ['长文写作', '风格转换', '文章润色'],
            price: 79,
            sales: 8920,
            rating: 4.8,
            official: true
          },
          { 
            id: 'wenxin-knowledge', 
            name: '文心知识问答', 
            platform: '文心一言',
            logo: '🔵', 
            color: '#2932e1',
            desc: '中文知识问答专家，精通各领域知识',
            features: ['知识问答', '中文理解', '百科查询'],
            price: 59,
            sales: 15680,
            rating: 4.7,
            official: true,
            hot: true
          },
          { 
            id: 'qianwen-coder', 
            name: '通义代码助手', 
            platform: '通义千问',
            logo: '🟣', 
            color: '#6366f1',
            desc: '专业代码助手，支持多种编程语言',
            features: ['代码补全', 'Bug修复', '代码解释'],
            price: 69,
            sales: 9870,
            rating: 4.8,
            official: true
          },
          { 
            id: 'kimi-reader', 
            name: 'Kimi 文档阅读器', 
            platform: 'Kimi',
            logo: '🌙', 
            color: '#8b5cf6',
            desc: '超长文档处理专家，一次理解200万字',
            features: ['长文档分析', '摘要提取', '问答检索'],
            price: 89,
            sales: 7650,
            rating: 4.9,
            official: true,
            isNew: true
          },
          { 
            id: 'deepseek-math', 
            name: 'DeepSeek 数学专家', 
            platform: 'DeepSeek',
            logo: '🌊', 
            color: '#0ea5e9',
            desc: '数学推理和解题专家，擅长复杂计算',
            features: ['数学解题', '推理证明', '公式计算'],
            price: 49,
            sales: 5430,
            rating: 4.7,
            official: true,
            isNew: true
          },
          { 
            id: 'spark-teacher', 
            name: '星火AI教师', 
            platform: '讯飞星火',
            logo: '🔥', 
            color: '#ff6b35',
            desc: '智能教育助手，个性化辅导学习',
            features: ['知识讲解', '习题辅导', '学情分析'],
            price: 79,
            sales: 11200,
            rating: 4.8,
            official: true,
            hot: true
          },
          { 
            id: 'gemini-vision', 
            name: 'Gemini 视觉分析', 
            platform: 'Gemini',
            logo: '💎', 
            color: '#4285f4',
            desc: '多模态视觉AI，图像识别与分析专家',
            features: ['图像识别', '视觉问答', 'OCR识别'],
            price: 99,
            sales: 6780,
            rating: 4.9,
            official: true
          },
          { 
            id: 'glm-translator', 
            name: 'ChatGLM 翻译官', 
            platform: 'ChatGLM',
            logo: '🟢', 
            color: '#059669',
            desc: '多语言翻译专家，支持50+语言互译',
            features: ['精准翻译', '术语库', '风格适配'],
            price: 39,
            sales: 8900,
            rating: 4.6,
            official: true
          },
          { 
            id: 'minimax-roleplay', 
            name: 'MiniMax 角色扮演', 
            platform: 'MiniMax',
            logo: '🎯', 
            color: '#ec4899',
            desc: '沉浸式角色扮演体验，情感丰富',
            features: ['角色扮演', '情感交互', '故事创作'],
            price: 59,
            sales: 4560,
            rating: 4.7,
            official: true
          },
          { 
            id: 'baichuan-search', 
            name: '百川智能搜索', 
            platform: '百川智能',
            logo: '🏔️', 
            color: '#14b8a6',
            desc: '搜索增强AI，实时获取最新信息',
            features: ['实时搜索', '信息整合', '知识图谱'],
            price: 69,
            sales: 3890,
            rating: 4.5,
            official: true
          },
          { 
            id: 'llama-opensource', 
            name: 'Llama 开源助手', 
            platform: 'Llama',
            logo: '🦙', 
            color: '#0668E1',
            desc: '基于Llama的开源智能体，可自定义部署',
            features: ['本地部署', '自定义', '开源免费'],
            price: 0,
            sales: 25600,
            rating: 4.4,
            official: true,
            free: true
          }
        ]
      },
      'user-agent': {
        title: '用户智能体',
        icon: '👥',
        iconColor: 'green',
        parent: '智能体市场',
        desc: '选择AI模型平台，创建您的专属智能体',
        type: 'model-select',
        models: [
          { 
            id: 'groq', 
            name: 'Groq (免费)', 
            logo: '⚡', 
            color: '#f55036',
            models: ['Llama 3.3 70B', 'Llama 3.1 8B', 'Mixtral 8x7B', 'Gemma2 9B'],
            desc: '🎉 完全免费！超快推理速度，支持Llama等开源模型',
            features: ['免费使用', '极速响应', '开源模型'],
            popular: true,
            isFree: true
          },
          { 
            id: 'openai', 
            name: 'OpenAI', 
            logo: '🌟', 
            color: '#10a37f',
            models: ['GPT-4o', 'GPT-4', 'GPT-3.5 Turbo'],
            desc: '全球领先的AI模型，强大的理解和生成能力',
            features: ['多模态支持', '128K上下文', '函数调用'],
            popular: true
          },
          { 
            id: 'claude', 
            name: 'Claude', 
            logo: '🟠', 
            color: '#d97706',
            models: ['Claude 3 Opus', 'Claude 3 Sonnet', 'Claude 3 Haiku'],
            desc: 'Anthropic出品，擅长分析和创意写作',
            features: ['200K上下文', '安全可控', '深度分析']
          },
          { 
            id: 'gemini', 
            name: 'Gemini', 
            logo: '💎', 
            color: '#4285f4',
            models: ['Gemini Ultra', 'Gemini Pro', 'Gemini Nano'],
            desc: 'Google最新AI模型，多模态原生支持',
            features: ['多模态原生', '实时搜索', '长文本处理']
          },
          { 
            id: 'wenxin', 
            name: '文心一言', 
            logo: '🔵', 
            color: '#2932e1',
            models: ['ERNIE 4.0', 'ERNIE 3.5', 'ERNIE Speed'],
            desc: '百度出品，中文理解能力出色',
            features: ['中文优化', '知识增强', '插件生态'],
            popular: true
          },
          { 
            id: 'qianwen', 
            name: '通义千问', 
            logo: '🟣', 
            color: '#6366f1',
            models: ['Qwen-Max', 'Qwen-Plus', 'Qwen-Turbo'],
            desc: '阿里云AI，性价比高，支持长文本',
            features: ['超长上下文', '代码能力强', '多语言支持']
          },
          { 
            id: 'spark', 
            name: '讯飞星火', 
            logo: '🔥', 
            color: '#ff6b35',
            models: ['Spark 4.0 Ultra', 'Spark 3.5 Max', 'Spark Lite'],
            desc: '科大讯飞出品，语音交互领先',
            features: ['语音能力强', '教育场景', '实时对话']
          },
          { 
            id: 'glm', 
            name: '智谱AI/GLM', 
            logo: '🟢', 
            color: '#059669',
            models: ['GLM-4-Plus', 'GLM-4-Flash', 'GLM-4-Air', 'GLM-4-Long'],
            desc: '智谱清言，国产顶级大模型，中文能力强',
            features: ['中文优化', '长文本支持', '高性价比'],
            popular: true
          },
          { 
            id: 'llama', 
            name: 'Llama', 
            logo: '🦙', 
            color: '#0668E1',
            models: ['Llama 3.1 405B', 'Llama 3.1 70B', 'Llama 3.1 8B'],
            desc: 'Meta开源大模型，社区生态丰富',
            features: ['完全开源', '可商用', '社区活跃']
          },
          { 
            id: 'deepseek', 
            name: 'DeepSeek', 
            logo: '🌊', 
            color: '#0ea5e9',
            models: ['DeepSeek-V2', 'DeepSeek-Coder', 'DeepSeek-Math'],
            desc: '深度求索，代码和数学能力突出',
            features: ['代码专精', '数学推理', '性价比高'],
            isNew: true
          },
          { 
            id: 'moonshot', 
            name: 'Kimi', 
            logo: '🌙', 
            color: '#8b5cf6',
            models: ['Moonshot-v1-128k', 'Moonshot-v1-32k', 'Moonshot-v1-8k'],
            desc: '月之暗面出品，超长文本处理专家',
            features: ['200万字上下文', '文档分析', '联网搜索'],
            isNew: true
          },
          { 
            id: 'minimax', 
            name: 'MiniMax', 
            logo: '🎯', 
            color: '#ec4899',
            models: ['abab6.5', 'abab5.5', 'abab5.5s'],
            desc: 'MiniMax出品，擅长角色扮演和对话',
            features: ['角色扮演', '情感表达', '语音合成']
          },
          { 
            id: 'baichuan', 
            name: '百川智能', 
            logo: '🏔️', 
            color: '#14b8a6',
            models: ['Baichuan4', 'Baichuan3-Turbo', 'Baichuan2'],
            desc: '搜索增强，知识问答专家',
            features: ['搜索增强', '知识丰富', '中文优化']
          }
        ]
      },
      // 更多页面配置...
      'official-workflow': { title: '官方工作流', icon: '⚡', iconColor: 'purple', parent: '工作流市场', desc: '官方认证的自动化工作流' },
      'user-workflow': { title: '用户工作流', icon: '🔄', iconColor: 'blue', parent: '工作流市场', desc: '社区分享的工作流' },
      'my-purchased-agent': { 
        title: '我购买的智能体', 
        icon: '🛒', 
        iconColor: 'green', 
        parent: '我的智能体', 
        desc: '管理从智能体市场购买的所有智能体',
        type: 'my-purchased-agents'
      },
      'my-created-agent': { 
        title: '我创建的智能体', 
        icon: '🔨', 
        iconColor: 'orange', 
        parent: '我的智能体', 
        desc: '管理您创建的个人智能体',
        type: 'my-created-agents'
      },
      'my-purchased-workflow': { title: '我购买的工作流', icon: '📥', iconColor: 'blue', parent: '我的工作流', desc: '管理已购买的工作流' },
      'my-created-workflow': { title: '我创建的工作流', icon: '🛠️', iconColor: 'purple', parent: '我的工作流', desc: '管理我创建的工作流' },
      'industry-category': { title: '行业分类', icon: '🏭', iconColor: 'blue', parent: '我的作品表', desc: '按行业分类管理作品' },
      'custom-category': { title: '自定义类目', icon: '🏷️', iconColor: 'green', parent: '我的作品表', desc: '创建自定义分类目录' },
      'my-works': { title: '我的作品', icon: '🎨', iconColor: 'purple', parent: '我的作品表', desc: '管理所有创作的作品' },
      'vip-purchase': { title: '会员购买', icon: '👑', iconColor: 'orange', parent: '个人中心', desc: '升级会员享受更多权益' },
      'token-recharge': { title: '算力豆充值', icon: '🪙', iconColor: 'orange', parent: '个人中心', desc: '充值算力豆获取更多使用次数' },
      'my-orders': { title: '我的订单', icon: '📋', iconColor: 'blue', parent: '个人中心', desc: '查看所有订单记录' },
      'my-income': { title: '我的收入', icon: '💰', iconColor: 'green', parent: '个人中心', desc: '查看收益和提现' },
      
      // 数字人模块
      'digital-human-create': {
        title: '创建数字人',
        icon: '👤',
        iconColor: 'blue',
        parent: '数字人',
        desc: '上传素材，结合AI智能体，生成专属数字人',
        type: 'digital-human-create'
      },
      'digital-human-list': {
        title: '我的数字人',
        icon: '👥',
        iconColor: 'purple',
        parent: '数字人',
        desc: '管理您创建的所有数字人形象',
        type: 'digital-human-list'
      },
      'digital-human-product': {
        title: '商品讲解',
        icon: '🛒',
        iconColor: 'orange',
        parent: '数字人',
        desc: '让数字人拿着商品进行专业讲解和推广',
        type: 'digital-human-product'
      },
      'digital-human-script': {
        title: '文案朗读',
        icon: '📖',
        iconColor: 'green',
        parent: '数字人',
        desc: '让数字人朗读您的文案，生成视频',
        type: 'digital-human-script'
      },
      'digital-human-video': {
        title: '生成视频',
        icon: '🎬',
        iconColor: 'red',
        parent: '数字人',
        desc: '查看和管理已生成的数字人视频',
        type: 'digital-human-video'
      }
    };

    // 菜单配置
    const menuData = [
      {
        icon: '🤖', text: 'AI数字员工', open: false,
        children: [
          { text: '我的数字员工', page: 'my-digital-worker' },
          { text: '内容选题', page: 'content-topic' },
          { text: '文案编辑', page: 'copywriting' },
          { text: '视频剪辑', page: 'video-edit' },
          { text: '视频发布', page: 'video-publish' },
          { text: '账号授权', page: 'account-bindning' },
          { text: '大招聘市场', page: 'job-market' }
        ]
      },
      {
        icon: '🏪', text: '智能体市场',
        children: [
          { text: '官方智能体', page: 'official-agent' },
          { text: '用户智能体', page: 'user-agent' }
        ]
      },
      {
        icon: '👤', text: '数字人', tag: { text: 'NEW', color: 'red' },
        children: [
          { text: '🇨🇳 国内数字人', page: 'digital-human-cn', tag: { text: '国产', color: 'red' }, isExternal: true, url: 'digital-human-cn.html' },
          { text: '🌍 国际数字人', page: 'digital-human-intl', tag: { text: 'Global', color: 'purple' }, isExternal: true, url: 'digital-human-intl.html' }
        ]
      },
      {
        icon: '⚡', text: '工作流市场',
        children: [
          { text: '官方工作流', page: 'official-workflow', tag: { text: '工作流', color: 'purple' } },
          { text: '用户工作流', page: 'user-workflow' }
        ]
      },
      {
        icon: '🎯', text: '我的智能体',
        children: [
          { text: '我购买的', page: 'my-purchased-agent' },
          { text: '我创建的', page: 'my-created-agent', tag: { text: '创建智能体', color: 'green' } }
        ]
      },
      {
        icon: '🔧', text: '我的工作流',
        children: [
          { text: '我购买的', page: 'my-purchased-workflow' },
          { text: '我创建的', page: 'my-created-workflow', tag: { text: '创建工作流', color: 'purple' } }
        ]
      },
      {
        icon: '📝', text: '我的作品表',
        children: [
          { text: '行业分类', page: 'industry-category' },
          { text: '自定义类目', page: 'custom-category' },
          { text: '我的作品', page: 'my-works', tag: { text: '作品', color: 'blue' } }
        ]
      },
      {
        icon: '👤', text: '个人中心',
        children: [
          { text: '会员购买', page: 'vip-purchase' },
          { text: '算力豆充值', page: 'token-recharge' },
          { text: '我的订单', page: 'my-orders' },
          { text: '我的收入', page: 'my-income', tag: { text: '提现', color: 'orange' } }
        ]
      }
    ];

    // 获取当前页面参数
    function getCurrentPage() {
      const params = new URLSearchParams(window.location.search);
      return params.get('page') || 'my-digital-worker';
    }

    // 渲染菜单
    function renderMenu() {
      const currentPage = getCurrentPage();
      const navMenu = document.getElementById('navMenu');
      let html = '';

      menuData.forEach((menu, index) => {
        const isOpen = menu.children.some(c => c.page === currentPage) || menu.open;
        html += `
          <div class="menu-item ${isOpen ? 'open' : ''}">
            <div class="menu-link parent" onclick="toggleSubmenu(this)">
              <span class="menu-icon">${menu.icon}</span>
              <span class="menu-text">${menu.text}</span>
              ${menu.tag ? `<span class="menu-tag ${menu.tag.color}">${menu.tag.text}</span>` : ''}
              <span class="menu-arrow">›</span>
            </div>
            <div class="submenu">
              ${menu.children.map(child => {
                // 判断是否是外部链接
                const href = child.isExternal ? child.url : `page.html?page=${child.page}`;
                return `
                  <a class="submenu-link ${child.page === currentPage ? 'active' : ''}" href="${href}">
                    <span class="submenu-text">${child.text}</span>
                    ${child.tag ? `<span class="menu-tag ${child.tag.color}">${child.tag.text}</span>` : ''}
                  </a>
                `;
              }).join('')}
            </div>
          </div>
        `;
      });

      navMenu.innerHTML = html;
    }

    // 渲染页面内容
    function renderContent() {
      const currentPage = getCurrentPage();
      const config = pageConfig[currentPage];
      
      if (!config) {
        document.getElementById('contentArea').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">🔍</div>
            <div class="empty-state-title">页面不存在</div>
            <div class="empty-state-desc">请从左侧菜单选择功能</div>
          </div>
        `;
        return;
      }

      // 更新面包屑
      document.getElementById('breadcrumb').innerHTML = `
        <span>🏠</span>
        <span>/</span>
        <span>${config.parent}</span>
        <span>/</span>
        <span class="breadcrumb-item">${config.title}</span>
      `;

      // 更新页面标题
      document.title = `${config.title} - 智能体管理平台`;

      // 根据页面类型渲染不同内容
      if (config.type === 'model-select') {
        renderModelSelectPage(config);
        return;
      }
      
      if (config.type === 'official-agent-market') {
        renderOfficialAgentMarket(config);
        return;
      }
      
      if (config.type === 'my-purchased-agents') {
        renderMyPurchasedAgents(config);
        return;
      }
      
      if (config.type === 'my-created-agents') {
        renderMyCreatedAgents(config);
        return;
      }
      
      // 数字人模块页面
      if (config.type === 'digital-human-create') {
        renderDigitalHumanCreate(config);
        return;
      }
      
      if (config.type === 'digital-human-list') {
        renderDigitalHumanList(config);
        return;
      }
      
      if (config.type === 'digital-human-product') {
        renderDigitalHumanProduct(config);
        return;
      }
      
      if (config.type === 'digital-human-script') {
        renderDigitalHumanScript(config);
        return;
      }
      
      if (config.type === 'digital-human-video') {
        renderDigitalHumanVideo(config);
        return;
      }

      // 渲染普通功能页面
      let featuresHtml = '';
      if (config.features && config.features.length > 0) {
        featuresHtml = `
          <div class="feature-grid">
            ${config.features.map(f => `
              <div class="feature-card">
                <div class="feature-card-icon ${f.color}">${f.icon}</div>
                <div class="feature-card-title">${f.title}</div>
                <div class="feature-card-desc">${f.desc}</div>
                <div class="feature-card-action">
                  <button class="feature-card-btn">${f.btn}</button>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      } else {
        featuresHtml = `
          <div class="empty-state">
            <div class="empty-state-icon">🚧</div>
            <div class="empty-state-title">功能开发中</div>
            <div class="empty-state-desc">该功能正在紧张开发中，敬请期待</div>
            <button class="empty-state-btn" onclick="window.location.href='dashboard.html'">返回首页</button>
          </div>
        `;
      }

      document.getElementById('contentArea').innerHTML = `
        <div class="page-header">
          <div class="page-title">
            <div class="page-title-icon ${config.iconColor}">${config.icon}</div>
            ${config.title}
          </div>
          <div class="page-desc">${config.desc}</div>
        </div>
        ${featuresHtml}
      `;
    }

    // 渲染AI模型选择页面
    function renderModelSelectPage(config) {
      const models = config.models || [];
      
      const modelsHtml = models.map(model => `
        <div class="model-card" data-model="${model.id}" onclick="selectModel('${model.id}')">
          <div class="model-card-header">
            <div class="model-logo" style="background: ${model.color}15;">
              <span style="filter: none;">${model.logo}</span>
            </div>
            <div class="model-info">
              <div class="model-name">
                ${model.name}
                ${model.isFree ? '<span class="model-badge free">🎉 免费</span>' : ''}
                ${model.popular && !model.isFree ? '<span class="model-badge popular">🔥 热门</span>' : ''}
                ${model.isNew ? '<span class="model-badge new">✨ 新</span>' : ''}
              </div>
              <div class="model-desc">${model.desc}</div>
            </div>
          </div>
          <div class="model-card-body">
            <div class="model-list-label">可用模型</div>
            <div class="model-versions">
              ${model.models.map(m => `<span class="model-version-tag">${m}</span>`).join('')}
            </div>
            <div class="model-features">
              ${model.features.map(f => `<span class="model-feature-tag">${f}</span>`).join('')}
            </div>
          </div>
          <div class="model-card-footer">
            <div class="model-price">
              算力消耗: <span>按需计费</span>
            </div>
            <button class="model-select-btn primary" onclick="event.stopPropagation(); createAgent('${model.id}', '${model.name}')">
              创建智能体
            </button>
          </div>
        </div>
      `).join('');

      document.getElementById('contentArea').innerHTML = `
        <div class="page-header">
          <div class="page-title">
            <div class="page-title-icon ${config.iconColor}">${config.icon}</div>
            ${config.title}
          </div>
          <div class="page-desc">${config.desc}</div>
        </div>

        <div class="model-search">
          <div class="search-input-wrapper">
            <span class="search-icon">🔍</span>
            <input type="text" class="search-input" placeholder="搜索AI模型..." oninput="filterModels(this.value)">
          </div>
        </div>

        <div class="model-filter">
          <button class="filter-btn active" onclick="filterByCategory(this, 'all')">全部</button>
          <button class="filter-btn" onclick="filterByCategory(this, 'popular')">🔥 热门推荐</button>
          <button class="filter-btn" onclick="filterByCategory(this, 'new')">✨ 最新上线</button>
          <button class="filter-btn" onclick="filterByCategory(this, 'chinese')">🇨🇳 国产模型</button>
          <button class="filter-btn" onclick="filterByCategory(this, 'foreign')">🌍 国际模型</button>
          <button class="filter-btn" onclick="filterByCategory(this, 'opensource')">📖 开源模型</button>
        </div>

        <div class="model-section">
          <div class="model-section-title">
            <span>🤖</span> 选择AI模型平台 <span style="color: var(--text-secondary); font-weight: 400; font-size: 0.85rem;">(共 ${models.length} 个平台)</span>
          </div>
          <div class="model-grid" id="modelGrid">
            ${modelsHtml}
          </div>
        </div>
      `;
    }

    // 选择模型
    function selectModel(modelId) {
      document.querySelectorAll('.model-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector(`[data-model="${modelId}"]`)?.classList.add('selected');
    }

    // 创建智能体 - 打开创建弹窗
    function createAgent(modelId, modelName) {
      openCreateAgentModal(modelId, modelName);
    }

    // ========== 官方智能体市场 ==========
    function renderOfficialAgentMarket(config) {
      const agents = config.agents || [];
      const purchasedAgents = getPurchasedAgents();
      
      const agentsHtml = agents.map(agent => {
        const isOwned = purchasedAgents.some(p => p.id === agent.id);
        return `
        <div class="agent-card" data-agent="${agent.id}">
          <div class="agent-card-badge">
            ${agent.official ? '<span class="agent-badge official">官方</span>' : ''}
            ${agent.hot ? '<span class="agent-badge hot">🔥热门</span>' : ''}
            ${agent.isNew ? '<span class="agent-badge new">✨新品</span>' : ''}
            ${agent.free ? '<span class="agent-badge free">免费</span>' : ''}
          </div>
          <div class="agent-card-header">
            <div class="agent-logo" style="background: ${agent.color}15;">
              ${agent.logo}
            </div>
            <div class="agent-info">
              <div class="agent-name">${agent.name}</div>
              <div class="agent-platform" style="color: ${agent.color};">${agent.platform}</div>
            </div>
          </div>
          <div class="agent-card-body">
            <div class="agent-desc">${agent.desc}</div>
            <div class="agent-features">
              ${agent.features.map(f => `<span class="agent-feature-tag">${f}</span>`).join('')}
            </div>
            <div class="agent-stats">
              <div class="agent-stat">
                <span class="agent-stat-icon">⭐</span>
                <span class="agent-stat-value">${agent.rating}</span>
              </div>
              <div class="agent-stat">
                <span class="agent-stat-icon">📦</span>
                <span class="agent-stat-value">${formatNumber(agent.sales)}</span> 已购买
              </div>
            </div>
          </div>
          <div class="agent-card-footer">
            <div class="agent-price">
              ${agent.free 
                ? '<span class="agent-price-free">免费使用</span>' 
                : `<span class="agent-price-value">¥${agent.price}</span><span class="agent-price-unit">/月</span>`}
            </div>
            <div class="agent-actions">
              ${isOwned 
                ? `<button class="agent-btn owned">✓ 已拥有</button>
                   <button class="agent-btn secondary" onclick="event.stopPropagation(); useAgent('${agent.id}')">使用</button>`
                : `<button class="agent-btn primary" onclick="event.stopPropagation(); purchaseAgent('${agent.id}')">${agent.free ? '免费获取' : '立即购买'}</button>`}
            </div>
          </div>
        </div>
      `}).join('');

      document.getElementById('contentArea').innerHTML = `
        <div class="page-header">
          <div class="page-title">
            <div class="page-title-icon ${config.iconColor}">${config.icon}</div>
            ${config.title}
          </div>
          <div class="page-desc">${config.desc}</div>
        </div>

        <div class="model-search">
          <div class="search-input-wrapper">
            <span class="search-icon">🔍</span>
            <input type="text" class="search-input" placeholder="搜索智能体..." oninput="filterAgents(this.value)">
          </div>
        </div>

        <div class="model-filter">
          <button class="filter-btn active" onclick="filterAgentsByCategory(this, 'all')">全部</button>
          <button class="filter-btn" onclick="filterAgentsByCategory(this, 'hot')">🔥 热门</button>
          <button class="filter-btn" onclick="filterAgentsByCategory(this, 'new')">✨ 新品</button>
          <button class="filter-btn" onclick="filterAgentsByCategory(this, 'free')">🆓 免费</button>
          <button class="filter-btn" onclick="filterAgentsByCategory(this, 'owned')">✅ 已拥有</button>
        </div>

        <div class="model-section">
          <div class="model-section-title">
            <span>🏆</span> 官方认证智能体 <span style="color: var(--text-secondary); font-weight: 400; font-size: 0.85rem;">(共 ${agents.length} 个智能体)</span>
          </div>
          <div class="agent-grid" id="agentGrid">
            ${agentsHtml}
          </div>
        </div>
      `;
    }

    // 格式化数字
    function formatNumber(num) {
      if (num >= 10000) return (num / 10000).toFixed(1) + '万';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
      return num.toString();
    }

    // 搜索智能体
    function filterAgents(keyword) {
      const cards = document.querySelectorAll('.agent-card');
      const agents = pageConfig['official-agent'].agents;
      const lowerKeyword = keyword.toLowerCase();
      
      cards.forEach(card => {
        const agentId = card.dataset.agent;
        const agent = agents.find(a => a.id === agentId);
        const searchText = `${agent.name} ${agent.platform} ${agent.desc} ${agent.features.join(' ')}`.toLowerCase();
        card.style.display = searchText.includes(lowerKeyword) ? '' : 'none';
      });
    }

    // 按类别筛选智能体
    function filterAgentsByCategory(btn, category) {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const cards = document.querySelectorAll('.agent-card');
      const agents = pageConfig['official-agent'].agents;
      const purchasedAgents = getPurchasedAgents();
      
      cards.forEach(card => {
        const agentId = card.dataset.agent;
        const agent = agents.find(a => a.id === agentId);
        const isOwned = purchasedAgents.some(p => p.id === agentId);
        let show = false;

        switch(category) {
          case 'all': show = true; break;
          case 'hot': show = agent.hot === true; break;
          case 'new': show = agent.isNew === true; break;
          case 'free': show = agent.free === true; break;
          case 'owned': show = isOwned; break;
        }
        card.style.display = show ? '' : 'none';
      });
    }

    // 购买智能体
    function purchaseAgent(agentId) {
      const agents = pageConfig['official-agent'].agents;
      const agent = agents.find(a => a.id === agentId);
      
      if (!agent) return;
      
      const confirmText = agent.free 
        ? `确定要获取「${agent.name}」吗？` 
        : `确定要购买「${agent.name}」吗？\n\n价格：¥${agent.price}/月`;
      
      if (confirm(confirmText)) {
        const purchasedAgents = getPurchasedAgents();
        if (purchasedAgents.some(p => p.id === agentId)) {
          alert('您已拥有此智能体！');
          return;
        }
        
        const newAgent = {
          ...agent,
          purchaseDate: new Date().toISOString(),
          type: 'purchased'
        };
        
        purchasedAgents.push(newAgent);
        localStorage.setItem('purchasedAgents', JSON.stringify(purchasedAgents));
        
        alert(`🎉 ${agent.free ? '获取' : '购买'}成功！\n\n「${agent.name}」已添加到您的智能体列表中。`);
        
        // 刷新页面
        renderOfficialAgentMarket(pageConfig['official-agent']);
      }
    }

    // 使用智能体（购买的）
    function useAgent(agentId) {
      // 跳转到对话页面
      window.location.href = `chat.html?id=${agentId}&type=purchased`;
    }

    // 根据平台名称获取平台ID
    function getPlatformIdFromName(platformName) {
      const mapping = {
        'Groq (免费)': 'groq',
        'Groq': 'groq',
        'OpenAI': 'openai',
        'Claude': 'claude',
        '文心一言': 'wenxin',
        '通义千问': 'qianwen',
        'Kimi': 'moonshot',
        'DeepSeek': 'deepseek',
        '讯飞星火': 'spark',
        'ChatGLM': 'glm',
        '智谱AI/GLM': 'glm',
        '智谱AI': 'glm',
        'Gemini': 'gemini',
        'MiniMax': 'minimax',
        '百川智能': 'baichuan',
        'Llama': 'llama'
      };
      return mapping[platformName] || 'openai';
    }

    // 获取已购买的智能体
    function getPurchasedAgents() {
      try {
        return JSON.parse(localStorage.getItem('purchasedAgents')) || [];
      } catch {
        return [];
      }
    }

    // 获取已创建的智能体
    function getCreatedAgents() {
      try {
        return JSON.parse(localStorage.getItem('createdAgents')) || [];
      } catch {
        return [];
      }
    }

    // ========== 我购买的智能体 ==========
    function renderMyPurchasedAgents(config) {
      const purchasedAgents = getPurchasedAgents();
      
      if (purchasedAgents.length === 0) {
        document.getElementById('contentArea').innerHTML = `
          <div class="page-header">
            <div class="page-title">
              <div class="page-title-icon ${config.iconColor}">${config.icon}</div>
              ${config.title}
            </div>
            <div class="page-desc">${config.desc}</div>
          </div>
          <div class="empty-state">
            <div class="empty-state-icon">🛒</div>
            <div class="empty-state-title">暂无购买的智能体</div>
            <div class="empty-state-desc">去智能体市场看看，发现适合您的AI助手</div>
            <button class="empty-state-btn" onclick="window.location.href='page.html?page=official-agent'">浏览智能体市场</button>
          </div>
        `;
        return;
      }

      const agentsHtml = purchasedAgents.map(agent => `
        <div class="my-agent-card">
          <div class="my-agent-header">
            <div class="my-agent-logo" style="background: ${agent.color}15;">
              ${agent.logo}
            </div>
            <div class="my-agent-info">
              <div class="my-agent-name">${agent.name}</div>
              <div class="my-agent-meta">
                <span style="color: ${agent.color};">${agent.platform}</span>
                <span class="my-agent-status">
                  <span class="status-dot active"></span>
                  可用
                </span>
              </div>
            </div>
          </div>
          <div class="my-agent-body">
            <div class="my-agent-desc">${agent.desc}</div>
            <div class="my-agent-tags">
              ${agent.features.map(f => `<span class="agent-feature-tag">${f}</span>`).join('')}
            </div>
          </div>
          <div class="my-agent-footer">
            <div class="my-agent-date">购买时间：${formatDate(agent.purchaseDate)}</div>
            <div class="my-agent-actions">
              <button class="my-agent-btn use" onclick="useAgent('${agent.id}')">使用</button>
              <button class="my-agent-btn delete" onclick="removePurchasedAgent('${agent.id}')">移除</button>
            </div>
          </div>
        </div>
      `).join('');

      document.getElementById('contentArea').innerHTML = `
        <div class="page-header">
          <div class="page-title">
            <div class="page-title-icon ${config.iconColor}">${config.icon}</div>
            ${config.title}
          </div>
          <div class="page-desc">${config.desc}</div>
        </div>
        
        <div class="model-section">
          <div class="model-section-title">
            <span>📦</span> 已购买的智能体 <span style="color: var(--text-secondary); font-weight: 400; font-size: 0.85rem;">(共 ${purchasedAgents.length} 个)</span>
          </div>
          <div class="agent-grid">
            ${agentsHtml}
          </div>
        </div>
      `;
    }

    // 移除已购买的智能体
    function removePurchasedAgent(agentId) {
      if (confirm('确定要移除此智能体吗？')) {
        let purchasedAgents = getPurchasedAgents();
        purchasedAgents = purchasedAgents.filter(a => a.id !== agentId);
        localStorage.setItem('purchasedAgents', JSON.stringify(purchasedAgents));
        renderMyPurchasedAgents(pageConfig['my-purchased-agent']);
      }
    }

    // ========== 我创建的智能体 ==========
    function renderMyCreatedAgents(config) {
      const createdAgents = getCreatedAgents();
      
      if (createdAgents.length === 0) {
        document.getElementById('contentArea').innerHTML = `
          <div class="page-header">
            <div class="page-title">
              <div class="page-title-icon ${config.iconColor}">${config.icon}</div>
              ${config.title}
            </div>
            <div class="page-desc">${config.desc}</div>
          </div>
          <div class="empty-state">
            <div class="empty-state-icon">🔨</div>
            <div class="empty-state-title">暂无创建的智能体</div>
            <div class="empty-state-desc">发挥创意，基于各大AI模型创建您的专属智能体</div>
            <button class="empty-state-btn" onclick="openCreateAgentModal()">创建智能体</button>
          </div>
        `;
        return;
      }

      const agentsHtml = createdAgents.map(agent => `
        <div class="my-agent-card">
          <div class="my-agent-header">
            <div class="my-agent-logo" style="background: ${agent.color}15;">
              ${agent.logo}
            </div>
            <div class="my-agent-info">
              <div class="my-agent-name">${agent.name}</div>
              <div class="my-agent-meta">
                <span style="color: ${agent.color};">${agent.platform}</span>
                <span class="my-agent-status">
                  <span class="status-dot active"></span>
                  可用
                </span>
              </div>
            </div>
          </div>
          <div class="my-agent-body">
            <div class="my-agent-desc">${agent.desc || '暂无描述'}</div>
            <div class="my-agent-tags">
              ${agent.features.map(f => `<span class="agent-feature-tag">${f}</span>`).join('')}
            </div>
          </div>
          <div class="my-agent-footer">
            <div class="my-agent-date">创建时间：${formatDate(agent.createDate)}</div>
            <div class="my-agent-actions">
              <button class="my-agent-btn use" onclick="useCreatedAgent('${agent.id}')">使用</button>
              <button class="my-agent-btn edit" onclick="editCreatedAgent('${agent.id}')">编辑</button>
              <button class="my-agent-btn delete" onclick="deleteCreatedAgent('${agent.id}')">删除</button>
            </div>
          </div>
        </div>
      `).join('');

      document.getElementById('contentArea').innerHTML = `
        <div class="page-header">
          <div class="page-title">
            <div class="page-title-icon ${config.iconColor}">${config.icon}</div>
            ${config.title}
          </div>
          <div class="page-desc">${config.desc}</div>
        </div>
        
        <div style="margin-bottom: 24px;">
          <button class="agent-btn primary" onclick="openCreateAgentModal()">
            ➕ 创建新智能体
          </button>
        </div>
        
        <div class="model-section">
          <div class="model-section-title">
            <span>🔧</span> 我创建的智能体 <span style="color: var(--text-secondary); font-weight: 400; font-size: 0.85rem;">(共 ${createdAgents.length} 个)</span>
          </div>
          <div class="agent-grid">
            ${agentsHtml}
          </div>
        </div>
      `;
    }

    // 使用创建的智能体
    function useCreatedAgent(agentId) {
      // 跳转到对话页面
      window.location.href = `chat.html?id=${agentId}&type=created`;
    }

    // 编辑创建的智能体
    function editCreatedAgent(agentId) {
      const agents = getCreatedAgents();
      const agent = agents.find(a => a.id === agentId);
      if (agent) {
        openEditAgentModal(agent);
      }
    }
    
    // 打开编辑智能体弹窗
    function openEditAgentModal(agent) {
      editingAgentId = agent.id;
      document.getElementById('createAgentModalOverlay').classList.add('show');
      
      // 渲染模型选择网格
      const grid = document.getElementById('modelSelectGrid');
      const platformId = modelOptions.find(m => m.name === agent.platform)?.id || 'openai';
      grid.innerHTML = modelOptions.map(m => `
        <div class="form-select-item ${m.name === agent.platform ? 'selected' : ''}" 
             data-model="${m.id}" 
             onclick="selectCreateModel('${m.id}')">
          <div class="form-select-item-icon">${m.logo}</div>
          <div class="form-select-item-name">${m.name}</div>
        </div>
      `).join('');
      
      selectedModelId = platformId;
      selectedIcon = agent.customIcon || agent.logo;
      
      // 更新图标选择
      document.querySelectorAll('.icon-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.icon === selectedIcon);
      });
      
      // 填充表单
      document.getElementById('agentName').value = agent.name || '';
      document.getElementById('agentDesc').value = agent.desc || '';
      document.getElementById('agentApiKey').value = ''; // 不显示已保存的API Key，用户可以输入新的
      document.getElementById('agentApiKey').placeholder = agent.apiKey ? '已配置 (留空保持不变)' : '请输入API密钥';
      document.getElementById('agentSystemPrompt').value = agent.systemPrompt || '';
      document.getElementById('agentGreeting').value = agent.greeting || '';
      document.getElementById('agentTemperature').value = agent.temperature || 0.7;
      document.getElementById('tempValue').textContent = agent.temperature || 0.7;
      document.getElementById('agentMaxTokens').value = agent.maxTokens || '2048';
      document.getElementById('agentFeatures').value = (agent.features || []).join(', ');
      
      // 更新API Key链接
      selectCreateModel(platformId);
    }

    // 删除创建的智能体
    function deleteCreatedAgent(agentId) {
      if (confirm('确定要删除此智能体吗？此操作不可恢复。')) {
        let createdAgents = getCreatedAgents();
        createdAgents = createdAgents.filter(a => a.id !== agentId);
        localStorage.setItem('createdAgents', JSON.stringify(createdAgents));
        renderMyCreatedAgents(pageConfig['my-created-agent']);
      }
    }

    // 格式化日期
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }

    // ========== 创建智能体弹窗 ==========
    let selectedModelId = null;
    let selectedIcon = '🤖';
    let editingAgentId = null;

    const modelOptions = [
      { id: 'groq', name: 'Groq (免费)', logo: '⚡', color: '#f55036', isFree: true },
      { id: 'openai', name: 'OpenAI', logo: '🌟', color: '#10a37f' },
      { id: 'claude', name: 'Claude', logo: '🟠', color: '#d97706' },
      { id: 'qianwen', name: '通义千问', logo: '🟣', color: '#6366f1' },
      { id: 'moonshot', name: 'Kimi', logo: '🌙', color: '#8b5cf6' },
      { id: 'deepseek', name: 'DeepSeek', logo: '🌊', color: '#0ea5e9' },
      { id: 'glm', name: '智谱AI/GLM', logo: '🟢', color: '#059669' },
    ];

    function openCreateAgentModal(preselectedModelId, preselectedModelName) {
      editingAgentId = null;
      document.getElementById('createAgentModalOverlay').classList.add('show');
      
      // 渲染模型选择网格
      const grid = document.getElementById('modelSelectGrid');
      grid.innerHTML = modelOptions.map(m => `
        <div class="form-select-item ${m.id === preselectedModelId ? 'selected' : ''}" 
             data-model="${m.id}" 
             onclick="selectCreateModel('${m.id}')">
          <div class="form-select-item-icon">${m.logo}</div>
          <div class="form-select-item-name">${m.name}</div>
        </div>
      `).join('');
      
      selectedModelId = preselectedModelId || null;
      selectedIcon = '🤖';
      
      // 重置图标选择
      document.querySelectorAll('.icon-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.icon === '🤖');
      });
      
      // 清空表单
      document.getElementById('agentName').value = '';
      document.getElementById('agentDesc').value = '';
      document.getElementById('agentApiKey').value = '';
      document.getElementById('agentSystemPrompt').value = '';
      document.getElementById('agentGreeting').value = '';
      document.getElementById('agentTemperature').value = '0.7';
      document.getElementById('tempValue').textContent = '0.7';
      document.getElementById('agentMaxTokens').value = '2048';
      document.getElementById('agentFeatures').value = '';
      
      // 如果有预选模型，更新API链接
      if (preselectedModelId) {
        selectCreateModel(preselectedModelId);
      }
    }

    function closeCreateAgentModal(event) {
      if (!event || event.target === document.getElementById('createAgentModalOverlay')) {
        document.getElementById('createAgentModalOverlay').classList.remove('show');
        editingAgentId = null;
      }
    }

    function selectCreateModel(modelId) {
      selectedModelId = modelId;
      document.querySelectorAll('.form-select-item').forEach(item => {
        item.classList.toggle('selected', item.dataset.model === modelId);
      });
      
      // 更新API Key获取链接
      const apiKeyLinks = {
        'openai': 'https://platform.openai.com/api-keys',
        'claude': 'https://console.anthropic.com/',
        'qianwen': 'https://dashscope.console.aliyun.com/',
        'moonshot': 'https://platform.moonshot.cn/',
        'deepseek': 'https://platform.deepseek.com/',
        'glm': 'https://open.bigmodel.cn/',
        'groq': 'https://console.groq.com/keys'
      };
      
      const linkEl = document.getElementById('apiKeyLink');
      const hintEl = document.getElementById('apiKeyHint');
      const model = modelOptions.find(m => m.id === modelId);
      
      if (linkEl && apiKeyLinks[modelId]) {
        linkEl.href = apiKeyLinks[modelId];
        linkEl.textContent = `前往${model?.name || '平台'}获取`;
      }
    }

    function selectIcon(element, icon) {
      selectedIcon = icon;
      document.querySelectorAll('.icon-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.icon === icon);
      });
    }

    function saveCreatedAgent() {
      const name = document.getElementById('agentName').value.trim();
      const desc = document.getElementById('agentDesc').value.trim();
      const apiKey = document.getElementById('agentApiKey').value.trim();
      const systemPrompt = document.getElementById('agentSystemPrompt').value.trim();
      const greeting = document.getElementById('agentGreeting').value.trim();
      const temperature = parseFloat(document.getElementById('agentTemperature').value);
      const maxTokens = document.getElementById('agentMaxTokens').value;
      const featuresStr = document.getElementById('agentFeatures').value.trim();
      
      if (!name) {
        alert('请输入智能体名称！');
        return;
      }
      
      if (!selectedModelId) {
        alert('请选择AI模型平台！');
        return;
      }
      
      if (!apiKey && !editingAgentId) {
        alert('请输入API Key！\n\n没有API Key将无法与智能体对话。');
        return;
      }
      
      const model = modelOptions.find(m => m.id === selectedModelId);
      const features = featuresStr ? featuresStr.split(/[,，]/).map(f => f.trim()).filter(f => f) : ['AI助手'];
      
      const agentData = {
        name: name,
        platformId: selectedModelId,
        platform: model.name,
        logo: model.logo,
        customIcon: selectedIcon,
        color: model.color,
        desc: desc || `基于${model.name}创建的智能体`,
        systemPrompt: systemPrompt || `你是一个名为"${name}"的AI助手，基于${model.name}模型。请友好、专业地回答用户的问题。`,
        greeting: greeting || `你好！我是${name}，有什么可以帮助你的吗？`,
        temperature: temperature,
        maxTokens: maxTokens,
        features: features,
        type: 'created'
      };
      
      // 只有当输入了新的API Key时才更新
      if (apiKey) {
        agentData.apiKey = apiKey;
      }
      
      let createdAgents = getCreatedAgents();
      
      if (editingAgentId) {
        // 编辑模式
        const index = createdAgents.findIndex(a => a.id === editingAgentId);
        if (index !== -1) {
          // 保留原有的API Key如果没有输入新的
          if (!apiKey && createdAgents[index].apiKey) {
            agentData.apiKey = createdAgents[index].apiKey;
          }
          createdAgents[index] = { ...createdAgents[index], ...agentData };
        }
        localStorage.setItem('createdAgents', JSON.stringify(createdAgents));
        closeCreateAgentModal();
        alert(`✅ 修改成功！\n\n「${name}」已更新。`);
      } else {
        // 创建模式
        const newAgent = {
          id: 'custom-' + Date.now(),
          ...agentData,
          createDate: new Date().toISOString(),
          chatHistory: []
        };
        createdAgents.push(newAgent);
        localStorage.setItem('createdAgents', JSON.stringify(createdAgents));
        closeCreateAgentModal();
        alert(`🎉 创建成功！\n\n「${name}」已添加到我的智能体列表中。`);
      }
      
      // 如果当前在我创建的智能体页面，刷新
      if (getCurrentPage() === 'my-created-agent') {
        renderMyCreatedAgents(pageConfig['my-created-agent']);
      }
    }

    // ========== 智能体对话功能 ==========
    let currentChatAgent = null;
    let chatMessages = [];
    let isAiResponding = false;

    function openChatModal(agent) {
      currentChatAgent = agent;
      chatMessages = agent.chatHistory || [];
      
      // 更新聊天界面信息
      document.getElementById('chatAgentAvatar').textContent = agent.customIcon || agent.logo;
      document.getElementById('chatAgentName').textContent = agent.name;
      document.getElementById('chatAgentPlatform').textContent = agent.platform;
      
      // 显示弹窗
      document.getElementById('chatModalOverlay').classList.add('show');
      
      // 渲染消息
      renderChatMessages();
      
      // 渲染建议
      renderChatSuggestions();
      
      // 聚焦输入框
      setTimeout(() => {
        document.getElementById('chatInput').focus();
      }, 100);
    }

    function closeChatModal(event) {
      if (!event || event.target === document.getElementById('chatModalOverlay')) {
        document.getElementById('chatModalOverlay').classList.remove('show');
        
        // 保存聊天历史
        if (currentChatAgent) {
          saveChatHistory();
        }
        currentChatAgent = null;
      }
    }

    function renderChatMessages() {
      const container = document.getElementById('chatMessages');
      
      if (chatMessages.length === 0) {
        // 显示欢迎消息
        const greeting = currentChatAgent.greeting || `你好！我是${currentChatAgent.name}，有什么可以帮助你的吗？`;
        container.innerHTML = `
          <div class="welcome-message">
            <div class="welcome-icon">${currentChatAgent.customIcon || currentChatAgent.logo}</div>
            <div class="welcome-title">与 ${currentChatAgent.name} 开始对话</div>
            <div class="welcome-desc">${currentChatAgent.desc || ''}</div>
          </div>
          <div class="chat-message assistant">
            <div class="chat-message-avatar">${currentChatAgent.customIcon || currentChatAgent.logo}</div>
            <div>
              <div class="chat-message-content">${greeting}</div>
              <div class="chat-message-time">${formatTime(new Date())}</div>
            </div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = chatMessages.map(msg => `
        <div class="chat-message ${msg.role}">
          <div class="chat-message-avatar">
            ${msg.role === 'assistant' ? (currentChatAgent.customIcon || currentChatAgent.logo) : '👤'}
          </div>
          <div>
            <div class="chat-message-content">${formatMessageContent(msg.content)}</div>
            <div class="chat-message-time">${formatTime(msg.timestamp)}</div>
          </div>
        </div>
      `).join('');
      
      // 滚动到底部
      container.scrollTop = container.scrollHeight;
    }

    function renderChatSuggestions() {
      const container = document.getElementById('chatSuggestions');
      const suggestions = [
        '介绍一下你自己',
        '你能帮我做什么？',
        '写一段代码示例',
        '解释一个概念'
      ];
      
      container.innerHTML = suggestions.map(s => `
        <div class="chat-suggestion" onclick="useSuggestion('${s}')">${s}</div>
      `).join('');
    }

    function useSuggestion(text) {
      document.getElementById('chatInput').value = text;
      document.getElementById('chatInput').focus();
    }

    function formatMessageContent(content) {
      // 简单的Markdown支持
      return content
        .replace(/\n/g, '<br>')
        .replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\*([^*]+)\*/g, '<em>$1</em>');
    }

    function formatTime(timestamp) {
      const date = timestamp ? new Date(timestamp) : new Date();
      return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    }

    function handleChatKeydown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendChatMessage();
      }
    }

    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message || isAiResponding) return;
      
      // 检查API Key
      const apiKey = getApiKey(currentChatAgent.platformId);
      if (!apiKey) {
        alert(`请先在设置中配置 ${currentChatAgent.platform} 的 API Key`);
        openSettingsModal();
        setTimeout(() => {
          const tab = document.querySelector('[onclick="switchSettingsTab(this, \'api\')"]');
          if (tab) tab.click();
        }, 100);
        return;
      }
      
      // 添加用户消息
      const userMessage = {
        role: 'user',
        content: message,
        timestamp: new Date().toISOString()
      };
      chatMessages.push(userMessage);
      
      // 清空输入框
      input.value = '';
      
      // 隐藏建议
      document.getElementById('chatSuggestions').style.display = 'none';
      
      // 渲染消息
      renderChatMessages();
      
      // 添加加载状态
      isAiResponding = true;
      document.getElementById('chatSendBtn').disabled = true;
      addTypingIndicator();
      
      try {
        // 调用AI接口
        const response = await fetch(buildApiUrl('/api/ai/chat'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            platform: currentChatAgent.platformId,
            apiKey: apiKey,
            model: null, // 使用默认模型
            messages: chatMessages.filter(m => m.role !== 'system').map(m => ({
              role: m.role,
              content: m.content
            })),
            systemPrompt: currentChatAgent.systemPrompt,
            temperature: currentChatAgent.temperature || 0.7,
            maxTokens: parseInt(currentChatAgent.maxTokens) || 2048
          })
        });
        
        const data = await response.json();
        
        // 移除加载状态
        removeTypingIndicator();
        
        if (data.success) {
          // 添加AI回复
          const assistantMessage = {
            role: 'assistant',
            content: data.message,
            timestamp: new Date().toISOString()
          };
          chatMessages.push(assistantMessage);
          
          // 保存聊天历史
          saveChatHistory();
        } else {
          // 显示错误
          const errorMessage = {
            role: 'assistant',
            content: `⚠️ 抱歉，出现了一些问题：${data.message}\n\n请检查您的API Key配置是否正确。`,
            timestamp: new Date().toISOString()
          };
          chatMessages.push(errorMessage);
        }
        
        // 重新渲染消息
        renderChatMessages();
        
      } catch (error) {
        console.error('发送消息失败:', error);
        removeTypingIndicator();
        
        const errorMessage = {
          role: 'assistant',
          content: `⚠️ 网络错误：${error.message}\n\n请检查网络连接后重试。`,
          timestamp: new Date().toISOString()
        };
        chatMessages.push(errorMessage);
        renderChatMessages();
      } finally {
        isAiResponding = false;
        document.getElementById('chatSendBtn').disabled = false;
      }
    }

    function addTypingIndicator() {
      const container = document.getElementById('chatMessages');
      const typingHtml = `
        <div class="chat-message assistant" id="typingIndicator">
          <div class="chat-message-avatar">${currentChatAgent.customIcon || currentChatAgent.logo}</div>
          <div>
            <div class="chat-message-content">
              <div class="chat-typing">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', typingHtml);
      container.scrollTop = container.scrollHeight;
    }

    function removeTypingIndicator() {
      const indicator = document.getElementById('typingIndicator');
      if (indicator) {
        indicator.remove();
      }
    }

    function saveChatHistory() {
      if (!currentChatAgent) return;
      
      let agents;
      if (currentChatAgent.type === 'created') {
        agents = getCreatedAgents();
      } else {
        agents = getPurchasedAgents();
      }
      
      const index = agents.findIndex(a => a.id === currentChatAgent.id);
      if (index !== -1) {
        agents[index].chatHistory = chatMessages;
        if (currentChatAgent.type === 'created') {
          localStorage.setItem('createdAgents', JSON.stringify(agents));
        } else {
          localStorage.setItem('purchasedAgents', JSON.stringify(agents));
        }
      }
    }

    // 获取API Key
    function getApiKey(platformId) {
      const apiKeys = JSON.parse(localStorage.getItem('apiKeys') || '{}');
      return apiKeys[platformId] || '';
    }

    // 保存API Key
    function saveApiKey(platformId, key) {
      const apiKeys = JSON.parse(localStorage.getItem('apiKeys') || '{}');
      apiKeys[platformId] = key;
      localStorage.setItem('apiKeys', JSON.stringify(apiKeys));
    }

    // 搜索过滤模型
    function filterModels(keyword) {
      const cards = document.querySelectorAll('.model-card');
      const lowerKeyword = keyword.toLowerCase();
      
      cards.forEach(card => {
        const modelId = card.dataset.model;
        const config = pageConfig['user-agent'].models.find(m => m.id === modelId);
        const searchText = `${config.name} ${config.desc} ${config.models.join(' ')} ${config.features.join(' ')}`.toLowerCase();
        
        if (searchText.includes(lowerKeyword)) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
    }

    // 按类别筛选
    function filterByCategory(btn, category) {
      // 更新按钮状态
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const cards = document.querySelectorAll('.model-card');
      const models = pageConfig['user-agent'].models;
      
      // 国产模型ID列表
      const chineseModels = ['wenxin', 'qianwen', 'spark', 'glm', 'deepseek', 'moonshot', 'minimax', 'baichuan'];
      // 国际模型ID列表
      const foreignModels = ['openai', 'claude', 'gemini', 'llama'];
      // 开源模型ID列表
      const openSourceModels = ['llama', 'glm', 'deepseek'];

      cards.forEach(card => {
        const modelId = card.dataset.model;
        const model = models.find(m => m.id === modelId);
        let show = false;

        switch(category) {
          case 'all':
            show = true;
            break;
          case 'popular':
            show = model.popular === true;
            break;
          case 'new':
            show = model.isNew === true;
            break;
          case 'chinese':
            show = chineseModels.includes(modelId);
            break;
          case 'foreign':
            show = foreignModels.includes(modelId);
            break;
          case 'opensource':
            show = openSourceModels.includes(modelId);
            break;
        }

        card.style.display = show ? '' : 'none';
      });
    }

    // 切换子菜单
    function toggleSubmenu(element) {
      const menuItem = element.parentElement;
      menuItem.classList.toggle('open');
    }

    // 退出登录
    function logout() {
      sessionStorage.removeItem('user');
      window.location.href = '/';
    }

    // 初始化
    function init() {
      const user = JSON.parse(sessionStorage.getItem('user'));
      if (!user || user.role !== 'user') {
        window.location.href = '/';
        return;
      }

      document.getElementById('userName').textContent = user.username;
      document.getElementById('userAvatar').textContent = user.username.charAt(0).toUpperCase();

      renderMenu();
      renderContent();
    }

    init();

    // ========== 全局搜索功能 ==========
    const searchData = [
      // AI数字员工
      { title: '我的数字员工', desc: '管理AI数字员工', icon: '🤖', page: 'my-digital-worker', category: '功能' },
      { title: '内容选题', desc: 'AI分析热点推荐选题', icon: '📋', page: 'content-topic', category: '功能' },
      { title: '文案编辑', desc: 'AI辅助文案创作', icon: '✍️', page: 'copywriting', category: '功能' },
      { title: '视频剪辑', desc: 'AI智能剪辑视频', icon: '🎬', page: 'video-edit', category: '功能' },
      { title: '视频发布', desc: '一键多平台发布', icon: '📤', page: 'video-publish', category: '功能' },
      { title: '账号授权', desc: '绑定社交媒体账号', icon: '🔗', page: 'account-bindning', category: '功能' },
      { title: '大招聘市场', desc: '发布任务或接单', icon: '💼', page: 'job-market', category: '功能' },
      // 智能体市场
      { title: '官方智能体', desc: '官方认证的智能体市场', icon: '🏆', page: 'official-agent', category: '智能体' },
      { title: '用户智能体', desc: '选择AI模型创建智能体', icon: '👥', page: 'user-agent', category: '智能体' },
      { title: '我购买的智能体', desc: '管理已购买的智能体', icon: '🛒', page: 'my-purchased-agent', category: '智能体' },
      { title: '我创建的智能体', desc: '管理创建的智能体', icon: '🔨', page: 'my-created-agent', category: '智能体' },
      { title: 'GPT-4 智能助手', desc: '基于OpenAI的全能助手', icon: '🌟', page: 'official-agent', category: '官方智能体' },
      { title: 'Claude 写作大师', desc: '专业写作助手', icon: '🟠', page: 'official-agent', category: '官方智能体' },
      { title: '文心知识问答', desc: '中文知识问答专家', icon: '🔵', page: 'official-agent', category: '官方智能体' },
      { title: 'Kimi 文档阅读器', desc: '超长文档处理专家', icon: '🌙', page: 'official-agent', category: '官方智能体' },
      // AI模型
      { title: 'Groq (免费)', desc: '完全免费的超快AI', icon: '⚡', page: 'user-agent', category: 'AI模型' },
      { title: 'OpenAI / GPT-4', desc: '全球领先AI模型', icon: '🌟', page: 'user-agent', category: 'AI模型' },
      { title: 'Claude', desc: 'Anthropic出品', icon: '🟠', page: 'user-agent', category: 'AI模型' },
      { title: '文心一言', desc: '百度出品', icon: '🔵', page: 'user-agent', category: 'AI模型' },
      { title: '通义千问', desc: '阿里云AI', icon: '🟣', page: 'user-agent', category: 'AI模型' },
      { title: 'Kimi / Moonshot', desc: '超长文本处理', icon: '🌙', page: 'user-agent', category: 'AI模型' },
      { title: 'DeepSeek', desc: '代码和数学专精', icon: '🌊', page: 'user-agent', category: 'AI模型' },
      // 工作流
      { title: '官方工作流', desc: '官方认证的工作流', icon: '⚡', page: 'official-workflow', category: '工作流' },
      { title: '用户工作流', desc: '社区分享的工作流', icon: '🔄', page: 'user-workflow', category: '工作流' },
      // 个人中心
      { title: '会员购买', desc: '升级会员享受更多权益', icon: '👑', page: 'vip-purchase', category: '个人中心' },
      { title: '算力豆充值', desc: '充值获取更多使用次数', icon: '🪙', page: 'token-recharge', category: '个人中心' },
      { title: '我的订单', desc: '查看订单记录', icon: '📋', page: 'my-orders', category: '个人中心' },
      { title: '我的收入', desc: '查看收益和提现', icon: '💰', page: 'my-income', category: '个人中心' },
      // 设置
      { title: '个人资料设置', desc: '修改头像和昵称', icon: '👤', action: 'openSettings:profile', category: '设置' },
      { title: '账号安全', desc: '修改密码和安全设置', icon: '🔐', action: 'openSettings:account', category: '设置' },
      { title: '通知设置', desc: '管理消息通知', icon: '🔔', action: 'openSettings:notification', category: '设置' },
      { title: '外观设置', desc: '主题和显示设置', icon: '🎨', action: 'openSettings:appearance', category: '设置' },
    ];

    let searchResultIndex = 0;

    function openSearchModal() {
      document.getElementById('searchModalOverlay').classList.add('show');
      document.getElementById('globalSearchInput').value = '';
      document.getElementById('globalSearchInput').focus();
      renderSearchResults('');
    }

    function closeSearchModal(event) {
      if (!event || event.target === document.getElementById('searchModalOverlay')) {
        document.getElementById('searchModalOverlay').classList.remove('show');
      }
    }

    function handleGlobalSearch(keyword) {
      searchResultIndex = 0;
      renderSearchResults(keyword);
    }

    function renderSearchResults(keyword) {
      const resultsBody = document.getElementById('searchResultsBody');
      const lowerKeyword = keyword.toLowerCase();
      
      let filteredData = searchData;
      if (keyword) {
        filteredData = searchData.filter(item => 
          item.title.toLowerCase().includes(lowerKeyword) ||
          item.desc.toLowerCase().includes(lowerKeyword) ||
          item.category.toLowerCase().includes(lowerKeyword)
        );
      }

      if (filteredData.length === 0) {
        resultsBody.innerHTML = `
          <div class="search-no-result">
            <div class="search-no-result-icon">🔍</div>
            <div>没有找到相关结果</div>
          </div>
        `;
        return;
      }

      // 按分类分组
      const grouped = {};
      filteredData.forEach(item => {
        if (!grouped[item.category]) grouped[item.category] = [];
        grouped[item.category].push(item);
      });

      let html = '';
      let index = 0;
      for (const category in grouped) {
        html += `
          <div class="search-section">
            <div class="search-section-title">${category}</div>
            ${grouped[category].map(item => {
              const activeClass = index === searchResultIndex ? 'active' : '';
              const itemHtml = `
                <div class="search-result-item ${activeClass}" data-index="${index}" onclick="selectSearchResult(${index})">
                  <div class="search-result-icon">${item.icon}</div>
                  <div class="search-result-info">
                    <div class="search-result-title">${highlightKeyword(item.title, keyword)}</div>
                    <div class="search-result-desc">${item.desc}</div>
                  </div>
                  <span class="search-result-tag">${item.category}</span>
                </div>
              `;
              index++;
              return itemHtml;
            }).join('')}
          </div>
        `;
      }
      resultsBody.innerHTML = html;
    }

    function highlightKeyword(text, keyword) {
      if (!keyword) return text;
      const regex = new RegExp(`(${keyword})`, 'gi');
      return text.replace(regex, '<strong style="color: var(--primary);">$1</strong>');
    }

    function selectSearchResult(index) {
      const items = document.querySelectorAll('.search-result-item');
      const item = searchData.filter(item => {
        const keyword = document.getElementById('globalSearchInput').value.toLowerCase();
        return !keyword || 
          item.title.toLowerCase().includes(keyword) ||
          item.desc.toLowerCase().includes(keyword);
      })[index];

      if (item) {
        closeSearchModal();
        if (item.action) {
          const [action, param] = item.action.split(':');
          if (action === 'openSettings') {
            openSettingsModal();
            setTimeout(() => {
              const tab = document.querySelector(`[onclick="switchSettingsTab(this, '${param}')"]`);
              if (tab) tab.click();
            }, 100);
          }
        } else if (item.page) {
          window.location.href = `page.html?page=${item.page}`;
        }
      }
    }

    // 键盘导航
    document.addEventListener('keydown', function(e) {
      // Ctrl+K 打开搜索
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        openSearchModal();
      }
      
      // ESC 关闭弹窗
      if (e.key === 'Escape') {
        closeSearchModal();
        closeSettingsModal();
        closeNotificationModal();
      }

      // 搜索框内的导航
      if (document.getElementById('searchModalOverlay').classList.contains('show')) {
        const items = document.querySelectorAll('.search-result-item');
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          searchResultIndex = Math.min(searchResultIndex + 1, items.length - 1);
          updateSearchSelection();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          searchResultIndex = Math.max(searchResultIndex - 1, 0);
          updateSearchSelection();
        } else if (e.key === 'Enter') {
          e.preventDefault();
          selectSearchResult(searchResultIndex);
        }
      }
    });

    function updateSearchSelection() {
      const items = document.querySelectorAll('.search-result-item');
      items.forEach((item, i) => {
        item.classList.toggle('active', i === searchResultIndex);
      });
      items[searchResultIndex]?.scrollIntoView({ block: 'nearest' });
    }

    // ========== 设置功能 ==========
    const settingsConfig = {
      profile: {
        title: '个人资料',
        content: `
          <div class="settings-section">
            <div class="settings-section-title">基本信息</div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">头像</div>
                <div class="settings-item-desc">点击上传新头像，支持 JPG、PNG 格式</div>
              </div>
              <div class="settings-item-action">
                <div class="avatar-settings">
                  <div class="avatar-preview" id="settingsAvatar">U</div>
                  <div class="avatar-actions">
                    <button class="settings-btn secondary">上传头像</button>
                    <button class="settings-btn secondary">随机头像</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">用户名</div>
                <div class="settings-item-desc">您的唯一标识，其他用户可以看到</div>
              </div>
              <div class="settings-item-action">
                <input type="text" class="settings-input" id="settingsUsername" placeholder="请输入用户名">
              </div>
            </div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">昵称</div>
                <div class="settings-item-desc">展示给其他用户的名称</div>
              </div>
              <div class="settings-item-action">
                <input type="text" class="settings-input" placeholder="请输入昵称">
              </div>
            </div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">个人简介</div>
                <div class="settings-item-desc">介绍一下自己吧</div>
              </div>
              <div class="settings-item-action">
                <input type="text" class="settings-input" placeholder="请输入简介" style="min-width: 300px;">
              </div>
            </div>
          </div>
          <div style="text-align: right; margin-top: 24px;">
            <button class="settings-btn primary" onclick="saveProfileSettings()">保存更改</button>
          </div>
        `
      },
      account: {
        title: '账号安全',
        content: `
          <div class="settings-section">
            <div class="settings-section-title">密码设置</div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">修改密码</div>
                <div class="settings-item-desc">定期修改密码可以提高账号安全性</div>
              </div>
              <div class="settings-item-action">
                <button class="settings-btn secondary" onclick="showChangePasswordDialog()">修改密码</button>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-title">登录安全</div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">两步验证</div>
                <div class="settings-item-desc">开启后登录需要额外验证</div>
              </div>
              <div class="settings-item-action">
                <div class="toggle-switch" onclick="this.classList.toggle('active')"></div>
              </div>
            </div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">登录提醒</div>
                <div class="settings-item-desc">在新设备登录时发送提醒</div>
              </div>
              <div class="settings-item-action">
                <div class="toggle-switch active" onclick="this.classList.toggle('active')"></div>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-title">危险操作</div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">注销账号</div>
                <div class="settings-item-desc">永久删除您的账号和所有数据，此操作不可恢复</div>
              </div>
              <div class="settings-item-action">
                <button class="settings-btn danger">注销账号</button>
              </div>
            </div>
          </div>
        `
      },
      notification: {
        title: '通知设置',
        content: `
          <div class="settings-section">
            <div class="settings-section-title">消息通知</div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">系统通知</div>
                <div class="settings-item-desc">接收系统公告和重要通知</div>
              </div>
              <div class="settings-item-action">
                <div class="toggle-switch active" onclick="this.classList.toggle('active')"></div>
              </div>
            </div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">任务通知</div>
                <div class="settings-item-desc">任务完成、失败等状态更新</div>
              </div>
              <div class="settings-item-action">
                <div class="toggle-switch active" onclick="this.classList.toggle('active')"></div>
              </div>
            </div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">订单通知</div>
                <div class="settings-item-desc">订单状态变更通知</div>
              </div>
              <div class="settings-item-action">
                <div class="toggle-switch active" onclick="this.classList.toggle('active')"></div>
              </div>
            </div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">营销通知</div>
                <div class="settings-item-desc">优惠活动和推广信息</div>
              </div>
              <div class="settings-item-action">
                <div class="toggle-switch" onclick="this.classList.toggle('active')"></div>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-title">通知方式</div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">浏览器通知</div>
                <div class="settings-item-desc">通过浏览器推送通知</div>
              </div>
              <div class="settings-item-action">
                <div class="toggle-switch" onclick="this.classList.toggle('active')"></div>
              </div>
            </div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">邮件通知</div>
                <div class="settings-item-desc">通过邮件发送重要通知</div>
              </div>
              <div class="settings-item-action">
                <div class="toggle-switch active" onclick="this.classList.toggle('active')"></div>
              </div>
            </div>
          </div>
        `
      },
      appearance: {
        title: '外观设置',
        content: `
          <div class="settings-section">
            <div class="settings-section-title">主题设置</div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">颜色主题</div>
                <div class="settings-item-desc">选择您喜欢的界面配色</div>
              </div>
              <div class="settings-item-action">
                <select class="settings-select">
                  <option value="light">浅色模式</option>
                  <option value="dark">深色模式</option>
                  <option value="auto">跟随系统</option>
                </select>
              </div>
            </div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">主题色</div>
                <div class="settings-item-desc">自定义系统主题颜色</div>
              </div>
              <div class="settings-item-action">
                <select class="settings-select">
                  <option value="blue">科技蓝</option>
                  <option value="green">清新绿</option>
                  <option value="purple">优雅紫</option>
                  <option value="orange">活力橙</option>
                </select>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-title">显示设置</div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">字体大小</div>
                <div class="settings-item-desc">调整界面文字大小</div>
              </div>
              <div class="settings-item-action">
                <select class="settings-select">
                  <option value="small">小</option>
                  <option value="medium" selected>中</option>
                  <option value="large">大</option>
                </select>
              </div>
            </div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">侧边栏收起</div>
                <div class="settings-item-desc">默认折叠侧边栏菜单</div>
              </div>
              <div class="settings-item-action">
                <div class="toggle-switch" onclick="this.classList.toggle('active')"></div>
              </div>
            </div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">动画效果</div>
                <div class="settings-item-desc">开启界面过渡动画</div>
              </div>
              <div class="settings-item-action">
                <div class="toggle-switch active" onclick="this.classList.toggle('active')"></div>
              </div>
            </div>
          </div>
        `
      },
      about: {
        title: '关于系统',
        content: `
          <div class="settings-section">
            <div class="settings-section-title">系统信息</div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">系统名称</div>
                <div class="settings-item-desc">智能体管理平台</div>
              </div>
            </div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">当前版本</div>
                <div class="settings-item-desc">v1.0.0</div>
              </div>
              <div class="settings-item-action">
                <button class="settings-btn secondary">检查更新</button>
              </div>
            </div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">服务状态</div>
                <div class="settings-item-desc" style="color: var(--success);">● 正常运行</div>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-title">帮助支持</div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">使用文档</div>
                <div class="settings-item-desc">查看系统使用指南和常见问题</div>
              </div>
              <div class="settings-item-action">
                <button class="settings-btn secondary">查看文档</button>
              </div>
            </div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">联系客服</div>
                <div class="settings-item-desc">遇到问题？联系我们的客服团队</div>
              </div>
              <div class="settings-item-action">
                <button class="settings-btn secondary">在线客服</button>
              </div>
            </div>
            <div class="settings-item">
              <div class="settings-item-info">
                <div class="settings-item-label">反馈建议</div>
                <div class="settings-item-desc">帮助我们改进产品</div>
              </div>
              <div class="settings-item-action">
                <button class="settings-btn secondary">提交反馈</button>
              </div>
            </div>
          </div>
        `
      }
    };

    function openSettingsModal() {
      document.getElementById('settingsModalOverlay').classList.add('show');
      switchSettingsTab(document.querySelector('.settings-nav-item.active'), 'profile');
      // 更新头像
      const user = JSON.parse(sessionStorage.getItem('user'));
      if (user) {
        const avatar = document.getElementById('settingsAvatar');
        if (avatar) avatar.textContent = user.username.charAt(0).toUpperCase();
        const usernameInput = document.getElementById('settingsUsername');
        if (usernameInput) usernameInput.value = user.username;
      }
    }

    function closeSettingsModal(event) {
      if (!event || event.target === document.getElementById('settingsModalOverlay')) {
        document.getElementById('settingsModalOverlay').classList.remove('show');
      }
    }

    function switchSettingsTab(element, tab) {
      document.querySelectorAll('.settings-nav-item').forEach(item => item.classList.remove('active'));
      element.classList.add('active');
      
      const config = settingsConfig[tab];
      document.getElementById('settingsContent').innerHTML = config.content;
      
      // 更新用户信息
      if (tab === 'profile') {
        const user = JSON.parse(sessionStorage.getItem('user'));
        if (user) {
          document.getElementById('settingsAvatar').textContent = user.username.charAt(0).toUpperCase();
          document.getElementById('settingsUsername').value = user.username;
        }
      }
    }

    function saveProfileSettings() {
      alert('✅ 个人资料已保存！');
    }

    function showChangePasswordDialog() {
      alert('修改密码功能开发中...');
    }

    // ========== 通知功能 ==========
    const notifications = [
      { id: 1, type: '系统通知', icon: '🔔', content: '欢迎使用智能体管理平台！开始探索AI的无限可能。', time: '刚刚', unread: true },
      { id: 2, type: '任务完成', icon: '✅', content: '您的视频剪辑任务已完成，点击查看结果。', time: '5分钟前', unread: true },
      { id: 3, type: '订单通知', icon: '📦', content: '您购买的「GPT-4 智能助手」已激活成功。', time: '1小时前', unread: false },
      { id: 4, type: '系统更新', icon: '🆕', content: '系统已更新至 v1.0.0，新增多项功能。', time: '昨天', unread: false },
    ];

    function openNotificationModal() {
      document.getElementById('notificationModalOverlay').classList.add('show');
      renderNotifications();
    }

    function closeNotificationModal(event) {
      if (!event || event.target === document.getElementById('notificationModalOverlay')) {
        document.getElementById('notificationModalOverlay').classList.remove('show');
      }
    }

    function renderNotifications() {
      const list = document.getElementById('notificationList');
      if (notifications.length === 0) {
        list.innerHTML = `
          <div class="notification-empty">
            <div style="font-size: 3rem; margin-bottom: 12px;">📭</div>
            <div>暂无新消息</div>
          </div>
        `;
        return;
      }

      list.innerHTML = notifications.map(n => `
        <div class="notification-item ${n.unread ? 'unread' : ''}" onclick="readNotification(${n.id})">
          <div class="notification-item-header">
            <span class="notification-icon">${n.icon}</span>
            <span class="notification-type">${n.type}</span>
            <span class="notification-time">${n.time}</span>
          </div>
          <div class="notification-content">${n.content}</div>
        </div>
      `).join('');
    }

    function readNotification(id) {
      const notification = notifications.find(n => n.id === id);
      if (notification) {
        notification.unread = false;
        renderNotifications();
      }
    }

    function clearAllNotifications() {
      notifications.forEach(n => n.unread = false);
      renderNotifications();
    }

    // ========== 数字人模块 ==========
    
    // 获取用户创建的智能体列表
    function getAgentOptions() {
      const agents = JSON.parse(localStorage.getItem('createdAgents') || '[]');
      return agents;
    }
    
    // 获取数字人列表
    function getDigitalHumans() {
      return JSON.parse(localStorage.getItem('digitalHumans') || '[]');
    }
    
    // 保存数字人列表
    function saveDigitalHumans(humans) {
      localStorage.setItem('digitalHumans', JSON.stringify(humans));
    }
    
    // 检查并更新超时的数字人（超过5分钟仍在处理中则标记为失败）
    function checkAndUpdateTimeoutDigitalHumans() {
      const TIMEOUT_MS = 5 * 60 * 1000; // 5分钟超时
      const humans = getDigitalHumans();
      const videos = getGeneratedVideos();
      let humansUpdated = false;
      let videosUpdated = false;
      
      humans.forEach(h => {
        if (h.status === 'processing') {
          const createTime = new Date(h.createDate).getTime();
          const elapsed = Date.now() - createTime;
          
          if (elapsed > TIMEOUT_MS) {
            h.status = 'failed';
            h.error = '生成超时，请重试（超过5分钟未完成）';
            humansUpdated = true;
            
            // 同时更新关联的视频
            videos.forEach(v => {
              if (v.digitalHumanId === h.id && v.status === 'processing') {
                v.status = 'failed';
                v.error = '生成超时';
                videosUpdated = true;
              }
            });
          }
        }
      });
      
      // 检查独立的视频任务
      videos.forEach(v => {
        if (v.status === 'processing') {
          const createTime = new Date(v.createDate).getTime();
          const elapsed = Date.now() - createTime;
          
          if (elapsed > TIMEOUT_MS) {
            v.status = 'failed';
            v.error = '生成超时，请重试（超过5分钟未完成）';
            videosUpdated = true;
          }
        }
      });
      
      if (humansUpdated) {
        saveDigitalHumans(humans);
      }
      if (videosUpdated) {
        saveGeneratedVideos(videos);
      }
    }
    
    // 渲染创建数字人页面
    function renderDigitalHumanCreate(config) {
      const agents = getAgentOptions();
      
      document.getElementById('contentArea').innerHTML = `
        <div class="page-header">
          <div class="page-title">
            <div class="page-title-icon ${config.iconColor}">${config.icon}</div>
            ${config.title}
          </div>
          <div class="page-desc">${config.desc}</div>
        </div>
        
        <div class="dh-create-container">
          <!-- 步骤指示器 -->
          <div class="dh-steps">
            <div class="dh-step active" data-step="1">
              <div class="dh-step-num">1</div>
              <div class="dh-step-text">上传素材</div>
            </div>
            <div class="dh-step-line"></div>
            <div class="dh-step" data-step="2">
              <div class="dh-step-num">2</div>
              <div class="dh-step-text">选择智能体</div>
            </div>
            <div class="dh-step-line"></div>
            <div class="dh-step" data-step="3">
              <div class="dh-step-num">3</div>
              <div class="dh-step-text">生成数字人</div>
            </div>
          </div>
          
          <!-- 步骤1：上传素材 -->
          <div class="dh-step-content active" id="dhStep1">
            <h3 class="dh-section-title">📁 上传素材</h3>
            <p class="dh-section-desc">上传您的视频、图片或音频素材，AI将学习您的形象和声音</p>
            
            <div class="dh-upload-grid">
              <!-- 视频上传 -->
              <div class="dh-upload-card" onclick="triggerUpload('video')">
                <input type="file" id="uploadVideo" accept="video/*" onchange="handleFileUpload(this, 'video')" style="display: none;">
                <div class="dh-upload-icon">🎬</div>
                <div class="dh-upload-title">上传视频</div>
                <div class="dh-upload-desc">支持 MP4、MOV、AVI 格式<br>建议时长 1-5 分钟</div>
                <div class="dh-upload-hint">或拖拽文件到此处</div>
                <div class="dh-upload-preview" id="videoPreview"></div>
              </div>
              
              <!-- 图片上传 -->
              <div class="dh-upload-card" onclick="triggerUpload('image')">
                <input type="file" id="uploadImage" accept="image/*" onchange="handleFileUpload(this, 'image')" style="display: none;">
                <div class="dh-upload-icon">🖼️</div>
                <div class="dh-upload-title">上传图片</div>
                <div class="dh-upload-desc">支持 JPG、PNG、WEBP 格式<br>建议正面清晰照片</div>
                <div class="dh-upload-hint">或拖拽文件到此处</div>
                <div class="dh-upload-preview" id="imagePreview"></div>
              </div>
              
              <!-- 音频上传 -->
              <div class="dh-upload-card" onclick="triggerUpload('audio')">
                <input type="file" id="uploadAudio" accept="audio/*" onchange="handleFileUpload(this, 'audio')" style="display: none;">
                <div class="dh-upload-icon">🎤</div>
                <div class="dh-upload-title">上传音频</div>
                <div class="dh-upload-desc">支持 MP3、WAV、M4A 格式<br>建议时长 30秒-2分钟</div>
                <div class="dh-upload-hint">或拖拽文件到此处</div>
                <div class="dh-upload-preview" id="audioPreview"></div>
              </div>
              
              <!-- 录制功能 -->
              <div class="dh-upload-card record" onclick="openRecordModal()">
                <div class="dh-upload-icon">📹</div>
                <div class="dh-upload-title">录制视频/音频</div>
                <div class="dh-upload-desc">使用摄像头和麦克风<br>实时录制您的形象和声音</div>
                <div class="dh-upload-hint">点击开始录制</div>
              </div>
            </div>
            
            <!-- 样本素材区域 -->
            <div class="dh-sample-section">
              <div class="dh-sample-divider">
                <span>或使用样本素材</span>
              </div>
              
              <div class="dh-sample-tabs">
                <button class="dh-sample-tab active" data-type="all" onclick="filterSamples('all')">全部</button>
                <button class="dh-sample-tab" data-type="video" onclick="filterSamples('video')">🎬 视频</button>
                <button class="dh-sample-tab" data-type="photo" onclick="filterSamples('photo')">📷 照片</button>
                <button class="dh-sample-tab" data-type="audio" onclick="filterSamples('audio')">🎤 音频</button>
              </div>
              
              <div class="dh-sample-grid" id="sampleGrid">
                <!-- 样本将由JS动态生成 -->
              </div>
            </div>
            
            <div class="dh-btn-group">
              <button class="dh-btn primary" onclick="goToStep(2)" id="btnStep1Next" disabled>
                下一步：选择智能体 →
              </button>
            </div>
          </div>
          
          <!-- 步骤2：选择智能体 -->
          <div class="dh-step-content" id="dhStep2">
            <h3 class="dh-section-title">🤖 选择AI智能体</h3>
            <p class="dh-section-desc">选择一个您创建的智能体，赋予数字人AI能力</p>
            
            ${agents.length === 0 ? `
              <div class="dh-empty-agent">
                <div class="dh-empty-icon">🔧</div>
                <div class="dh-empty-title">暂无可用智能体</div>
                <div class="dh-empty-desc">请先创建一个智能体，然后回来继续创建数字人</div>
                <button class="dh-btn primary" onclick="window.location.href='page.html?page=user-agent'">
                  去创建智能体
                </button>
              </div>
            ` : `
              <div class="dh-agent-grid">
                ${agents.map(agent => `
                  <div class="dh-agent-card" data-agent-id="${agent.id}" onclick="selectAgent('${agent.id}')">
                    <div class="dh-agent-logo" style="background: ${agent.color}15;">${agent.logo}</div>
                    <div class="dh-agent-info">
                      <div class="dh-agent-name">${agent.name}</div>
                      <div class="dh-agent-platform">${agent.platform}</div>
                    </div>
                    <div class="dh-agent-check">✓</div>
                  </div>
                `).join('')}
              </div>
            `}
            
            <div class="dh-btn-group">
              <button class="dh-btn secondary" onclick="goToStep(1)">← 上一步</button>
              <button class="dh-btn primary" onclick="goToStep(3)" id="btnStep2Next" disabled>
                下一步：生成数字人 →
              </button>
            </div>
          </div>
          
          <!-- 步骤3：配置并生成 -->
          <div class="dh-step-content" id="dhStep3">
            <h3 class="dh-section-title">✨ 配置数字人</h3>
            <p class="dh-section-desc">为您的数字人设置名称和个性化参数</p>
            
            <div class="dh-config-form">
              <div class="dh-form-group">
                <label class="dh-form-label">数字人名称</label>
                <input type="text" class="dh-form-input" id="dhName" placeholder="给您的数字人起个名字">
              </div>
              
              <div class="dh-form-group">
                <label class="dh-form-label">数字人简介</label>
                <textarea class="dh-form-textarea" id="dhDesc" placeholder="描述数字人的特点和用途"></textarea>
              </div>
              
              <div class="dh-form-group">
                <label class="dh-form-label">选择形象风格</label>
                <div class="dh-style-grid">
                  <div class="dh-style-item selected" data-style="natural" onclick="selectStyle('natural')">
                    <span>🎯</span> 自然风格
                  </div>
                  <div class="dh-style-item" data-style="professional" onclick="selectStyle('professional')">
                    <span>👔</span> 专业商务
                  </div>
                  <div class="dh-style-item" data-style="casual" onclick="selectStyle('casual')">
                    <span>😊</span> 轻松亲切
                  </div>
                  <div class="dh-style-item" data-style="energetic" onclick="selectStyle('energetic')">
                    <span>🔥</span> 活力四射
                  </div>
                </div>
              </div>
            </div>
            
            <div class="dh-btn-group">
              <button class="dh-btn secondary" onclick="goToStep(2)">← 上一步</button>
              <button class="dh-btn primary generate" onclick="generateDigitalHuman()">
                🚀 生成数字人
              </button>
            </div>
          </div>
        </div>
      `;
      
      initUploadDragDrop();
      // 延迟渲染样本，确保DOM已更新
      setTimeout(function() {
        renderSampleGrid();
      }, 100);
    }
    
    // 数字人创建相关变量（提前定义）
    let uploadedFiles = { video: null, image: null, audio: null };
    let selectedAgentId = null;
    let selectedStyle = 'natural';
    let selectedSampleId = null;
    
    // 样本素材数据（提前定义）
    const sampleAssets = [
      // 视频样本
      {
        id: 'video_01',
        type: 'video',
        name: '商务男士 - 李明',
        gender: 'male',
        avatar: '👨‍💼',
        duration: '02:30',
        desc: '专业商务风格，适合企业宣传',
        tag: 'hot',
        style: 'professional'
      },
      {
        id: 'video_02',
        type: 'video',
        name: '活力女主播 - 小雨',
        gender: 'female',
        avatar: '👩‍🎤',
        duration: '03:15',
        desc: '活泼开朗，适合带货直播',
        tag: 'hot',
        style: 'energetic'
      },
      {
        id: 'video_03',
        type: 'video',
        name: '温柔讲师 - 王老师',
        gender: 'female',
        avatar: '👩‍🏫',
        duration: '04:00',
        desc: '亲切自然，适合教育培训',
        tag: 'new',
        style: 'natural'
      },
      {
        id: 'video_04',
        type: 'video',
        name: '科技达人 - 张峰',
        gender: 'male',
        avatar: '👨‍💻',
        duration: '02:45',
        desc: '科技感强，适合产品评测',
        style: 'casual'
      },
      // 照片样本
      {
        id: 'photo_01',
        type: 'photo',
        name: '职业女性 - 林雪',
        gender: 'female',
        avatar: '👩‍💼',
        desc: '正装形象，适合金融保险',
        tag: 'hot',
        style: 'professional'
      },
      {
        id: 'photo_02',
        type: 'photo',
        name: '阳光男孩 - 陈浩',
        gender: 'male',
        avatar: '🧑',
        desc: '年轻阳光，适合时尚潮流',
        tag: 'new',
        style: 'casual'
      },
      {
        id: 'photo_03',
        type: 'photo',
        name: '知性女士 - 刘芳',
        gender: 'female',
        avatar: '👩',
        desc: '知性优雅，适合美妆护肤',
        style: 'natural'
      },
      {
        id: 'photo_04',
        type: 'photo',
        name: '成熟男士 - 赵总',
        gender: 'male',
        avatar: '🧔',
        desc: '稳重成熟，适合企业高管',
        style: 'professional'
      },
      {
        id: 'photo_05',
        type: 'photo',
        name: '甜美女生 - 小萌',
        gender: 'female',
        avatar: '👧',
        desc: '甜美可爱，适合美食零食',
        tag: 'hot',
        style: 'energetic'
      },
      // 音频样本
      {
        id: 'audio_01',
        type: 'audio',
        name: '磁性男声 - 大伟',
        gender: 'male',
        avatar: '🎙️',
        duration: '00:45',
        desc: '低沉磁性，适合品牌广告',
        tag: 'hot',
        style: 'professional'
      },
      {
        id: 'audio_02',
        type: 'audio',
        name: '甜美女声 - 小美',
        gender: 'female',
        avatar: '🎤',
        duration: '00:30',
        desc: '甜美活泼，适合年轻品牌',
        tag: 'new',
        style: 'energetic'
      },
      {
        id: 'audio_03',
        type: 'audio',
        name: '温暖男声 - 阿杰',
        gender: 'male',
        avatar: '🎧',
        duration: '00:50',
        desc: '温暖治愈，适合情感内容',
        style: 'natural'
      },
      {
        id: 'audio_04',
        type: 'audio',
        name: '专业女声 - 晓晓',
        gender: 'female',
        avatar: '📻',
        duration: '00:40',
        desc: '标准播音，适合新闻资讯',
        style: 'professional'
      }
    ];
    
    // 渲染样本网格
    function renderSampleGrid(filter = 'all') {
      const grid = document.getElementById('sampleGrid');
      if (!grid) return;
      
      let samples = sampleAssets;
      if (filter !== 'all') {
        samples = sampleAssets.filter(s => s.type === filter);
      }
      
      grid.innerHTML = samples.map(sample => {
        const typeLabel = sample.type === 'video' ? '🎬 视频' : sample.type === 'photo' ? '📷 照片' : '🎤 音频';
        const genderIcon = sample.gender === 'male' ? '♂️' : '♀️';
        const tagHtml = sample.tag ? '<span class="dh-sample-tag ' + sample.tag + '">' + (sample.tag === 'hot' ? '🔥热门' : '✨新') + '</span>' : '';
        const durationHtml = sample.duration ? '<div class="dh-sample-duration">' + sample.duration + '</div>' : '';
        const selectedClass = selectedSampleId === sample.id ? 'selected' : '';
        
        return '<div class="dh-sample-card ' + selectedClass + '" data-sample-id="' + sample.id + '" onclick="selectSample(\'' + sample.id + '\')">' +
          '<div class="dh-sample-preview">' +
            '<div class="dh-sample-preview-icon">' + sample.avatar + '</div>' +
            '<div class="dh-sample-type-badge">' + typeLabel + '</div>' +
            durationHtml +
            '<div class="dh-sample-check">✓</div>' +
          '</div>' +
          '<div class="dh-sample-info">' +
            '<div class="dh-sample-name">' + sample.name + '</div>' +
            '<div class="dh-sample-meta">' +
              '<span class="dh-sample-gender">' + genderIcon + ' ' + (sample.gender === 'male' ? '男' : '女') + '</span>' +
              tagHtml +
            '</div>' +
          '</div>' +
        '</div>';
      }).join('');
    }
    
    // 筛选样本
    function filterSamples(type) {
      document.querySelectorAll('.dh-sample-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.type === type);
      });
      renderSampleGrid(type);
    }
    
    // 选择样本
    function selectSample(sampleId) {
      const sample = sampleAssets.find(s => s.id === sampleId);
      if (!sample) return;
      
      // 切换选中状态
      if (selectedSampleId === sampleId) {
        selectedSampleId = null;
        // 清除上传文件
        uploadedFiles = { video: null, image: null, audio: null };
        document.getElementById('videoPreview').style.display = 'none';
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('audioPreview').style.display = 'none';
      } else {
        selectedSampleId = sampleId;
        
        // 根据类型设置上传文件（模拟）
        uploadedFiles = { video: null, image: null, audio: null };
        if (sample.type === 'video') {
          uploadedFiles.video = { name: '样本_' + sample.name + '.mp4', isSample: true, sampleId: sampleId };
          document.getElementById('videoPreview').innerHTML = '<div class="dh-file-uploaded">✅ 样本: ' + sample.name + '</div>';
          document.getElementById('videoPreview').style.display = 'block';
          document.getElementById('imagePreview').style.display = 'none';
          document.getElementById('audioPreview').style.display = 'none';
        } else if (sample.type === 'photo') {
          uploadedFiles.image = { name: '样本_' + sample.name + '.jpg', isSample: true, sampleId: sampleId };
          document.getElementById('imagePreview').innerHTML = '<div class="dh-file-uploaded">✅ 样本: ' + sample.name + '</div>';
          document.getElementById('imagePreview').style.display = 'block';
          document.getElementById('videoPreview').style.display = 'none';
          document.getElementById('audioPreview').style.display = 'none';
        } else {
          uploadedFiles.audio = { name: '样本_' + sample.name + '.mp3', isSample: true, sampleId: sampleId };
          document.getElementById('audioPreview').innerHTML = '<div class="dh-file-uploaded">✅ 样本: ' + sample.name + '</div>';
          document.getElementById('audioPreview').style.display = 'block';
          document.getElementById('videoPreview').style.display = 'none';
          document.getElementById('imagePreview').style.display = 'none';
        }
        
        // 自动设置风格
        selectedStyle = sample.style;
      }
      
      // 更新UI
      document.querySelectorAll('.dh-sample-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.sampleId === selectedSampleId);
      });
      
      checkStep1Complete();
    }
    
    function triggerUpload(type) {
      document.getElementById('upload' + type.charAt(0).toUpperCase() + type.slice(1)).click();
    }
    
    function handleFileUpload(input, type) {
      const file = input.files[0];
      if (file) {
        uploadedFiles[type] = file;
        const previewEl = document.getElementById(type + 'Preview');
        previewEl.innerHTML = `<div class="dh-file-uploaded">✅ ${file.name}</div>`;
        previewEl.style.display = 'block';
        
        // 检查是否可以进入下一步
        checkStep1Complete();
      }
    }
    
    function checkStep1Complete() {
      const hasFile = uploadedFiles.video || uploadedFiles.image || uploadedFiles.audio || selectedSampleId;
      const btn = document.getElementById('btnStep1Next');
      if (btn) {
        btn.disabled = !hasFile;
      }
      // 调试信息
      console.log('步骤1检查:', {
        hasFile: hasFile,
        video: uploadedFiles.video ? uploadedFiles.video.name : null,
        image: uploadedFiles.image ? uploadedFiles.image.name : null,
        audio: uploadedFiles.audio ? uploadedFiles.audio.name : null,
        sampleId: selectedSampleId
      });
    }
    
    function selectAgent(agentId) {
      selectedAgentId = agentId;
      document.querySelectorAll('.dh-agent-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.agentId === agentId);
      });
      const btn = document.getElementById('btnStep2Next');
      if (btn) {
        btn.disabled = false;
      }
      // 调试信息
      console.log('步骤2 - 选择智能体:', {
        agentId: selectedAgentId
      });
    }
    
    function selectStyle(style) {
      selectedStyle = style;
      document.querySelectorAll('.dh-style-item').forEach(item => {
        item.classList.toggle('selected', item.dataset.style === style);
      });
    }
    
    function goToStep(step) {
      document.querySelectorAll('.dh-step').forEach((el, idx) => {
        el.classList.toggle('active', idx < step);
        el.classList.toggle('completed', idx < step - 1);
      });
      document.querySelectorAll('.dh-step-content').forEach((el, idx) => {
        el.classList.toggle('active', idx === step - 1);
      });
    }
    
    function initUploadDragDrop() {
      document.querySelectorAll('.dh-upload-card').forEach(card => {
        if (card.classList.contains('record')) return;
        
        card.addEventListener('dragover', (e) => {
          e.preventDefault();
          card.classList.add('dragover');
        });
        
        card.addEventListener('dragleave', () => {
          card.classList.remove('dragover');
        });
        
        card.addEventListener('drop', (e) => {
          e.preventDefault();
          card.classList.remove('dragover');
          const input = card.querySelector('input[type="file"]');
          if (input && e.dataTransfer.files.length > 0) {
            input.files = e.dataTransfer.files;
            input.dispatchEvent(new Event('change'));
          }
        });
      });
    }
    
    // ========== 录制功能 ==========
    let mediaStream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let recordingMode = 'video'; // video, photo, audio
    let recordingStartTime = null;
    let recordingTimer = null;
    let audioContext = null;
    let analyser = null;
    let recordedBlob = null;
    
    function openRecordModal() {
      document.getElementById('recordModalOverlay').classList.add('show');
      resetRecordingState();
    }
    
    function closeRecordModal(event) {
      if (!event || event.target === document.getElementById('recordModalOverlay')) {
        document.getElementById('recordModalOverlay').classList.remove('show');
        stopCamera();
        resetRecordingState();
      }
    }
    
    function resetRecordingState() {
      recordedChunks = [];
      recordedBlob = null;
      
      // 重置UI
      document.getElementById('recordResult').style.display = 'none';
      document.getElementById('recordTimer').style.display = 'none';
      document.getElementById('capturedPhoto').style.display = 'none';
      document.getElementById('previewPlaceholder').style.display = 'flex';
      document.getElementById('recordPreview').style.display = 'none';
      
      // 重置按钮
      updateRecordButtons('initial');
    }
    
    function switchRecordMode(mode) {
      recordingMode = mode;
      
      // 更新标签样式
      document.querySelectorAll('.record-mode-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.mode === mode);
      });
      
      // 停止当前设备
      stopCamera();
      resetRecordingState();
      
      // 更新UI显示
      const previewContainer = document.querySelector('.record-preview-container');
      const audioVisualizer = document.getElementById('audioVisualizer');
      
      if (mode === 'audio') {
        previewContainer.style.display = 'none';
        audioVisualizer.style.display = 'block';
        document.getElementById('btnStartCamera').style.display = 'none';
        document.getElementById('btnStartMic').style.display = 'inline-block';
      } else {
        previewContainer.style.display = 'block';
        audioVisualizer.style.display = 'none';
        document.getElementById('btnStartCamera').style.display = 'inline-block';
        document.getElementById('btnStartMic').style.display = 'none';
      }
      
      // 更新占位符图标
      const placeholder = document.getElementById('previewPlaceholder');
      if (mode === 'video') {
        placeholder.innerHTML = '<div class="record-preview-icon">🎬</div><div>点击下方按钮开启摄像头</div>';
      } else if (mode === 'photo') {
        placeholder.innerHTML = '<div class="record-preview-icon">📷</div><div>点击下方按钮开启摄像头</div>';
      } else {
        placeholder.innerHTML = '<div class="record-preview-icon">🎤</div><div>点击下方按钮开启麦克风</div>';
      }
    }
    
    async function startCamera() {
      try {
        const constraints = {
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: 'user'
          },
          audio: recordingMode === 'video'
        };
        
        mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        const videoEl = document.getElementById('recordPreview');
        videoEl.srcObject = mediaStream;
        videoEl.style.display = 'block';
        document.getElementById('previewPlaceholder').style.display = 'none';
        
        updateRecordButtons('camera-ready');
        
      } catch (error) {
        console.error('无法访问摄像头:', error);
        alert('❌ 无法访问摄像头\n\n请确保：\n1. 已授权浏览器使用摄像头\n2. 没有其他程序占用摄像头\n3. 设备有可用的摄像头');
      }
    }
    
    async function startMicrophone() {
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // 设置音频可视化
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        const source = audioContext.createMediaStreamSource(mediaStream);
        source.connect(analyser);
        analyser.fftSize = 256;
        
        document.getElementById('previewPlaceholder').style.display = 'none';
        visualizeAudio();
        
        updateRecordButtons('mic-ready');
        
      } catch (error) {
        console.error('无法访问麦克风:', error);
        alert('❌ 无法访问麦克风\n\n请确保：\n1. 已授权浏览器使用麦克风\n2. 设备有可用的麦克风');
      }
    }
    
    function visualizeAudio() {
      if (!analyser) return;
      
      const canvas = document.getElementById('audioCanvas');
      const ctx = canvas.getContext('2d');
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      
      function draw() {
        if (!analyser) return;
        requestAnimationFrame(draw);
        
        analyser.getByteFrequencyData(dataArray);
        
        ctx.fillStyle = '#1a1a2e';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        const barWidth = (canvas.width / bufferLength) * 2.5;
        let x = 0;
        
        for (let i = 0; i < bufferLength; i++) {
          const barHeight = (dataArray[i] / 255) * canvas.height;
          
          const gradient = ctx.createLinearGradient(0, canvas.height - barHeight, 0, canvas.height);
          gradient.addColorStop(0, '#1890ff');
          gradient.addColorStop(1, '#722ed1');
          
          ctx.fillStyle = gradient;
          ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
          x += barWidth + 1;
        }
      }
      
      draw();
    }
    
    function stopCamera() {
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
      }
      
      if (audioContext) {
        audioContext.close();
        audioContext = null;
        analyser = null;
      }
      
      const videoEl = document.getElementById('recordPreview');
      videoEl.srcObject = null;
      videoEl.style.display = 'none';
      
      if (recordingTimer) {
        clearInterval(recordingTimer);
        recordingTimer = null;
      }
      
      document.getElementById('previewPlaceholder').style.display = 'flex';
      updateRecordButtons('initial');
    }
    
    function startRecording() {
      if (!mediaStream) return;
      
      recordedChunks = [];
      
      const mimeType = recordingMode === 'audio' ? 'audio/webm' : 'video/webm';
      const options = { mimeType };
      
      try {
        mediaRecorder = new MediaRecorder(mediaStream, options);
      } catch (e) {
        mediaRecorder = new MediaRecorder(mediaStream);
      }
      
      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      };
      
      mediaRecorder.onstop = () => {
        const mimeType = recordingMode === 'audio' ? 'audio/webm' : 'video/webm';
        recordedBlob = new Blob(recordedChunks, { type: mimeType });
        showRecordingResult();
      };
      
      mediaRecorder.start();
      recordingStartTime = Date.now();
      
      // 开始计时
      document.getElementById('recordTimer').style.display = 'flex';
      recordingTimer = setInterval(updateRecordTime, 1000);
      
      updateRecordButtons('recording');
    }
    
    function updateRecordTime() {
      const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
      const seconds = (elapsed % 60).toString().padStart(2, '0');
      document.getElementById('recordTime').textContent = `${minutes}:${seconds}`;
    }
    
    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
      }
      
      if (recordingTimer) {
        clearInterval(recordingTimer);
        recordingTimer = null;
      }
      
      document.getElementById('recordTimer').style.display = 'none';
    }
    
    function capturePhoto() {
      const video = document.getElementById('recordPreview');
      const canvas = document.getElementById('recordCanvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      
      // 转换为Blob
      canvas.toBlob((blob) => {
        recordedBlob = blob;
        
        // 显示拍摄的照片
        const img = document.getElementById('capturedPhoto');
        img.src = URL.createObjectURL(blob);
        img.style.display = 'block';
        video.style.display = 'none';
        
        showRecordingResult();
      }, 'image/jpeg', 0.95);
    }
    
    function showRecordingResult() {
      const result = document.getElementById('recordResult');
      const info = document.getElementById('recordResultInfo');
      
      let infoText = '';
      if (recordingMode === 'video') {
        const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
        infoText = `视频时长: ${Math.floor(duration / 60)}分${duration % 60}秒 | 大小: ${(recordedBlob.size / 1024 / 1024).toFixed(2)} MB`;
      } else if (recordingMode === 'photo') {
        infoText = `照片大小: ${(recordedBlob.size / 1024).toFixed(2)} KB`;
      } else {
        const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
        infoText = `音频时长: ${Math.floor(duration / 60)}分${duration % 60}秒 | 大小: ${(recordedBlob.size / 1024).toFixed(2)} KB`;
      }
      
      info.textContent = infoText;
      result.style.display = 'block';
      
      updateRecordButtons('recorded');
    }
    
    function retakeRecording() {
      resetRecordingState();
      
      // 重新开启设备
      if (recordingMode === 'audio') {
        startMicrophone();
      } else {
        startCamera();
      }
    }
    
    function useRecording() {
      if (!recordedBlob) {
        alert('没有可用的录制内容');
        return;
      }
      
      // 创建文件对象
      let fileName, fileType;
      if (recordingMode === 'video') {
        fileName = `录制视频_${Date.now()}.webm`;
        fileType = 'video';
        uploadedFiles.video = new File([recordedBlob], fileName, { type: 'video/webm' });
        document.getElementById('videoPreview').innerHTML = `<div class="dh-file-uploaded">✅ ${fileName}</div>`;
        document.getElementById('videoPreview').style.display = 'block';
      } else if (recordingMode === 'photo') {
        fileName = `拍摄照片_${Date.now()}.jpg`;
        fileType = 'image';
        uploadedFiles.image = new File([recordedBlob], fileName, { type: 'image/jpeg' });
        document.getElementById('imagePreview').innerHTML = `<div class="dh-file-uploaded">✅ ${fileName}</div>`;
        document.getElementById('imagePreview').style.display = 'block';
      } else {
        fileName = `录制音频_${Date.now()}.webm`;
        fileType = 'audio';
        uploadedFiles.audio = new File([recordedBlob], fileName, { type: 'audio/webm' });
        document.getElementById('audioPreview').innerHTML = `<div class="dh-file-uploaded">✅ ${fileName}</div>`;
        document.getElementById('audioPreview').style.display = 'block';
      }
      
      // 检查是否可以进入下一步
      checkStep1Complete();
      
      // 关闭模态框
      closeRecordModal();
      
      alert(`✅ ${recordingMode === 'video' ? '视频' : recordingMode === 'photo' ? '照片' : '音频'}已保存！`);
    }
    
    function updateRecordButtons(state) {
      const btnStartCamera = document.getElementById('btnStartCamera');
      const btnStartMic = document.getElementById('btnStartMic');
      const btnStopCamera = document.getElementById('btnStopCamera');
      const btnStartRecord = document.getElementById('btnStartRecord');
      const btnStopRecord = document.getElementById('btnStopRecord');
      const btnCapturePhoto = document.getElementById('btnCapturePhoto');
      
      // 隐藏所有按钮
      [btnStartCamera, btnStartMic, btnStopCamera, btnStartRecord, btnStopRecord, btnCapturePhoto].forEach(btn => {
        btn.style.display = 'none';
      });
      
      switch (state) {
        case 'initial':
          if (recordingMode === 'audio') {
            btnStartMic.style.display = 'inline-block';
          } else {
            btnStartCamera.style.display = 'inline-block';
          }
          break;
          
        case 'camera-ready':
          btnStopCamera.style.display = 'inline-block';
          if (recordingMode === 'video') {
            btnStartRecord.style.display = 'inline-block';
          } else if (recordingMode === 'photo') {
            btnCapturePhoto.style.display = 'inline-block';
          }
          break;
          
        case 'mic-ready':
          btnStopCamera.style.display = 'inline-block';
          btnStartRecord.style.display = 'inline-block';
          break;
          
        case 'recording':
          btnStopRecord.style.display = 'inline-block';
          break;
          
        case 'recorded':
          // 录制完成后按钮由结果区域处理
          break;
      }
    }
    
    async function generateDigitalHuman() {
      var name = document.getElementById('dhName').value.trim();
      var desc = document.getElementById('dhDesc').value.trim();
      
      // 调试：显示当前状态
      console.log('=== 创建数字人 - 当前状态 ===');
      console.log('名称:', name);
      console.log('描述:', desc);
      console.log('风格:', selectedStyle);
      console.log('智能体ID:', selectedAgentId);
      console.log('样本ID:', selectedSampleId);
      console.log('上传文件:', uploadedFiles);
      
      // 验证名称
      if (!name) {
        alert('❌ 创建失败\n\n请输入数字人名称');
        return;
      }
      
      // 验证是否有素材
      var hasFile = uploadedFiles.video || uploadedFiles.image || uploadedFiles.audio || selectedSampleId;
      console.log('是否有素材:', hasFile);
      
      if (!hasFile) {
        alert('❌ 创建失败\n\n请先上传素材或选择样本素材\n\n调试信息:\n- 视频: ' + (uploadedFiles.video ? '有' : '无') + '\n- 图片: ' + (uploadedFiles.image ? '有' : '无') + '\n- 音频: ' + (uploadedFiles.audio ? '有' : '无') + '\n- 样本: ' + (selectedSampleId || '无'));
        return;
      }
      
      // 验证是否选择了智能体
      if (!selectedAgentId) {
        alert('❌ 创建失败\n\n请选择一个AI智能体\n\n请在第二步选择您创建的智能体');
        return;
      }
      
      // 检查智能体是否存在
      var agents = getAgentOptions();
      console.log('可用智能体:', agents);
      
      var selectedAgent = agents.find(function(a) { return a.id === selectedAgentId; });
      if (!selectedAgent) {
        alert('❌ 创建失败\n\n选择的智能体不存在，请重新选择\n\n智能体ID: ' + selectedAgentId);
        return;
      }
      
      console.log('选中的智能体:', selectedAgent);
      
      // 获取样本信息（如果有）
      var sampleInfo = '';
      if (selectedSampleId) {
        var sample = sampleAssets.find(function(s) { return s.id === selectedSampleId; });
        if (sample) {
          sampleInfo = '\n• 样本: ' + sample.name + ' (' + sample.type + ')';
        }
      }
      
      // 获取上传文件信息
      var fileInfo = '';
      if (uploadedFiles.video) fileInfo += '\n• 视频: ' + uploadedFiles.video.name;
      if (uploadedFiles.image) fileInfo += '\n• 图片: ' + uploadedFiles.image.name;
      if (uploadedFiles.audio) fileInfo += '\n• 音频: ' + uploadedFiles.audio.name;
      
      // 显示确认信息
      var confirmMsg = '请确认数字人信息：\n\n' +
        '📝 名称: ' + name + '\n' +
        '📄 描述: ' + (desc || '无') + '\n' +
        '🎨 风格: ' + selectedStyle + '\n' +
        '🤖 智能体: ' + selectedAgent.name + '\n' +
        '📁 素材:' + (fileInfo || sampleInfo || ' 无') +
        '\n\n确定要创建吗？';
      
      if (!confirm(confirmMsg)) {
        return;
      }
      
      var dhId = 'dh_' + Date.now();
      var videoId = 'video_' + Date.now();
      
      // 获取智能体的完整信息（包括API Key）
      var createdAgents = JSON.parse(localStorage.getItem('createdAgents') || '[]');
      var fullAgent = createdAgents.find(function(a) { return a.id === selectedAgentId; });
      
      if (!fullAgent || !fullAgent.apiKey) {
        alert('❌ 创建失败\n\n选择的智能体未配置 API Key\n\n请先编辑智能体，添加 API Key 后再试');
        return;
      }
      
      // 显示加载状态
      var loadingOverlay = document.createElement('div');
      loadingOverlay.id = 'aiLoadingOverlay';
      loadingOverlay.innerHTML = `
        <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10000;">
          <div style="background:#1a1a2e;padding:40px;border-radius:16px;text-align:center;max-width:400px;">
            <div style="font-size:48px;margin-bottom:20px;">🤖</div>
            <div style="font-size:20px;color:#fff;margin-bottom:10px;">AI正在生成数字人...</div>
            <div style="color:#888;font-size:14px;margin-bottom:20px;">正在使用 ${fullAgent.name} 分析素材并创建人设</div>
            <div style="display:flex;justify-content:center;gap:8px;">
              <div style="width:12px;height:12px;background:#1890ff;border-radius:50%;animation:pulse 1s infinite;"></div>
              <div style="width:12px;height:12px;background:#1890ff;border-radius:50%;animation:pulse 1s infinite 0.2s;"></div>
              <div style="width:12px;height:12px;background:#1890ff;border-radius:50%;animation:pulse 1s infinite 0.4s;"></div>
            </div>
          </div>
        </div>
        <style>
          @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
          }
        </style>
      `;
      document.body.appendChild(loadingOverlay);
      
      try {
        // 构建AI提示词
        var materialInfo = '';
        if (uploadedFiles.video) materialInfo += '- 视频素材: ' + uploadedFiles.video.name + '\n';
        if (uploadedFiles.image) materialInfo += '- 图片素材: ' + uploadedFiles.image.name + '\n';
        if (uploadedFiles.audio) materialInfo += '- 音频素材: ' + uploadedFiles.audio.name + '\n';
        if (selectedSampleId) {
          var sample = sampleAssets.find(function(s) { return s.id === selectedSampleId; });
          if (sample) {
            materialInfo += '- 样本素材: ' + sample.name + ' (' + sample.desc + ')\n';
          }
        }
        
        var styleDesc = {
          'professional': '专业正式，适合商务场景',
          'friendly': '亲切友好，适合日常交流',
          'energetic': '活力四射，适合年轻受众',
          'elegant': '优雅知性，适合高端品牌'
        };
        
        var aiPrompt = `你是一个数字人人设设计专家。请根据以下信息，为数字人设计一个完整的人设。

【数字人基本信息】
- 名称: ${name}
- 用户描述: ${desc || '无特殊描述'}
- 风格定位: ${selectedStyle} (${styleDesc[selectedStyle] || '通用风格'})

【素材信息】
${materialInfo || '未提供素材'}

请按以下JSON格式输出数字人人设（直接输出JSON，不要有其他文字）：
{
  "personality": "性格特点描述（50字以内）",
  "voiceStyle": "说话风格描述（30字以内）",
  "expertise": ["专长领域1", "专长领域2", "专长领域3"],
  "greeting": "数字人的开场白（50字以内）",
  "catchphrase": "口头禅或标志性语句",
  "background": "背景故事（100字以内）"
}`;

        // 获取平台ID
        var platformId = fullAgent.platformId || getPlatformIdFromModel(fullAgent.platform);
        
        console.log('调用AI生成数字人人设...', {
          platform: platformId,
          model: fullAgent.model,
          agentName: fullAgent.name
        });
        
        // 调用AI接口
        var response = await fetch(buildApiUrl('/api/ai/chat'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            platform: platformId,
            apiKey: fullAgent.apiKey,
            messages: [{ role: 'user', content: aiPrompt }],
            systemPrompt: '你是一个专业的数字人设计师，擅长根据需求创建独特的数字人人设。请直接输出JSON格式的结果。',
            temperature: 0.8,
            maxTokens: 1024
          })
        });
        
        var data = await response.json();
        
        // 移除加载状态
        var overlay = document.getElementById('aiLoadingOverlay');
        if (overlay) overlay.remove();
        
        if (!data.success) {
          throw new Error(data.message || 'AI生成失败');
        }
        
        // 解析AI返回的人设
        var aiResponse = data.message;
        var persona = null;
        
        try {
          // 尝试提取JSON
          var jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            persona = JSON.parse(jsonMatch[0]);
          }
        } catch (e) {
          console.warn('解析AI响应失败，使用默认人设', e);
        }
        
        // 如果解析失败，使用默认人设
        if (!persona) {
          persona = {
            personality: '热情、专业、值得信赖',
            voiceStyle: '亲切自然，条理清晰',
            expertise: ['产品介绍', '客户服务', '内容创作'],
            greeting: '你好！我是' + name + '，很高兴见到你！',
            catchphrase: '让我来帮你解决这个问题',
            background: '我是一个AI数字人，专注于为用户提供优质的服务体验。'
          };
        }
        
        console.log('AI生成的人设:', persona);
        
        // 创建数字人对象
        var digitalHuman = {
          id: dhId,
          name: name,
          desc: desc,
          style: selectedStyle,
          agentId: selectedAgentId,
          agentName: selectedAgent.name,
          sampleId: selectedSampleId,
          files: {
            video: uploadedFiles.video ? uploadedFiles.video.name : null,
            image: uploadedFiles.image ? uploadedFiles.image.name : null,
            audio: uploadedFiles.audio ? uploadedFiles.audio.name : null
          },
          // AI生成的人设
          persona: persona,
          aiGenerated: true,
          createDate: new Date().toISOString(),
          status: 'ready'  // AI生成完成后直接设为ready
        };
        
        // 保存数字人
        var humans = getDigitalHumans();
        humans.push(digitalHuman);
        saveDigitalHumans(humans);
        
        // 同时创建一个数字人生成视频记录
        var video = {
          id: videoId,
          type: 'digital-human',
          title: '数字人生成 - ' + name,
          status: 'ready',
          duration: '00:' + (15 + Math.floor(Math.random() * 30)).toString().padStart(2, '0'),
          createDate: new Date().toISOString(),
          digitalHumanId: dhId
        };
        addGeneratedVideo(video);
        
        // 显示成功信息
        alert('🎉 数字人创建成功！\n\n' +
          '【' + name + '】\n\n' +
          '📝 性格: ' + persona.personality + '\n' +
          '🎙️ 风格: ' + persona.voiceStyle + '\n' +
          '💬 开场白: ' + persona.greeting + '\n\n' +
          '点击确定查看详情');
        
        // 跳转到列表页
        window.location.href = 'page.html?page=digital-human-list';
        
      } catch (error) {
        // 移除加载状态
        var overlay = document.getElementById('aiLoadingOverlay');
        if (overlay) overlay.remove();
        
        console.error('创建数字人失败:', error);
        
        // 提供更详细的错误信息
        var errorMsg = '❌ AI生成数字人失败\n\n';
        if (error.message.includes('Invalid') || error.message.includes('auth')) {
          errorMsg += '原因: API Key 无效或已过期\n\n请检查智能体的 API Key 配置';
        } else if (error.message.includes('balance') || error.message.includes('quota')) {
          errorMsg += '原因: API 余额不足\n\n请充值后重试';
        } else if (error.message.includes('network') || error.message.includes('timeout')) {
          errorMsg += '原因: 网络连接失败\n\n请检查网络后重试';
        } else {
          errorMsg += '原因: ' + error.message + '\n\n请稍后重试';
        }
        
        alert(errorMsg);
      }
    }
    
    // 根据平台名称获取平台ID
    function getPlatformIdFromModel(platformName) {
      var mapping = {
        'Groq (免费)': 'groq',
        'Groq': 'groq',
        'OpenAI': 'openai',
        'Claude': 'claude',
        '文心一言': 'wenxin',
        '通义千问': 'qianwen',
        'Kimi': 'moonshot',
        'DeepSeek': 'deepseek',
        '讯飞星火': 'spark',
        'ChatGLM': 'glm',
        '智谱AI/GLM': 'glm',
        '智谱AI': 'glm',
        'Gemini': 'gemini'
      };
      return mapping[platformName] || 'groq';
    }
    
    // 渲染数字人列表页面
    function renderDigitalHumanList(config) {
      // 首先检查并更新超时的数字人
      checkAndUpdateTimeoutDigitalHumans();
      
      const humans = getDigitalHumans();
      
      if (humans.length === 0) {
        document.getElementById('contentArea').innerHTML = `
          <div class="page-header">
            <div class="page-title">
              <div class="page-title-icon ${config.iconColor}">${config.icon}</div>
              ${config.title}
            </div>
            <div class="page-desc">${config.desc}</div>
          </div>
          <div class="empty-state">
            <div class="empty-state-icon">👤</div>
            <div class="empty-state-title">暂无数字人</div>
            <div class="empty-state-desc">创建您的专属数字人，让AI为您代言</div>
            <button class="empty-state-btn" onclick="window.location.href='page.html?page=digital-human-create'">创建数字人</button>
          </div>
        `;
        return;
      }
      
      const agents = getAgentOptions();
      
      const humansHtml = humans.map(h => {
        const agent = agents.find(a => a.id === h.agentId);
        let statusText, statusClass, progressInfo = '';
        
        if (h.status === 'ready') {
          statusText = '✅ 可用';
          statusClass = 'ready';
        } else if (h.status === 'failed') {
          statusText = '❌ 失败';
          statusClass = 'failed';
        } else {
          // 计算处理时间
          const createTime = new Date(h.createDate).getTime();
          const now = Date.now();
          const elapsedSeconds = Math.floor((now - createTime) / 1000);
          const elapsedMinutes = Math.floor(elapsedSeconds / 60);
          
          if (elapsedMinutes < 1) {
            progressInfo = `（已等待 ${elapsedSeconds} 秒）`;
          } else {
            progressInfo = `（已等待 ${elapsedMinutes} 分钟）`;
          }
          
          statusText = '⏳ 处理中';
          statusClass = 'processing';
        }
        
        // 根据状态显示不同的操作按钮
        let actionsHtml = '';
        if (h.status === 'ready') {
          actionsHtml = `
            <button class="dh-action-btn primary" onclick="useDigitalHuman('${h.id}')">使用</button>
            <button class="dh-action-btn" onclick="editDigitalHuman('${h.id}')">编辑</button>
          `;
        } else if (h.status === 'failed') {
          actionsHtml = `
            <button class="dh-action-btn primary" onclick="retryDigitalHuman('${h.id}')">重试</button>
          `;
        } else {
          // 处理中状态也可以刷新或取消
          actionsHtml = `
            <button class="dh-action-btn" onclick="location.reload()">刷新状态</button>
          `;
        }
        
        // 失败信息
        const errorHtml = h.error ? `<div class="dh-list-error">⚠️ ${h.error}</div>` : '';
        
        // AI生成的人设信息
        let personaHtml = '';
        if (h.persona && h.aiGenerated) {
          personaHtml = `
            <div class="dh-persona-info">
              <div class="dh-persona-badge">🤖 AI生成</div>
              <div class="dh-persona-item"><strong>性格:</strong> ${h.persona.personality || '未设定'}</div>
              <div class="dh-persona-item"><strong>风格:</strong> ${h.persona.voiceStyle || '未设定'}</div>
              ${h.persona.catchphrase ? `<div class="dh-persona-item"><strong>口头禅:</strong> "${h.persona.catchphrase}"</div>` : ''}
            </div>
          `;
        }
        
        return `
          <div class="dh-list-card ${h.status === 'failed' ? 'failed' : ''} ${h.aiGenerated ? 'ai-generated' : ''}">
            <div class="dh-list-avatar">${h.aiGenerated ? '🤖' : '👤'}</div>
            <div class="dh-list-info">
              <div class="dh-list-name">${h.name}</div>
              <div class="dh-list-desc">${h.desc || (h.persona ? h.persona.greeting : '暂无简介')}</div>
              ${personaHtml}
              ${errorHtml}
              <div class="dh-list-meta">
                <span class="dh-list-agent">${agent ? agent.name : (h.agentName || '未关联智能体')}</span>
                <span class="dh-list-date">创建于 ${formatDate(h.createDate)}</span>
              </div>
            </div>
            <div class="dh-list-status ${statusClass}">${statusText} <small style="opacity:0.7">${progressInfo}</small></div>
            <div class="dh-list-actions">
              ${actionsHtml}
              ${h.persona ? `<button class="dh-action-btn" onclick="viewPersona('${h.id}')">人设</button>` : ''}
              <button class="dh-action-btn danger" onclick="deleteDigitalHuman('${h.id}')">删除</button>
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('contentArea').innerHTML = `
        <div class="page-header">
          <div class="page-title">
            <div class="page-title-icon ${config.iconColor}">${config.icon}</div>
            ${config.title}
          </div>
          <div class="page-desc">${config.desc}</div>
        </div>
        
        <div style="margin-bottom: 24px;">
          <button class="dh-btn primary" onclick="window.location.href='page.html?page=digital-human-create'">
            ➕ 创建新数字人
          </button>
        </div>
        
        <div class="dh-list-container">
          ${humansHtml}
        </div>
      `;
    }
    
    function useDigitalHuman(id) {
      window.location.href = 'page.html?page=digital-human-product&dhId=' + id;
    }
    
    function editDigitalHuman(id) {
      alert('编辑功能开发中...');
    }
    
    // 查看数字人人设详情
    function viewPersona(id) {
      var humans = getDigitalHumans();
      var human = humans.find(function(h) { return h.id === id; });
      
      if (!human || !human.persona) {
        alert('未找到人设信息');
        return;
      }
      
      var p = human.persona;
      var expertiseList = p.expertise ? p.expertise.join('、') : '未设定';
      
      var modal = document.createElement('div');
      modal.id = 'personaModal';
      modal.innerHTML = `
        <div class="persona-modal-overlay" onclick="closePersonaModal()">
          <div class="persona-modal" onclick="event.stopPropagation()">
            <div class="persona-modal-header">
              <div class="persona-modal-title">🤖 ${human.name} 的人设</div>
              <button class="persona-modal-close" onclick="closePersonaModal()">×</button>
            </div>
            <div class="persona-modal-body">
              <div class="persona-section">
                <div class="persona-label">📝 性格特点</div>
                <div class="persona-value">${p.personality || '未设定'}</div>
              </div>
              <div class="persona-section">
                <div class="persona-label">🎙️ 说话风格</div>
                <div class="persona-value">${p.voiceStyle || '未设定'}</div>
              </div>
              <div class="persona-section">
                <div class="persona-label">💡 专长领域</div>
                <div class="persona-value">${expertiseList}</div>
              </div>
              <div class="persona-section">
                <div class="persona-label">👋 开场白</div>
                <div class="persona-value highlight">"${p.greeting || '未设定'}"</div>
              </div>
              <div class="persona-section">
                <div class="persona-label">💬 口头禅</div>
                <div class="persona-value">"${p.catchphrase || '未设定'}"</div>
              </div>
              <div class="persona-section">
                <div class="persona-label">📖 背景故事</div>
                <div class="persona-value">${p.background || '未设定'}</div>
              </div>
            </div>
            <div class="persona-modal-footer">
              <button class="dh-btn" onclick="closePersonaModal()">关闭</button>
              <button class="dh-btn primary" onclick="chatWithDigitalHuman('${id}')">与TA对话</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    function closePersonaModal() {
      var modal = document.getElementById('personaModal');
      if (modal) modal.remove();
    }
    
    // 与数字人对话
    function chatWithDigitalHuman(dhId) {
      var humans = getDigitalHumans();
      var human = humans.find(function(h) { return h.id === dhId; });
      
      if (!human) {
        alert('数字人不存在');
        return;
      }
      
      // 跳转到与关联智能体的对话页面，并带上数字人信息
      if (human.agentId) {
        closePersonaModal();
        // 存储数字人信息供对话页面使用
        sessionStorage.setItem('digitalHumanContext', JSON.stringify({
          id: human.id,
          name: human.name,
          persona: human.persona
        }));
        window.location.href = 'chat.html?id=' + human.agentId + '&type=created&dh=' + dhId;
      } else {
        alert('此数字人未关联智能体，无法对话');
      }
    }
    
    // 重试生成数字人
    function retryDigitalHuman(id) {
      var humans = getDigitalHumans();
      var idx = humans.findIndex(function(h) { return h.id === id; });
      
      if (idx === -1) {
        alert('数字人不存在');
        return;
      }
      
      // 更新状态为处理中
      humans[idx].status = 'processing';
      humans[idx].error = null;
      saveDigitalHumans(humans);
      
      // 更新相关视频状态
      var videos = getGeneratedVideos();
      videos.forEach(function(v) {
        if (v.digitalHumanId === id) {
          v.status = 'processing';
          v.error = null;
        }
      });
      saveGeneratedVideos(videos);
      
      alert('🔄 重试任务已提交！\n\n系统正在重新处理素材...');
      
      // 模拟重新处理
      setTimeout(function() {
        var updatedHumans = getDigitalHumans();
        var humanIdx = updatedHumans.findIndex(function(h) { return h.id === id; });
        
        if (humanIdx !== -1) {
          updatedHumans[humanIdx].status = 'ready';
          saveDigitalHumans(updatedHumans);
        }
        
        var updatedVideos = getGeneratedVideos();
        updatedVideos.forEach(function(v) {
          if (v.digitalHumanId === id) {
            v.status = 'ready';
            v.duration = '00:' + (15 + Math.floor(Math.random() * 30)).toString().padStart(2, '0');
          }
        });
        saveGeneratedVideos(updatedVideos);
        
        // 如果当前在列表页，刷新显示
        if (window.location.href.includes('digital-human-list')) {
          renderDigitalHumanList(pageConfig['digital-human-list']);
        }
      }, 3000);
      
      renderDigitalHumanList(pageConfig['digital-human-list']);
    }
    
    function deleteDigitalHuman(id) {
      if (confirm('确定要删除这个数字人吗？\n\n注意：相关的生成视频也会被删除。')) {
        // 删除数字人
        var humans = getDigitalHumans();
        var filtered = humans.filter(function(h) { return h.id !== id; });
        saveDigitalHumans(filtered);
        
        // 同时删除相关的视频
        var videos = getGeneratedVideos();
        var filteredVideos = videos.filter(function(v) { return v.digitalHumanId !== id; });
        saveGeneratedVideos(filteredVideos);
        
        renderDigitalHumanList(pageConfig['digital-human-list']);
      }
    }
    
    // 渲染商品讲解页面
    function renderDigitalHumanProduct(config) {
      const humans = getDigitalHumans().filter(h => h.status === 'ready');
      const urlParams = new URLSearchParams(window.location.search);
      const preselectedDhId = urlParams.get('dhId');
      
      document.getElementById('contentArea').innerHTML = `
        <div class="page-header">
          <div class="page-title">
            <div class="page-title-icon ${config.iconColor}">${config.icon}</div>
            ${config.title}
          </div>
          <div class="page-desc">${config.desc}</div>
        </div>
        
        <div class="dh-product-container">
          <div class="dh-product-left">
            <h3 class="dh-section-title">👤 选择数字人</h3>
            ${humans.length === 0 ? `
              <div class="dh-empty-mini">
                <p>暂无可用数字人</p>
                <a href="page.html?page=digital-human-create">去创建</a>
              </div>
            ` : `
              <div class="dh-select-list">
                ${humans.map(h => `
                  <div class="dh-select-item ${preselectedDhId === h.id ? 'selected' : ''}" 
                       data-dh-id="${h.id}" onclick="selectDigitalHumanForProduct('${h.id}')">
                    <span class="dh-select-avatar">👤</span>
                    <span class="dh-select-name">${h.name}</span>
                  </div>
                `).join('')}
              </div>
            `}
            
            <h3 class="dh-section-title" style="margin-top: 24px;">🛒 上传商品</h3>
            <div class="dh-product-upload" onclick="document.getElementById('productImageInput').click()">
              <input type="file" id="productImageInput" accept="image/*" onchange="handleProductImageUpload(this)" style="display: none;">
              <div id="productImagePreview" class="dh-product-preview">
                <div class="dh-upload-icon">📦</div>
                <div>点击上传商品图片</div>
              </div>
            </div>
            
            <div class="dh-form-group" style="margin-top: 16px;">
              <label class="dh-form-label">商品名称</label>
              <input type="text" class="dh-form-input" id="productName" placeholder="输入商品名称">
            </div>
            
            <div class="dh-form-group">
              <label class="dh-form-label">商品描述 / 讲解要点</label>
              <textarea class="dh-form-textarea" id="productDesc" placeholder="输入商品卖点、特色功能等，AI将据此生成讲解文案"></textarea>
            </div>
          </div>
          
          <div class="dh-product-right">
            <h3 class="dh-section-title">👁️ 预览效果</h3>
            <div class="dh-preview-area">
              <div class="dh-preview-placeholder">
                <div style="font-size: 4rem;">👤</div>
                <p>选择数字人和商品后<br>预览效果将在此显示</p>
              </div>
            </div>
            
            <div class="dh-generate-actions">
              <button class="dh-btn secondary" onclick="generateProductScript()">
                📝 生成讲解文案
              </button>
              <button class="dh-btn primary generate" onclick="generateProductVideo()">
                🎬 生成讲解视频
              </button>
            </div>
          </div>
        </div>
      `;
      
      if (preselectedDhId) {
        selectedDhIdForProduct = preselectedDhId;
      }
    }
    
    let selectedDhIdForProduct = null;
    let productImageFile = null;
    
    function selectDigitalHumanForProduct(dhId) {
      selectedDhIdForProduct = dhId;
      document.querySelectorAll('.dh-select-item').forEach(item => {
        item.classList.toggle('selected', item.dataset.dhId === dhId);
      });
    }
    
    function handleProductImageUpload(input) {
      const file = input.files[0];
      if (file) {
        productImageFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('productImagePreview').innerHTML = `
            <img src="${e.target.result}" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
          `;
        };
        reader.readAsDataURL(file);
      }
    }
    
    function generateProductScript() {
      const productName = document.getElementById('productName').value.trim();
      const productDesc = document.getElementById('productDesc').value.trim();
      
      if (!productName) {
        alert('请输入商品名称');
        return;
      }
      
      alert('📝 正在使用AI生成讲解文案...\n\n功能开发中，即将支持：\n• 自动生成商品卖点\n• 多种风格文案\n• 一键复制');
    }
    
    function generateProductVideo() {
      if (!selectedDhIdForProduct) {
        alert('请先选择一个数字人');
        return;
      }
      
      var productName = document.getElementById('productName').value.trim();
      var productDesc = document.getElementById('productDesc').value.trim();
      
      if (!productName) {
        alert('请输入商品名称');
        return;
      }
      
      // 获取数字人信息
      var humans = getDigitalHumans();
      var digitalHuman = humans.find(function(h) { return h.id === selectedDhIdForProduct; });
      var greeting = digitalHuman && digitalHuman.persona ? digitalHuman.persona.greeting : '大家好！';
      
      // 生成商品讲解文案
      var scriptContent = `${greeting}

今天给大家介绍一款超棒的产品——${productName}！

${productDesc ? productDesc + '\n\n' : ''}这款产品有以下几大亮点：
• 品质卓越，值得信赖
• 性价比超高，物超所值
• 深受用户好评

喜欢的朋友们不要错过哦！现在下单还有优惠！`;
      
      // 创建视频记录
      var video = {
        id: 'video_' + Date.now(),
        type: 'product',
        title: '商品讲解 - ' + productName,
        status: 'processing',
        duration: '--:--',
        createDate: new Date().toISOString(),
        digitalHumanId: selectedDhIdForProduct,
        productName: productName,
        productDesc: productDesc,
        scriptContent: scriptContent  // 保存讲解文案供播放时使用
      };
      
      // 添加到视频列表
      addGeneratedVideo(video);
      
      // 模拟3秒后完成处理
      setTimeout(function() {
        var videos = getGeneratedVideos();
        var idx = videos.findIndex(function(v) { return v.id === video.id; });
        if (idx !== -1) {
          videos[idx].status = 'ready';
          videos[idx].duration = '01:' + Math.floor(Math.random() * 60).toString().padStart(2, '0');
          saveGeneratedVideos(videos);
        }
      }, 3000);
      
      alert('🎬 视频生成任务已提交！\n\n系统正在生成数字人商品讲解视频，预计需要 3-5 分钟。\n完成后将在"生成视频"页面中显示。');
      
      window.location.href = 'page.html?page=digital-human-video';
    }
    
    // 渲染文案朗读页面
    function renderDigitalHumanScript(config) {
      const humans = getDigitalHumans().filter(h => h.status === 'ready');
      
      document.getElementById('contentArea').innerHTML = `
        <div class="page-header">
          <div class="page-title">
            <div class="page-title-icon ${config.iconColor}">${config.icon}</div>
            ${config.title}
          </div>
          <div class="page-desc">${config.desc}</div>
        </div>
        
        <div class="dh-script-container">
          <div class="dh-script-left">
            <h3 class="dh-section-title">👤 选择数字人</h3>
            ${humans.length === 0 ? `
              <div class="dh-empty-mini">
                <p>暂无可用数字人</p>
                <a href="page.html?page=digital-human-create">去创建</a>
              </div>
            ` : `
              <div class="dh-select-list">
                ${humans.map(h => `
                  <div class="dh-select-item" data-dh-id="${h.id}" onclick="selectDigitalHumanForScript('${h.id}')">
                    <span class="dh-select-avatar">👤</span>
                    <span class="dh-select-name">${h.name}</span>
                  </div>
                `).join('')}
              </div>
            `}
            
            <h3 class="dh-section-title" style="margin-top: 24px;">📝 输入文案</h3>
            <textarea class="dh-script-textarea" id="scriptContent" placeholder="输入您希望数字人朗读的文案内容...&#10;&#10;支持多段落，每段会自动处理停顿和语气。"></textarea>
            
            <div class="dh-script-options">
              <div class="dh-form-group">
                <label class="dh-form-label">语速</label>
                <select class="dh-form-select" id="scriptSpeed">
                  <option value="slow">慢速</option>
                  <option value="normal" selected>正常</option>
                  <option value="fast">快速</option>
                </select>
              </div>
              <div class="dh-form-group">
                <label class="dh-form-label">情感</label>
                <select class="dh-form-select" id="scriptEmotion">
                  <option value="neutral">平静</option>
                  <option value="happy" selected>愉悦</option>
                  <option value="serious">严肃</option>
                  <option value="excited">激动</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="dh-script-right">
            <h3 class="dh-section-title">👁️ 预览</h3>
            <div class="dh-preview-area">
              <div class="dh-preview-placeholder">
                <div style="font-size: 4rem;">🎤</div>
                <p>数字人将朗读您的文案<br>视频预览将在此显示</p>
              </div>
            </div>
            
            <div class="dh-generate-actions">
              <button class="dh-btn secondary" onclick="previewScript()">
                🔊 试听文案
              </button>
              <button class="dh-btn primary generate" onclick="generateScriptVideo()">
                🎬 生成朗读视频
              </button>
            </div>
          </div>
        </div>
      `;
    }
    
    let selectedDhIdForScript = null;
    
    function selectDigitalHumanForScript(dhId) {
      selectedDhIdForScript = dhId;
      document.querySelectorAll('.dh-select-item').forEach(item => {
        item.classList.toggle('selected', item.dataset.dhId === dhId);
      });
    }
    
    // 预览语音实例
    var previewUtterance = null;
    var isPreviewPlaying = false;
    
    function previewScript() {
      const content = document.getElementById('scriptContent').value.trim();
      if (!content) {
        alert('请先输入文案内容');
        return;
      }
      
      // 检查浏览器是否支持语音合成
      if (!('speechSynthesis' in window)) {
        alert('您的浏览器不支持语音合成功能');
        return;
      }
      
      // 如果正在播放，则停止
      if (isPreviewPlaying) {
        window.speechSynthesis.cancel();
        isPreviewPlaying = false;
        updatePreviewButton(false);
        return;
      }
      
      // 获取语速和情感设置
      var speed = document.getElementById('scriptSpeed').value;
      var emotion = document.getElementById('scriptEmotion').value;
      
      var rateMap = { slow: 0.8, normal: 1.0, fast: 1.2 };
      var pitchMap = { neutral: 1.0, happy: 1.1, serious: 0.9, excited: 1.2 };
      
      // 创建语音实例
      previewUtterance = new SpeechSynthesisUtterance(content);
      previewUtterance.lang = 'zh-CN';
      previewUtterance.rate = rateMap[speed] || 1.0;
      previewUtterance.pitch = pitchMap[emotion] || 1.0;
      previewUtterance.volume = 1.0;
      
      // 尝试选择中文语音
      var voices = window.speechSynthesis.getVoices();
      var chineseVoice = voices.find(function(v) { 
        return v.lang.includes('zh') || v.lang.includes('CN'); 
      });
      if (chineseVoice) {
        previewUtterance.voice = chineseVoice;
      }
      
      // 语音结束事件
      previewUtterance.onend = function() {
        isPreviewPlaying = false;
        updatePreviewButton(false);
      };
      
      previewUtterance.onerror = function() {
        isPreviewPlaying = false;
        updatePreviewButton(false);
      };
      
      // 开始朗读
      window.speechSynthesis.speak(previewUtterance);
      isPreviewPlaying = true;
      updatePreviewButton(true);
    }
    
    function updatePreviewButton(isPlaying) {
      var buttons = document.querySelectorAll('.dh-btn.secondary');
      buttons.forEach(function(btn) {
        if (btn.textContent.includes('试听') || btn.textContent.includes('停止')) {
          btn.innerHTML = isPlaying ? '⏹ 停止试听' : '🔊 试听文案';
        }
      });
    }
    
    function generateScriptVideo() {
      if (!selectedDhIdForScript) {
        alert('请先选择一个数字人');
        return;
      }
      
      var content = document.getElementById('scriptContent').value.trim();
      if (!content) {
        alert('请输入文案内容');
        return;
      }
      
      // 截取文案前20个字作为标题
      var titlePreview = content.length > 20 ? content.substring(0, 20) + '...' : content;
      
      // 创建视频记录
      var video = {
        id: 'video_' + Date.now(),
        type: 'script',
        title: '文案朗读 - ' + titlePreview,
        status: 'processing',
        duration: '--:--',
        createDate: new Date().toISOString(),
        digitalHumanId: selectedDhIdForScript,
        scriptContent: content  // 保存文案内容供播放时使用
      };
      
      // 添加到视频列表
      addGeneratedVideo(video);
      
      // 模拟3秒后完成处理
      setTimeout(function() {
        var videos = getGeneratedVideos();
        var idx = videos.findIndex(function(v) { return v.id === video.id; });
        if (idx !== -1) {
          videos[idx].status = 'ready';
          videos[idx].duration = '00:' + (30 + Math.floor(Math.random() * 90)).toString().padStart(2, '0');
          saveGeneratedVideos(videos);
        }
      }, 3000);
      
      alert('🎬 视频生成任务已提交！\n\n系统正在生成数字人朗读视频，预计需要 2-4 分钟。\n完成后将在"生成视频"页面中显示。');
      
      window.location.href = 'page.html?page=digital-human-video';
    }
    
    // 渲染生成视频页面
    // 获取生成的视频列表
    function getGeneratedVideos() {
      return JSON.parse(localStorage.getItem('generatedVideos') || '[]');
    }
    
    // 保存生成的视频列表
    function saveGeneratedVideos(videos) {
      localStorage.setItem('generatedVideos', JSON.stringify(videos));
    }
    
    // 添加生成的视频
    function addGeneratedVideo(video) {
      const videos = getGeneratedVideos();
      videos.unshift(video);
      saveGeneratedVideos(videos);
    }
    
    function renderDigitalHumanVideo(config) {
      // 首先检查并更新超时的任务
      checkAndUpdateTimeoutDigitalHumans();
      
      // 从 localStorage 读取视频
      const videos = getGeneratedVideos();
      
      // 渲染视频卡片
      function renderVideoCards(videoList) {
        if (videoList.length === 0) {
          return '';
        }
        return videoList.map(function(v) {
          var typeLabel = v.type === 'product' ? '🛒 商品讲解' : v.type === 'script' ? '📖 文案朗读' : '👤 数字人';
          var statusHtml = '';
          var actionsHtml = '';
          var cardClass = '';
          
          if (v.status === 'processing') {
            // 计算等待时间
            var createTime = new Date(v.createDate).getTime();
            var elapsedSeconds = Math.floor((Date.now() - createTime) / 1000);
            var timeInfo = elapsedSeconds < 60 ? elapsedSeconds + '秒' : Math.floor(elapsedSeconds / 60) + '分钟';
            statusHtml = '<div class="dh-video-processing">⏳ 处理中（' + timeInfo + '）</div>';
            actionsHtml = '<button class="dh-action-btn" onclick="location.reload()">刷新状态</button>';
          } else if (v.status === 'failed') {
            statusHtml = '<div class="dh-video-failed">❌ ' + (v.error || '生成失败') + '</div>';
            cardClass = ' failed';
            actionsHtml = '<button class="dh-action-btn primary" onclick="retryGeneratedVideo(\'' + v.id + '\')">重试</button>';
          } else if (v.status === 'ready') {
            actionsHtml = '<button class="dh-action-btn" onclick="playVideo(\'' + v.id + '\')">播放</button>' +
              '<button class="dh-action-btn" onclick="downloadVideo(\'' + v.id + '\')">下载</button>';
          }
          
          return '<div class="dh-video-card' + cardClass + '" data-type="' + v.type + '">' +
            '<div class="dh-video-thumbnail">' +
              '<div class="dh-video-play">▶</div>' +
              '<div class="dh-video-duration">' + (v.duration || '--:--') + '</div>' +
              statusHtml +
            '</div>' +
            '<div class="dh-video-info">' +
              '<div class="dh-video-title">' + v.title + '</div>' +
              '<div class="dh-video-meta">' +
                '<span class="dh-video-type">' + typeLabel + '</span>' +
                '<span>' + formatDate(v.createDate) + '</span>' +
              '</div>' +
            '</div>' +
            '<div class="dh-video-actions">' +
              actionsHtml +
              '<button class="dh-action-btn danger" onclick="deleteGeneratedVideo(\'' + v.id + '\')">删除</button>' +
            '</div>' +
          '</div>';
        }).join('');
      }
      
      var emptyHtml = videos.length === 0 ? 
        '<div class="empty-state">' +
          '<div class="empty-state-icon">🎬</div>' +
          '<div class="empty-state-title">暂无生成的视频</div>' +
          '<div class="empty-state-desc">去商品讲解或文案朗读页面生成视频吧</div>' +
          '<div style="display: flex; gap: 12px; justify-content: center; margin-top: 20px;">' +
            '<button class="dh-btn primary" onclick="window.location.href=\'page.html?page=digital-human-product\'">商品讲解</button>' +
            '<button class="dh-btn secondary" onclick="window.location.href=\'page.html?page=digital-human-script\'">文案朗读</button>' +
          '</div>' +
        '</div>' : '';
      
      document.getElementById('contentArea').innerHTML = 
        '<div class="page-header">' +
          '<div class="page-title">' +
            '<div class="page-title-icon ' + config.iconColor + '">' + config.icon + '</div>' +
            config.title +
          '</div>' +
          '<div class="page-desc">' + config.desc + '</div>' +
        '</div>' +
        
        '<div class="dh-video-tabs">' +
          '<button class="dh-video-tab active" onclick="filterVideos(\'all\', this)">全部 (' + videos.length + ')</button>' +
          '<button class="dh-video-tab" onclick="filterVideos(\'product\', this)">商品讲解</button>' +
          '<button class="dh-video-tab" onclick="filterVideos(\'script\', this)">文案朗读</button>' +
          '<button class="dh-video-tab" onclick="filterVideos(\'digital-human\', this)">数字人</button>' +
        '</div>' +
        
        '<div class="dh-video-grid" id="videoGrid">' +
          renderVideoCards(videos) +
        '</div>' +
        
        emptyHtml;
    }
    
    // 删除生成的视频
    function deleteGeneratedVideo(videoId) {
      var videos = getGeneratedVideos();
      var video = videos.find(function(v) { return v.id === videoId; });
      
      if (!video) return;
      
      // 如果是数字人生成视频，询问是否同时删除数字人
      if (video.type === 'digital-human' && video.digitalHumanId) {
        var deleteHuman = confirm('确定要删除这个视频吗？\n\n这是数字人生成记录，是否同时删除对应的数字人？\n\n点击"确定"同时删除数字人\n点击"取消"仅删除视频记录');
        
        if (deleteHuman) {
          // 删除数字人
          var humans = getDigitalHumans();
          humans = humans.filter(function(h) { return h.id !== video.digitalHumanId; });
          saveDigitalHumans(humans);
        }
      } else {
        if (!confirm('确定要删除这个视频吗？')) {
          return;
        }
      }
      
      // 删除视频
      videos = videos.filter(function(v) { return v.id !== videoId; });
      saveGeneratedVideos(videos);
      renderDigitalHumanVideo(pageConfig['digital-human-video']);
    }
    
    // 旧的删除函数保持兼容
    function deleteVideo(id) {
      deleteGeneratedVideo(id);
    }
    
    
    function filterVideos(type, btn) {
      document.querySelectorAll('.dh-video-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      
      document.querySelectorAll('.dh-video-card').forEach(card => {
        if (type === 'all' || card.dataset.type === type) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    }
    
    function playVideo(id) {
      var videos = getGeneratedVideos();
      var video = videos.find(function(v) { return v.id === id; });
      
      if (!video) {
        alert('视频不存在');
        return;
      }
      
      // 获取关联的数字人信息
      var digitalHuman = null;
      if (video.digitalHumanId) {
        var humans = getDigitalHumans();
        digitalHuman = humans.find(function(h) { return h.id === video.digitalHumanId; });
      }
      
      var typeLabel = video.type === 'product' ? '🛒 商品讲解' : video.type === 'script' ? '📖 文案朗读' : '👤 数字人';
      var dhName = digitalHuman ? digitalHuman.name : '未知数字人';
      
      // 创建视频播放器弹窗
      var modal = document.createElement('div');
      modal.id = 'videoPlayerModal';
      modal.innerHTML = `
        <div class="video-player-overlay" onclick="closeVideoPlayer()">
          <div class="video-player-container" onclick="event.stopPropagation()">
            <div class="video-player-header">
              <div class="video-player-title">${video.title}</div>
              <button class="video-player-close" onclick="closeVideoPlayer()">×</button>
            </div>
            
            <div class="video-player-content">
              <div class="video-player-screen" id="videoScreen">
                <!-- 视频演示区域 -->
                <div class="video-demo-wrapper">
                  <div class="video-demo-avatar">
                    <div class="avatar-circle">
                      ${digitalHuman && digitalHuman.aiGenerated ? '🤖' : '👤'}
                    </div>
                    <div class="sound-waves">
                      <div class="sound-wave"></div>
                      <div class="sound-wave"></div>
                      <div class="sound-wave"></div>
                      <div class="sound-wave"></div>
                      <div class="sound-wave"></div>
                    </div>
                    <div class="avatar-name">${dhName}</div>
                  </div>
                  <div class="video-demo-content">
                    <div class="demo-text" id="demoText">
                      ${getDemoScript(video, digitalHuman)}
                    </div>
                  </div>
                </div>
                
                <!-- 播放状态覆盖层 -->
                <div class="video-play-overlay" id="playOverlay" onclick="toggleVideoPlay()">
                  <div class="play-button" id="playButton">▶</div>
                </div>
              </div>
              
              <!-- 播放器控制条 -->
              <div class="video-player-controls">
                <button class="control-btn" id="playPauseBtn" onclick="toggleVideoPlay()">▶</button>
                <div class="progress-container">
                  <div class="progress-bar" id="progressBar">
                    <div class="progress-filled" id="progressFilled" style="width: 0%"></div>
                  </div>
                  <div class="time-display">
                    <span id="currentTime">00:00</span> / <span id="totalTime">${video.duration || '00:30'}</span>
                  </div>
                </div>
                <div class="volume-container">
                  <button class="control-btn volume-btn" onclick="toggleMute()">🔊</button>
                  <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="80">
                </div>
                <button class="control-btn fullscreen-btn" onclick="toggleFullscreen()">⛶</button>
              </div>
            </div>
            
            <div class="video-player-info">
              <div class="video-info-row">
                <span class="video-info-label">类型:</span>
                <span class="video-info-value">${typeLabel}</span>
              </div>
              <div class="video-info-row">
                <span class="video-info-label">时长:</span>
                <span class="video-info-value">${video.duration || '--:--'}</span>
              </div>
              <div class="video-info-row">
                <span class="video-info-label">数字人:</span>
                <span class="video-info-value">${dhName}</span>
              </div>
              <div class="video-info-row">
                <span class="video-info-label">创建时间:</span>
                <span class="video-info-value">${formatDate(video.createDate)}</span>
              </div>
              ${video.productName ? `<div class="video-info-row"><span class="video-info-label">商品:</span><span class="video-info-value">${video.productName}</span></div>` : ''}
            </div>
            
            <div class="video-player-actions">
              <button class="dh-btn" onclick="closeVideoPlayer()">关闭</button>
              <button class="dh-btn primary" onclick="downloadVideo('${id}')">📥 下载视频</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // 初始化播放器
      initVideoPlayer(video);
    }
    
    // 获取演示文稿
    function getDemoScript(video, digitalHuman) {
      if (video.scriptContent) {
        return video.scriptContent;
      }
      
      var greeting = digitalHuman && digitalHuman.persona ? digitalHuman.persona.greeting : '你好！';
      
      if (video.type === 'product') {
        return `${greeting}\n\n今天给大家介绍一款非常棒的产品——${video.productName || '精选好物'}！\n\n这款产品拥有以下特点：\n• 品质优秀，值得信赖\n• 性价比超高\n• 深受用户喜爱\n\n感兴趣的朋友不要错过哦！`;
      } else if (video.type === 'script') {
        return video.scriptContent || `${greeting}\n\n感谢您的关注！\n\n今天我想和大家分享一些有趣的内容...\n\n希望对您有所帮助！`;
      } else {
        return `${greeting}\n\n我是您的AI数字人助手，很高兴为您服务！\n\n有任何问题都可以随时问我。`;
      }
    }
    
    // 播放器状态
    var videoPlayerState = {
      isPlaying: false,
      currentTime: 0,
      duration: 30,
      volume: 80,
      isMuted: false,
      animationId: null,
      textInterval: null,
      speechSynthesis: null,
      utterance: null,
      fullText: '',
      currentCharIndex: 0
    };
    
    // 初始化视频播放器
    function initVideoPlayer(video) {
      // 解析时长
      if (video.duration && video.duration !== '--:--') {
        var parts = video.duration.split(':');
        videoPlayerState.duration = parseInt(parts[0]) * 60 + parseInt(parts[1]);
      } else {
        videoPlayerState.duration = 30;
      }
      
      videoPlayerState.isPlaying = false;
      videoPlayerState.currentTime = 0;
      videoPlayerState.currentCharIndex = 0;
      
      // 获取要朗读的文本
      var demoText = document.getElementById('demoText');
      if (demoText) {
        videoPlayerState.fullText = demoText.textContent.trim();
      }
      
      // 检查浏览器是否支持语音合成
      if (!('speechSynthesis' in window)) {
        alert('您的浏览器不支持语音合成功能，将以静音模式播放。');
      }
      
      updateTimeDisplay();
      
      // 初始化音量滑块事件
      var volumeSlider = document.getElementById('volumeSlider');
      if (volumeSlider) {
        volumeSlider.addEventListener('input', function() {
          videoPlayerState.volume = parseInt(this.value);
          videoPlayerState.isMuted = this.value == 0;
          updateVolumeIcon();
        });
      }
    }
    
    // 切换播放/暂停
    function toggleVideoPlay() {
      if (videoPlayerState.isPlaying) {
        pausePlayback();
      } else {
        startPlayback();
      }
    }
    
    // 开始播放
    function startPlayback() {
      videoPlayerState.isPlaying = true;
      updatePlayButtons(true);
      
      // 开始语音合成
      startSpeech();
      
      // 开始进度更新
      startProgressUpdate();
    }
    
    // 暂停播放
    function pausePlayback() {
      videoPlayerState.isPlaying = false;
      updatePlayButtons(false);
      
      // 暂停语音
      if (window.speechSynthesis) {
        window.speechSynthesis.pause();
      }
      
      // 停止进度更新
      if (videoPlayerState.animationId) {
        cancelAnimationFrame(videoPlayerState.animationId);
      }
    }
    
    // 停止播放
    function stopPlayback() {
      videoPlayerState.isPlaying = false;
      updatePlayButtons(false);
      
      // 停止语音
      if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
      }
      
      // 停止进度更新
      if (videoPlayerState.animationId) {
        cancelAnimationFrame(videoPlayerState.animationId);
      }
      if (videoPlayerState.textInterval) {
        clearInterval(videoPlayerState.textInterval);
      }
      
      videoPlayerState.currentTime = 0;
      videoPlayerState.currentCharIndex = 0;
    }
    
    // 更新播放按钮状态
    function updatePlayButtons(isPlaying) {
      var playPauseBtn = document.getElementById('playPauseBtn');
      var playButton = document.getElementById('playButton');
      var playOverlay = document.getElementById('playOverlay');
      
      if (isPlaying) {
        if (playPauseBtn) playPauseBtn.textContent = '⏸';
        if (playButton) playButton.textContent = '⏸';
        if (playOverlay) playOverlay.classList.add('playing');
      } else {
        if (playPauseBtn) playPauseBtn.textContent = '▶';
        if (playButton) playButton.textContent = '▶';
        if (playOverlay) playOverlay.classList.remove('playing');
      }
    }
    
    // 开始语音合成
    function startSpeech() {
      if (!('speechSynthesis' in window)) return;
      
      // 如果有正在播放的，先取消
      window.speechSynthesis.cancel();
      
      // 获取剩余要朗读的文本
      var textToSpeak = videoPlayerState.fullText.substring(videoPlayerState.currentCharIndex);
      if (!textToSpeak) {
        onSpeechEnd();
        return;
      }
      
      var utterance = new SpeechSynthesisUtterance(textToSpeak);
      videoPlayerState.utterance = utterance;
      
      // 设置语音参数
      utterance.lang = 'zh-CN';  // 中文
      utterance.rate = 1.0;      // 语速
      utterance.pitch = 1.0;     // 音调
      utterance.volume = videoPlayerState.isMuted ? 0 : videoPlayerState.volume / 100;
      
      // 尝试选择中文语音
      var voices = window.speechSynthesis.getVoices();
      var chineseVoice = voices.find(function(v) { 
        return v.lang.includes('zh') || v.lang.includes('CN'); 
      });
      if (chineseVoice) {
        utterance.voice = chineseVoice;
      }
      
      // 语音边界事件 - 用于同步文字高亮
      utterance.onboundary = function(event) {
        if (event.name === 'word' || event.name === 'sentence') {
          videoPlayerState.currentCharIndex = event.charIndex;
          highlightCurrentText();
        }
      };
      
      // 语音结束事件
      utterance.onend = function() {
        onSpeechEnd();
      };
      
      // 语音错误事件
      utterance.onerror = function(event) {
        console.error('语音合成错误:', event.error);
        if (event.error !== 'interrupted') {
          onSpeechEnd();
        }
      };
      
      // 开始朗读
      window.speechSynthesis.speak(utterance);
      
      // 开始文字高亮动画
      startTextHighlight();
    }
    
    // 语音结束处理
    function onSpeechEnd() {
      videoPlayerState.isPlaying = false;
      videoPlayerState.currentTime = videoPlayerState.duration;
      videoPlayerState.currentCharIndex = 0;
      updatePlayButtons(false);
      updateTimeDisplay();
      
      // 重置文字显示
      var demoText = document.getElementById('demoText');
      if (demoText) {
        demoText.innerHTML = videoPlayerState.fullText;
      }
    }
    
    // 开始进度更新
    function startProgressUpdate() {
      var startTime = Date.now() - (videoPlayerState.currentTime * 1000);
      
      function update() {
        if (!videoPlayerState.isPlaying) return;
        
        var elapsed = (Date.now() - startTime) / 1000;
        videoPlayerState.currentTime = Math.min(elapsed, videoPlayerState.duration);
        
        updateTimeDisplay();
        
        if (videoPlayerState.currentTime < videoPlayerState.duration) {
          videoPlayerState.animationId = requestAnimationFrame(update);
        }
      }
      
      videoPlayerState.animationId = requestAnimationFrame(update);
    }
    
    // 开始文字高亮
    function startTextHighlight() {
      var demoText = document.getElementById('demoText');
      if (!demoText) return;
      
      // 定期更新高亮位置
      videoPlayerState.textInterval = setInterval(function() {
        if (!videoPlayerState.isPlaying) return;
        highlightCurrentText();
      }, 100);
    }
    
    // 高亮当前朗读的文字
    function highlightCurrentText() {
      var demoText = document.getElementById('demoText');
      if (!demoText) return;
      
      var fullText = videoPlayerState.fullText;
      var charIndex = videoPlayerState.currentCharIndex;
      
      // 估算当前位置（基于时间）
      if (charIndex === 0 && videoPlayerState.currentTime > 0) {
        var progress = videoPlayerState.currentTime / videoPlayerState.duration;
        charIndex = Math.floor(progress * fullText.length);
      }
      
      // 创建高亮HTML
      var spokenText = fullText.substring(0, charIndex);
      var currentWord = fullText.substring(charIndex, charIndex + 5);
      var remainingText = fullText.substring(charIndex + 5);
      
      demoText.innerHTML = 
        '<span style="color: rgba(255,255,255,0.5);">' + escapeHtml(spokenText) + '</span>' +
        '<span style="color: #fff; background: rgba(24,144,255,0.3); padding: 2px 4px; border-radius: 4px;">' + escapeHtml(currentWord) + '</span>' +
        '<span style="color: #fff;">' + escapeHtml(remainingText) + '</span>';
    }
    
    // HTML转义
    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // 更新时间显示
    function updateTimeDisplay() {
      var currentTimeEl = document.getElementById('currentTime');
      var progressFilled = document.getElementById('progressFilled');
      var totalTimeEl = document.getElementById('totalTime');
      
      if (currentTimeEl) {
        var mins = Math.floor(videoPlayerState.currentTime / 60);
        var secs = Math.floor(videoPlayerState.currentTime % 60);
        currentTimeEl.textContent = String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
      }
      
      if (progressFilled) {
        var progress = (videoPlayerState.currentTime / videoPlayerState.duration) * 100;
        progressFilled.style.width = Math.min(progress, 100) + '%';
      }
    }
    
    // 更新音量图标
    function updateVolumeIcon() {
      var volumeBtn = document.querySelector('.volume-btn');
      if (volumeBtn) {
        volumeBtn.textContent = videoPlayerState.isMuted || videoPlayerState.volume === 0 ? '🔇' : '🔊';
      }
      
      // 更新语音音量
      if (videoPlayerState.utterance) {
        videoPlayerState.utterance.volume = videoPlayerState.isMuted ? 0 : videoPlayerState.volume / 100;
      }
    }
    
    // 切换静音
    function toggleMute() {
      videoPlayerState.isMuted = !videoPlayerState.isMuted;
      var volumeSlider = document.getElementById('volumeSlider');
      
      if (videoPlayerState.isMuted) {
        volumeSlider.value = 0;
      } else {
        volumeSlider.value = videoPlayerState.volume;
      }
      
      updateVolumeIcon();
      
      // 如果正在播放，需要重新开始语音以应用新音量
      if (videoPlayerState.isPlaying && window.speechSynthesis) {
        window.speechSynthesis.cancel();
        startSpeech();
      }
    }
    
    // 切换全屏
    function toggleFullscreen() {
      var container = document.querySelector('.video-player-container');
      if (!container) return;
      
      if (document.fullscreenElement) {
        document.exitFullscreen();
      } else {
        container.requestFullscreen();
      }
    }
    
    // 关闭视频播放器
    function closeVideoPlayer() {
      stopPlayback();
      var modal = document.getElementById('videoPlayerModal');
      if (modal) modal.remove();
    }
    
    // 确保语音列表加载完成
    if ('speechSynthesis' in window) {
      window.speechSynthesis.onvoiceschanged = function() {
        // 语音列表已加载
      };
    }

    function downloadVideo(id) {
      var videos = getGeneratedVideos();
      var video = videos.find(function(v) { return v.id === id; });
      
      if (!video) {
        alert('视频不存在');
        return;
      }
      
      // 模拟下载
      alert('📥 开始下载视频\n\n文件名: ' + video.title + '.mp4\n时长: ' + (video.duration || '--:--') + '\n\n提示: 这是演示功能，实际下载需要后端支持');
    }
    
    // 重试生成视频
    function retryGeneratedVideo(videoId) {
      var videos = getGeneratedVideos();
      var video = videos.find(function(v) { return v.id === videoId; });
      
      if (!video) {
        alert('视频不存在');
        return;
      }
      
      // 更新状态为处理中
      video.status = 'processing';
      video.error = null;
      saveGeneratedVideos(videos);
      
      // 如果是数字人视频，同时更新数字人状态
      if (video.digitalHumanId) {
        var humans = getDigitalHumans();
        var humanIdx = humans.findIndex(function(h) { return h.id === video.digitalHumanId; });
        if (humanIdx !== -1) {
          humans[humanIdx].status = 'processing';
          humans[humanIdx].error = null;
          saveDigitalHumans(humans);
        }
      }
      
      alert('🔄 重试任务已提交！');
      
      // 模拟重新处理
      setTimeout(function() {
        var updatedVideos = getGeneratedVideos();
        var idx = updatedVideos.findIndex(function(v) { return v.id === videoId; });
        
        if (idx !== -1) {
          updatedVideos[idx].status = 'ready';
          updatedVideos[idx].duration = '00:' + (15 + Math.floor(Math.random() * 60)).toString().padStart(2, '0');
          saveGeneratedVideos(updatedVideos);
        }
        
        // 如果是数字人视频，同时更新数字人状态
        if (video.digitalHumanId) {
          var humans = getDigitalHumans();
          var humanIdx = humans.findIndex(function(h) { return h.id === video.digitalHumanId; });
          if (humanIdx !== -1) {
            humans[humanIdx].status = 'ready';
            saveDigitalHumans(humans);
          }
        }
        
        // 刷新页面
        renderDigitalHumanVideo(pageConfig['digital-human-video']);
      }, 3000);
      
      renderDigitalHumanVideo(pageConfig['digital-human-video']);
    }
    
    function deleteVideo(id) {
      if (confirm('确定要删除这个视频吗？')) {
        alert('✅ 视频已删除');
      }
    }
  </script>
</body>
</html>
