<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>余额充值 - 畅联支付</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root { --primary: #1890ff; --success: #52c41a; --danger: #ff4d4f; --text: #262626; --text-secondary: #8c8c8c; --border: #e8e8e8; --card: #fff; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans SC", sans-serif; min-height: 100vh; background: #f0f2f5; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .card { background: var(--card); border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); max-width: 420px; width: 100%; padding: 28px; }
    h1 { font-size: 1.25rem; margin-bottom: 8px; color: var(--text); }
    .balance { font-size: 1.5rem; color: var(--primary); margin-bottom: 24px; }
    .balance span { font-weight: 600; }
    .msg { padding: 10px 12px; border-radius: 8px; margin-bottom: 16px; font-size: 0.9rem; }
    .msg.success { background: #f6ffed; color: #389e0d; border: 1px solid #b7eb8f; }
    .msg.error { background: #fff2f0; color: #cf1322; border: 1px solid #ffccc7; }
    label { display: block; font-weight: 500; margin-bottom: 6px; color: var(--text); font-size: 0.9rem; }
    input, select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; margin-bottom: 16px; }
    button { width: 100%; padding: 12px; background: var(--primary); color: #fff; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; }
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .back { display: inline-block; margin-top: 16px; color: var(--primary); text-decoration: none; font-size: 0.9rem; }
    .back:hover { text-decoration: underline; }
    .hint { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.5; }
    .hint code { background: rgba(0,0,0,0.06); padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
  </style>
</head>
<body>
  <div class="card">
    <h1>余额充值</h1>
    <div class="balance">当前余额：<span id="balance">--</span> ⚡</div>
    <div id="msg"></div>
    <p class="hint">若提示「支付未配置」，请在服务端配置 <code>PAYUNK_APPID</code>、<code>PAYUNK_KEY</code>、<code>PAYUNK_PAY_TYPE</code>、<code>DEPLOY_URL</code>。</p>
    <form id="form">
      <label>充值金额（元）</label>
      <input type="number" id="amount" name="amount" min="0.01" step="0.01" placeholder="10.00" required>
      <button type="submit" id="btn">去支付</button>
    </form>
    <a href="dashboard.html" class="back">← 返回控制台</a>
  </div>
  <script>
    (function () {
      var token = (typeof sessionStorage !== 'undefined' && sessionStorage.getItem('token')) || '';
      if (!token) {
        window.location.href = '/';
        return;
      }
      var params = new URLSearchParams(window.location.search);
      var isSuccess = params.get('success') === '1';
      var isError = params.get('error') === '1';
      var outTradeNo = params.get('out_trade_no');
      if (isError) {
        document.getElementById('msg').innerHTML = '<div class="msg error">支付失败或已取消</div>';
      }

      function updateBalance(d) {
        var el = document.getElementById('balance');
        var balance = (d && d.balance != null) ? (Number(d.balance)).toFixed(2) : '0.00';
        el.textContent = balance;
        if (isSuccess) {
          document.getElementById('msg').innerHTML = '<div class="msg success">充值成功，当前余额已更新为 <strong>' + balance + ' ⚡</strong></div>';
          document.getElementById('msg').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }

      if (isSuccess && outTradeNo) {
        fetch('/api/payunk/confirm?out_trade_no=' + encodeURIComponent(outTradeNo), { headers: { 'Authorization': 'Bearer ' + token } })
          .then(function (r) { return r.json(); })
          .then(function (d) {
            if (d && d.success && d.balance != null) {
              updateBalance(d);
            } else {
              fetch('/api/wallet', { headers: { 'Authorization': 'Bearer ' + token } }).then(function (r) { return r.json(); }).then(updateBalance);
            }
          })
          .catch(function () {
            fetch('/api/wallet', { headers: { 'Authorization': 'Bearer ' + token } }).then(function (r) { return r.json(); }).then(updateBalance);
          });
      } else {
        fetch('/api/wallet', { headers: { 'Authorization': 'Bearer ' + token } })
          .then(function (r) { return r.json(); })
          .then(updateBalance)
          .catch(function () {
            document.getElementById('balance').textContent = '0.00';
            if (isSuccess) document.getElementById('msg').innerHTML = '<div class="msg success">充值成功，余额已更新（若未显示最新余额请刷新页面）</div>';
          });
      }

      document.getElementById('form').addEventListener('submit', function (e) {
        e.preventDefault();
        var amount = parseFloat(document.getElementById('amount').value);
        if (isNaN(amount) || amount <= 0) {
          alert('请输入有效金额');
          return;
        }
        var btn = document.getElementById('btn');
        btn.disabled = true;
        btn.textContent = '创建订单中...';
        fetch('/api/payunk/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ amount: amount.toFixed(2) })
        })
          .then(function (r) {
            if (!r.ok && r.status === 503) {
              return r.json().then(function (d) {
                throw new Error(d && d.message ? d.message : '支付服务未配置，请联系管理员');
              });
            }
            return r.json();
          })
          .then(function (d) {
            if (d && d.success && d.url) {
              window.location.href = d.url;
            } else {
              alert(d && d.message ? d.message : '创建订单失败');
              btn.disabled = false;
              btn.textContent = '去支付';
            }
          })
          .catch(function (err) {
            alert('请求失败: ' + (err && err.message ? err.message : ''));
            btn.disabled = false;
            btn.textContent = '去支付';
          });
      });
    })();
  </script>
</body>
</html>
